/*
 * MikroChat version 2.0.0
 * Bundle generated on 2026-02-19T14:33:12.979Z
 */
"use strict";(()=>{var _o=Object.defineProperty;var w=(e,t)=>()=>(e&&(t=e(e=0)),t);var S=(e,t)=>{for(var n in t)_o(e,n,{get:t[n],enumerable:!0})};var te,ua=w(()=>{"use strict";te=class extends Map{constructor(t){super(),this.maxSize=t}get(t){if(!super.has(t))return;let n=super.get(t);return super.delete(t),super.set(t,n),n}set(t,n){if(super.has(t)&&super.delete(t),super.set(t,n),super.size>this.maxSize){let a=super.keys().next().value;super.delete(a)}return this}}});var r,E=w(()=>{"use strict";ua();r={currentChannelForEdit:null,currentUser:null,currentChannelId:null,messageEventSource:null,currentMessageForReaction:null,currentMessageForReactionIsDM:!1,currentMessageForEdit:null,currentMessageForEditIsDM:!1,currentMessageForEditContent:"",currentMessageForEditImages:[],isStorageInitialized:!1,pendingUploads:[],tempIdMap:new Map,messageCache:new te(2e3),unreadCounts:new Map,storage:null,currentConversationId:null,conversationCache:new te(200),dmMessageCache:new te(2e3),dmUnreadCounts:new Map,viewMode:"channel",currentThreadId:null,threadMessageCache:new te(500),threadPanelOpen:!1,currentMessageForEditIsThread:!1,isOffline:typeof navigator<"u"?!navigator.onLine:!1}});var it,Jt,ct,Xt,ma,Zt,Qt,he,ne,pa,ga,fa,ha,ya,wa,en,tn,V,va,nn,ae,oe,an,on,ye,$,Ea,De,D,re,Ia,H,xa,rn,T,Ca,Ma,z,p,_r,R,sn,dt,we,lt,cn,ut,P,mt,Re,Pe,Ne,dn,ln,pt,un,ka,gt,ft,Sa,mn,ve,pn,La,ht,Ee,yt,Ie,xe,ba,Fe,Ta,Oe,Ba,se,wt,Ua,Aa,$a,ie,_e,Da,Ra,Pa,qr,k=w(()=>{"use strict";it=document.getElementById("add-email-input"),Jt=document.getElementById("add-user-password-group"),ct=document.getElementById("add-user-password-input"),Xt=document.getElementById("add-user-btn"),ma=document.getElementById("add-channel-btn"),Zt=document.getElementById("app-container"),Qt=document.getElementById("auth-container"),he=document.getElementById("channel-name"),ne=document.getElementById("channels-list"),pa=document.getElementById("close-channel-modal"),ga=document.getElementById("close-edit-channel-modal"),fa=document.getElementById("close-edit-modal"),ha=document.getElementById("close-reaction-modal"),ya=document.getElementById("close-image-preview"),wa=document.getElementById("close-server-settings-modal"),en=document.getElementById("create-channel-modal"),tn=document.getElementById("create-channel-submit"),V=document.getElementById("current-channel-name"),va=document.getElementById("delete-channel-btn"),nn=document.getElementById("edit-channel-modal"),ae=document.getElementById("edit-channel-name"),oe=document.getElementById("edit-message-input"),an=document.getElementById("edit-message-modal"),on=document.getElementById("edit-message-submit"),ye=document.getElementById("auth-form-email"),$=document.getElementById("auth-email"),Ea=document.getElementById("reaction-picker"),De=document.getElementById("reaction-picker-modal"),D=document.getElementById("auth-form-encryption"),re=document.getElementById("encryption-password"),Ia=document.getElementById("exit-server-btn"),H=document.getElementById("image-preview-modal"),xa=document.getElementById("image-upload"),rn=document.getElementById("loading"),T=document.getElementById("login-btn"),Ca=document.getElementById("logout-btn"),Ma=document.getElementById("menu-toggle"),z=document.getElementById("message-input"),p=document.getElementById("messages-area"),_r=document.getElementById("password"),R=document.getElementById("preview-image"),sn=document.getElementById("send-button"),dt=document.getElementById("server-name"),we=document.getElementById("server-name-input"),lt=document.querySelector(".server-name-text"),cn=document.getElementById("server-settings-modal"),ut=document.getElementById("sidebar"),P=document.getElementById("auth-form-text"),mt=document.getElementById("theme-switch"),Re=mt?.querySelector(".theme-switch-icon"),Pe=mt?.querySelector(".theme-switch-label"),Ne=document.getElementById("toast"),dn=document.getElementById("update-channel-submit"),ln=document.getElementById("update-server-name-btn"),pt=document.getElementById("user-avatar"),un=document.getElementById("user-dropdown"),ka=document.getElementById("user-menu"),gt=document.getElementById("users-list"),ft=document.getElementById("user-name"),Sa=document.getElementById("user-settings-btn"),mn=document.getElementById("user-settings-modal"),ve=document.getElementById("user-settings-name"),pn=document.getElementById("user-settings-save-btn"),La=document.getElementById("close-user-settings-btn"),ht=document.getElementById("auth-password"),Ee=document.getElementById("auth-form-password-confirm"),yt=document.getElementById("auth-password-confirm"),Ie=document.getElementById("auth-form-password"),xe=document.getElementById("auth-toggle"),ba=document.getElementById("auth-toggle-link"),Fe=document.getElementById("dm-list"),Ta=document.getElementById("start-dm-btn"),Oe=document.getElementById("start-dm-modal"),Ba=document.getElementById("close-start-dm-modal"),se=document.getElementById("dm-user-list"),wt=document.getElementById("auth-forgot-password"),Ua=document.getElementById("auth-forgot-password-link"),Aa=document.getElementById("password-reset-sent-form"),$a=document.getElementById("password-reset-sent-message"),ie=document.getElementById("oauth-providers"),_e=document.getElementById("auth-divider"),Da=document.getElementById("add-webhook-btn"),Ra=document.getElementById("webhook-name-input"),Pa=document.getElementById("webhook-channel-select"),qr=document.getElementById("webhooks-list")});var Y,L,x,N,j,Ce,qe,gn,vt,B=w(()=>{"use strict";Y=window.MIKROCHAT_CONFIG||{},L=Y.DEBUG_MODE??!1,x=Y.AUTH_MODE??"password",N=Y.API_BASE_URL??"http://localhost:3000",j=Y.DEFAULT_PASSWORD??"",Ce=Y.ENABLE_USER_SPECIFIC_ENCRYPTION??!1,qe=Y.HAS_EMAIL??!1,gn=Y.ENABLE_OAUTH??!1,vt=Y.MAX_CONTENT_LENGTH??1e3;L&&(console.table([{flag:"AUTH_MODE",setting:x},{flag:"API_BASE_URL",setting:N},{flag:"DEFAULT_PASSWORD",setting:j},{flag:"ENABLE_USER_SPECIFIC_ENCRYPTION",setting:Ce},{flag:"HAS_EMAIL",setting:qe},{flag:"ENABLE_OAUTH",setting:gn},{flag:"MAX_CONTENT_LENGTH",setting:vt}]),console.log(`Has ${window.localStorage.length} items in localStorage`))});var Na={};S(Na,{findMessageWithId:()=>Me,formatDate:()=>Et,formatTime:()=>ke,getInitials:()=>M,getReactionsContainer:()=>It,hasUserReactedWithEmoji:()=>ze,isValidEmail:()=>fn,parseMarkdown:()=>He,sanitizeInput:()=>hn});function M(e){return e?e.split(" ").map(t=>t.charAt(0)).join("").toUpperCase():"?"}function Et(e){return(e instanceof Date?e:new Date(e)).toLocaleDateString()}function ke(e){return(e instanceof Date?e:new Date(e)).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}function fn(e){if(!e||typeof e!="string"||(e=e.trim(),e==="")||e.includes(" ")||e.includes(".."))return!1;let t=e.indexOf("@");if(t===-1)return!1;let n=e.slice(0,t),a=e.slice(t+1);if(n.length===0||a.length===0||!/^[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+$/.test(n))return!1;let s=a.split(".");if(s.length<2)return!1;let c=s[s.length-1];if(c.length<2||!/^[a-zA-Z]+$/.test(c))return!1;for(let i of s)if(i.length===0||!/^[a-zA-Z0-9](?:[a-zA-Z0-9-]*[a-zA-Z0-9])?$/.test(i))return!1;return!0}function hn(e){return typeof e!="string"?"":e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}function He(e){if(!e)return"";let t=e;return t=t.replace(/```([\s\S]*?)```/g,function(n,a){return`<pre><code>${a.trim()}</code></pre>`}),t=t.replace(/(\*\*|__)(.*?)\1/g,"<strong>$2</strong>"),t=t.replace(/(\*|_)(?!\*|_)(.*?)\1/g,"<em>$2</em>"),t=t.replace(/(?:^|\n)((?:(?:- |\* ).*(?:\n|$))+)/gm,function(n,a){let o=a.split(/\n(?=(?:- |\* ))/),s="<ul>";for(let c of o)if(c.trim()){let i=c.replace(/^(?:- |\* )/,"").trim();s+=`<li>${i}</li>`}return s+="</ul>",s}),t=t.replace(/(?:^|\n)((?:(?:\d+\. ).*(?:\n|$))+)/gm,function(n,a){let o=a.split(/\n(?=(?:\d+\. ))/),s="<ol>";for(let c of o)if(c.trim()){let i=c.replace(/^\d+\. /,"").trim();s+=`<li>${i}</li>`}return s+="</ol>",s}),t}function Me(e){return Array.from(document.querySelectorAll(".message")).find(n=>n.dataset.id===e)}function ze(e,t){let n=It(e);return n?Array.from(n.querySelectorAll(".user-reacted")).map(o=>o.dataset.reaction).some(o=>o===t):!1}function It(e){let t=null;if(t=Me(e),!t){for(let[a,o]of r.tempIdMap.entries())if(o===e&&(t=Me(a),t))break}if(!t)return null;let n=t.querySelector(".message-reactions");return n||null}var U=w(()=>{"use strict";E()});async function ce(e){let t=e||j;L&&console.log("Initializing storage with password",t);try{if(!Ce)return L&&console.log("Setting up default encryption...",t),await Se(t,!0),!0;if(yn())try{return await Se(t,!1),await r.storage.getItem(je)==="true"}catch(a){return console.error("Failed to decrypt existing data with provided password:",a),!1}else return L&&console.log("Setting up custom encryption...",t),await Se(t,!0),await r.storage.setItem(je,"true"),!0}catch(n){return console.error("Failed to initialize storage:",n),!1}}async function Se(e,t=!0){let n=await new MikroSafe(e);r.storage=n,r.isStorageInitialized=!0,t&&await r.storage.setItem(je,"true")}function yn(){let e=Object.keys(localStorage),t=e.includes(je),n=e.includes("token")||e.includes("accessToken");return t&&n}async function Fa(e){try{return await ce(e)?await r.storage.getItem(je)==="true":!1}catch(t){return console.error("Error verifying encryption password:",t),!1}}var je,We=w(()=>{"use strict";E();B();je="_storage_initialized_"});function W(){let e=new URLSearchParams(window.location.search),t=e.get("email"),n=e.get("token"),a=e.get("reset")==="true"||window.location.pathname==="/reset";return{emailParam:t,tokenParam:n,resetParam:a}}var xt=w(()=>{"use strict"});function K(){let{emailParam:e,tokenParam:t}=W();return e&&t}async function Oa(){try{let{emailParam:e,tokenParam:t}=W();if(!e||!t)return!1;let n=await _a({email:e,token:t}),{accessToken:a,refreshToken:o}=n;return await r.storage.setItem("accessToken",a),await r.storage.setItem("refreshToken",o),!0}catch(e){return console.log("Magic link verification error:",e),!1}}var Ct=w(()=>{"use strict";E();xt();F()});async function Mt(e){e?(document.body.classList.remove("light-mode"),Re&&(Re.textContent="\u{1F319}"),Pe&&(Pe.textContent="Dark Mode")):(document.body.classList.add("light-mode"),Re&&(Re.textContent="\u2600\uFE0F"),Pe&&(Pe.textContent="Light Mode")),await r.storage.setItem("darkMode",e?"true":"false")}var wn=w(()=>{"use strict";E();k()});var Wa={};S(Wa,{convertBlobToBase64:()=>St,formatFileSize:()=>vn,generateFileHash:()=>za,generateThumbnail:()=>Ha,handleAddImages:()=>kt,hashSimple:()=>ja,openImagePreview:()=>En,removePendingUpload:()=>qo,resizeAndCompressImage:()=>qa});async function kt(e){for(let t of e){if(!t.type.match("image.*")){d("Only image files are supported","error");continue}try{let n=await za(t);if(r.pendingUploads.some(l=>l.fileHash===n)){d("This image is already in your pending uploads","info");continue}let o=await qa(t),s=await Ha(o.blob),c=Date.now(),i=t.name.split(".").pop().toLowerCase(),u=`${c}.${i}`;L&&(o.usedOriginal?d("Used original image (no compression needed)","info"):o.compressionRatio>0?d(`Image compressed by ${o.compressionRatio.toFixed(0)}%`,"info"):o.compressionRatio<=0&&d(`Image processed (size increased by ${Math.abs(o.compressionRatio).toFixed(0)}%)`,"info")),r.pendingUploads.push({fileName:u,fileHash:n,blob:o.blob,thumbnailBlob:s,preview:URL.createObjectURL(o.blob)}),Le()}catch(n){console.error("Error processing image:",n),d("Failed to process image","error")}}}function qo(e){URL.revokeObjectURL(r.pendingUploads[e].preview),r.pendingUploads.splice(e,1),Le()}function qa(e){return new Promise((t,n)=>{L&&console.log(`Original image: ${e.name}, Size: ${vn(e.size)}`);let a=new FileReader;a.onload=function(o){let s=new Image;s.onload=function(){let c=s.width,i=s.height,u=`${c}x${i}`,l=c,g=i,h=1200;l>g&&l>h?(g=Math.round(g*h/l),l=h):g>h&&(l=Math.round(l*h/g),g=h);let I=c!==l||i!==g,_=document.createElement("canvas");_.width=l,_.height=g,_.getContext("2d").drawImage(s,0,0,l,g);let q=.7,ge=e.type,rt=e.name.split(".").pop().toLowerCase();rt==="png"?(ge="image/png",q=.8):rt==="jpg"||rt==="jpeg"?(ge="image/jpeg",q=.7):rt==="webp"&&(ge="image/webp",q=.75),_.toBlob(fe=>{if(fe)if(fe.size>=e.size&&!I){L&&console.log("Processed image is larger than original. Using original file instead.");let st={blob:e,originalSize:e.size,newSize:e.size,compressionRatio:0,originalDimensions:u,newDimensions:u,usedOriginal:!0};t(st)}else{let st=((1-fe.size/e.size)*100).toFixed(2);L&&(console.log(`Processed image: ${l}x${g} (from ${u})`),console.log(`New size: ${vn(fe.size)}, Reduction: ${st}%`));let Oo={blob:fe,originalSize:e.size,newSize:fe.size,compressionRatio:Number.parseFloat(st),originalDimensions:u,newDimensions:`${l}x${g}`,usedOriginal:!1};t(Oo)}else n(new Error("Failed to create image blob"))},ge,q)},s.onerror=function(){n(new Error("Failed to load image"))},s.src=o.target.result},a.onerror=function(){n(new Error("Failed to read file"))},a.readAsDataURL(e)})}function Ha(e){return new Promise((t,n)=>{let a=URL.createObjectURL(e),o=new Image;o.onload=function(){URL.revokeObjectURL(a);let s=o.width,c=o.height,i=400;s>c&&s>i?(c=Math.round(c*i/s),s=i):c>i&&(s=Math.round(s*i/c),c=i);let u=document.createElement("canvas");u.width=s,u.height=c,u.getContext("2d").drawImage(o,0,0,s,c),u.toBlob(g=>{g?t(g):n(new Error("Failed to create thumbnail"))},"image/jpeg",.6)},o.onerror=()=>{URL.revokeObjectURL(a),n(new Error("Failed to load image for thumbnail"))},o.src=a})}function vn(e){return e<1024?`${e} bytes`:e<1048576?`${(e/1024).toFixed(2)} KB`:`${(e/1048576).toFixed(2)} MB`}function St(e){return new Promise((t,n)=>{let a=new FileReader;a.onloadend=()=>{let o=a.result.split(",")[1];t(o)},a.onerror=n,a.readAsDataURL(e)})}async function za(e){return new Promise(t=>{let n=new FileReader;n.onload=a=>{let o=a.target.result,s=ja(o);t(s)},n.readAsArrayBuffer(e)})}function ja(e){let t=new DataView(e),n=0,a=Math.max(1,Math.floor(e.byteLength/1e3));for(let o=0;o<e.byteLength;o+=a){let s=o+3<e.byteLength?t.getUint32(o):t.getUint8(o);n=(n<<5)-n+s,n|=0}return n.toString(16)}async function En(e){R.src="",H.classList.add("active"),R.style.display="none";let t=document.createElement("div");t.className="loading-spinner",H.querySelector(".image-preview-container").appendChild(t),await b().then(n=>{fetch(e,{method:"GET",headers:{Authorization:`Bearer ${n}`}}).then(a=>{if(!a.ok)throw new Error("Image fetch failed");return a.blob()}).then(a=>{let o=URL.createObjectURL(a);R.src=o,R.style.display="block";let s=H.querySelector(".loading-spinner");s&&s.remove(),R.setAttribute("data-object-url",o)}).catch(a=>{console.error("Error fetching preview image:",a),R.style.display="none",H.querySelector(".image-preview-container").innerHTML='<div class="image-error">Failed to load image</div>'})})}var Lt=w(()=>{"use strict";E();k();B();y();F()});var Ga={};S(Ga,{addReaction:()=>Bt,processReactions:()=>In,removeReaction:()=>xn,updateReactionInUI:()=>J});function In(e){let t={};if(!e)return t;for(let[n,a]of Object.entries(e)){if(!a)return;for(let o of a)t[o]||(t[o]=[]),t[o].push(n)}return t}async function Bt(e,t){let n=Be(e);if(!n){d("Invalid message ID","error");return}if(!ze(e,t))try{if(r.messageCache.has(e)){let a=r.messageCache.get(e);a.reactions||(a.reactions={}),a.reactions[t]?a.reactions[t].includes(r.currentUser.id)||a.reactions[t].push(r.currentUser.id):a.reactions[t]=[r.currentUser.id],r.messageCache.set(e,a)}await m(`/messages/${n}/reactions`,"POST",{reaction:t}),await J(e,t,!0,!1),De.classList.remove("active")}catch(a){await J(e,t,!1,!1),d(a.message||"Failed to add reaction","error")}}async function xn(e,t){let n=Be(e);if(!n){d("Invalid message ID","error");return}try{await m(`/messages/${n}/reactions`,"DELETE",{reaction:t}),await J(e,t,!1,!1)}catch(a){await J(e,t,!0,!1),d(a.message||"Failed to remove reaction","error")}}async function J(e,t,n,a=!1){let o=Ho(e);if(!o)return;let s=o.querySelector(`.reaction[data-reaction="${t}"]`),c=bt(s);if(a){n?s?be(s,c+1):await Te(e,t,1,!1):s&&(bt(s)-1>=1?be(s,c-1):s.remove());return}n?s?(be(s,c+1),Tt(s,n)):await Te(e,t,1,!0):s&&(c>1?(be(s,c-1),Tt(s,n)):s.remove())}function Ho(e){let t=null;if(t=Me(e),!t){for(let[a,o]of r.tempIdMap.entries())if(o===e&&(t=Me(a),t))break}if(!t)return;let n=t.querySelector(".message-reactions");if(n)return n}var Ge=w(()=>{"use strict";E();k();v();y();U();X()});var Qa={};S(Qa,{appendDMMessage:()=>Sn,deleteDMMessage:()=>kn,loadDMMessagesForConversation:()=>Ut,removeDMMessageFromView:()=>bn,renderDMMessage:()=>Za,renderDMMessages:()=>Ka,sendDMMessage:()=>Go,updateDMMessage:()=>$t,updateDMMessageInView:()=>Ln,uploadDMImage:()=>Vo});async function Ut(e,t){if(p)try{let n=`/conversations/${e}/messages?limit=${Va}`;t&&(n+=`&before=${t}`);let o=(await m(n)).messages||[];if(!t)r.dmMessageCache.set(e,o),Ka(o);else{let s=r.dmMessageCache.get(e)||[];r.dmMessageCache.set(e,[...o,...s]),zo(o)}o.length>=Va?jo(e,o[0].id):Mn()}catch(n){console.error("Failed to load DM messages:",n),t||(p.innerHTML='<div class="empty-state"><div class="empty-state-icon">!</div><h3>Failed to load messages</h3></div>')}}function zo(e){if(!p||e.length===0)return;Mn();let t=Ja(e),n=Object.keys(t).sort((a,o)=>{let s=t[a][0].createdAt,c=t[o][0].createdAt;return s-c});for(let a of n){let o=t[a];if(!Array.from(p.querySelectorAll(".message-date-divider")).find(c=>c.textContent===a)){let c=document.createElement("div");c.className="message-date-divider",c.textContent=a,p.appendChild(c)}for(let c of o){let i=At(c);p.appendChild(i)}}}function jo(e,t){Mn();let n=document.createElement("button");n.className="load-more-btn",n.id="load-more-dm-messages",n.textContent="Load older messages",n.addEventListener("click",async()=>{Cn||(Cn=!0,n.textContent="Loading...",await Ut(e,t),Cn=!1)}),p.appendChild(n)}function Mn(){let e=document.getElementById("load-more-dm-messages");e&&e.remove()}function At(e){let t=document.createElement("div");return t.innerHTML=Za(e),t.firstElementChild}function Ka(e){if(!p)return;if(e.length===0){p.innerHTML=`
      <div class="empty-state">
        <div class="empty-state-icon">@</div>
        <h3>Start the conversation</h3>
        <p>Send a message to start chatting</p>
      </div>
    `;return}p.innerHTML="";let t=Ja(e),n=Object.keys(t).sort((a,o)=>{let s=t[a][0].createdAt;return t[o][0].createdAt-s});for(let a of n){let o=document.createElement("div");o.className="message-date-divider",o.textContent=a,p.appendChild(o);let s=t[a];for(let c of s){let i=At(c);p.prepend(i)}}Dt()}function Ja(e){let t={};for(let n of e){let a=new Date(n.createdAt),o=Xa(a);t[o]||(t[o]=[]),t[o].push(n)}return t}function Xa(e){let t=new Date,n=new Date(t);return n.setDate(n.getDate()-1),e.toDateString()===t.toDateString()?"Today":e.toDateString()===n.toDateString()?"Yesterday":e.toLocaleDateString("en-US",{weekday:"long",month:"long",day:"numeric"})}function Za(e){let t=e.author.id===r.currentUser?.id,n=M(e.author.userName),a=Ke(e.createdAt),o=Ye(e.content),s="";if(e.images&&e.images.length>0){s='<div class="message-images-container">';for(let u of e.images)s+=`
        <div class="message-image-container">
          <div class="image-wrapper">
            ${t?`<span class="remove-image-btn" data-message-id="${e.id}" data-image="${u}">&times;</span>`:""}
            <img src="/conversations/${r.currentConversationId}/messages/image/${u}?size=thumb" alt="Image" class="message-image" loading="lazy" data-image="${u}">
          </div>
        </div>
      `;s+="</div>"}let c=Wo(e),i="";return t&&(i=`
      <div class="message-actions">
        <button class="message-edit" data-message-id="${e.id}" data-is-dm="true">Edit</button>
        <button class="message-delete" data-message-id="${e.id}" data-is-dm="true">Delete</button>
      </div>
    `),`
    <div class="message" data-id="${e.id}" data-is-dm="true">
      <div class="message-avatar">${n}</div>
      <div class="message-content">
        <div class="message-header">
          <span class="message-author">${e.author.userName}</span>
          <span class="message-time">${a}</span>
        </div>
        <div class="message-text">${o}</div>
        ${s}
        ${c}
        ${i}
      </div>
    </div>
  `}function Wo(e){if(!e.reactions||Object.keys(e.reactions).length===0)return`
      <div class="message-reactions">
        <div class="add-reaction" data-message-id="${e.id}">+</div>
      </div>
    `;let t={},n={};for(let[o,s]of Object.entries(e.reactions))for(let c of s)t[c]||(t[c]=0,n[c]=[]),t[c]++,n[c].push(o);let a='<div class="message-reactions">';for(let[o,s]of Object.entries(t)){let c=n[o].includes(r.currentUser?.id);a+=`
      <div class="reaction ${c?"user-reacted":""}"
           data-message-id="${e.id}"
           data-reaction="${o}">
        <span class="reaction-emoji">${o}</span>
        <span class="reaction-count">${s}</span>
      </div>
    `}return a+=`<div class="add-reaction" data-message-id="${e.id}">+</div>`,a+="</div>",a}async function Go(e,t=[]){if(r.currentConversationId)try{let n=await m(`/conversations/${r.currentConversationId}/messages`,"POST",{content:e,images:t});z&&(z.value="",z.style.height="auto"),r.pendingUploads=[];let a=document.getElementById("pending-uploads-container"),o=document.getElementById("pending-uploads");return a&&(a.style.display="none"),o&&(o.innerHTML=""),n.message}catch(n){throw console.error("Failed to send DM:",n),d(n.message||"Failed to send message","error"),n}}async function Vo(e){if(!r.currentConversationId)return null;try{let t=await Ya(e.blob),n={filename:e.name,image:t};return e.thumbnailBlob&&(n.thumbnail=await Ya(e.thumbnailBlob)),(await m(`/conversations/${r.currentConversationId}/messages/image`,"POST",n)).filename}catch(t){return console.error("Failed to upload DM image:",t),d("Failed to upload image","error"),null}}function Ya(e){return new Promise((t,n)=>{let a=new FileReader;a.onload=()=>{let o=a.result.split(",")[1];t(o)},a.onerror=n,a.readAsDataURL(e)})}async function kn(e){if(r.currentConversationId)try{await m(`/conversations/${r.currentConversationId}/messages/${e}`,"DELETE"),d("Message deleted","success")}catch(t){console.error("Failed to delete DM:",t),d(t.message||"Failed to delete message","error")}}async function $t(e,t,n){if(r.currentConversationId)try{let a=await m(`/conversations/${r.currentConversationId}/messages/${e}`,"PUT",{content:t,images:n});return d("Message updated","success"),a.message}catch(a){throw console.error("Failed to update DM:",a),d(a.message||"Failed to update message","error"),a}}function Sn(e){if(!p||r.viewMode!=="dm"||r.currentConversationId!==e.channelId||p.querySelector(`.message[data-id="${e.id}"]`))return;let n=r.dmMessageCache.get(e.channelId)||[];n.push(e),r.dmMessageCache.set(e.channelId,n),p.querySelector(".empty-state")&&(p.innerHTML="");let o=Xa(new Date),s=p.querySelector(".message-date-divider");if(!s||s.textContent!==o){let i=document.createElement("div");i.className="message-date-divider",i.textContent=o,p.insertBefore(i,p.firstChild)}let c=At(e);p.insertBefore(c,p.firstChild),Dt()}function Ln(e){if(!p||r.viewMode!=="dm"||r.currentConversationId!==e.channelId)return;let t=p.querySelector(`.message[data-id="${e.id}"]`);if(!t)return;let n=r.dmMessageCache.get(e.channelId)||[],a=n.findIndex(o=>o.id===e.id);a!==-1&&(n[a]=e,r.dmMessageCache.set(e.channelId,n)),t.replaceWith(At(e))}function bn(e,t){if(!p||r.viewMode!=="dm"||r.currentConversationId!==t)return;let n=p.querySelector(`.message[data-id="${e}"]`);n&&n.remove();let o=(r.dmMessageCache.get(t)||[]).filter(s=>s.id!==e);r.dmMessageCache.set(t,o),o.length===0&&(p.innerHTML=`
      <div class="empty-state">
        <div class="empty-state-icon">@</div>
        <h3>Start the conversation</h3>
        <p>Send a message to start chatting</p>
      </div>
    `)}var Va,Cn,Ve=w(()=>{"use strict";E();k();y();v();X();U();Va=50,Cn=!1});var de={};S(de,{appendThreadReply:()=>er,closeThread:()=>no,deleteThreadReply:()=>oo,loadThreadReplies:()=>Bn,openThread:()=>to,removeThreadReplyFromView:()=>nr,sendThreadReply:()=>ao,updateThreadBadge:()=>ar,updateThreadReply:()=>Jo,updateThreadReplyInView:()=>tr});async function to(e){r.currentThreadId=e,r.threadPanelOpen=!0,Xo().classList.add("active");let n=r.messageCache.get(e);Zo(n),await Bn(e)}function no(){r.currentThreadId=null,r.threadPanelOpen=!1;let e=document.getElementById("thread-panel");e&&e.classList.remove("active")}async function Bn(e,t){let n=document.getElementById("thread-messages");if(n)try{let a=`/messages/${e}/thread?limit=${eo}`;t&&(a+=`&before=${t}`);let s=(await m(a)).replies||[];if(!t)r.threadMessageCache.set(e,s),Qo(s);else{let c=r.threadMessageCache.get(e)||[];r.threadMessageCache.set(e,[...s,...c]),Yo(s)}s.length>=eo?Ko(e,s[0].id):Un()}catch(a){console.error("Failed to load thread replies:",a),t||(n.innerHTML='<div class="empty-state"><h3>Failed to load replies</h3></div>')}}function Yo(e){let t=document.getElementById("thread-messages");if(!t||e.length===0)return;Un();let n="";for(let a of e)n+=Rt(a);t.insertAdjacentHTML("afterbegin",n)}function Ko(e,t){Un();let n=document.getElementById("thread-messages");if(!n)return;let a=document.createElement("button");a.className="load-more-btn",a.id="load-more-thread-replies",a.textContent="Load older replies",a.addEventListener("click",async()=>{Tn||(Tn=!0,a.textContent="Loading...",await Bn(e,t),Tn=!1)}),n.insertBefore(a,n.firstChild)}function Un(){let e=document.getElementById("load-more-thread-replies");e&&e.remove()}async function ao(e){if(!(!r.currentThreadId||!e.trim()))try{await m(`/messages/${r.currentThreadId}/thread`,"POST",{content:e});let t=document.getElementById("thread-message-input");t&&(t.value="")}catch(t){console.error("Failed to send thread reply:",t),d(t.message||"Failed to send reply","error")}}async function oo(e){if(r.currentThreadId&&confirm("Are you sure you want to delete this reply?"))try{await m(`/messages/${r.currentThreadId}/thread/${e}`,"DELETE"),d("Reply deleted","success")}catch(t){console.error("Failed to delete thread reply:",t),d(t.message||"Failed to delete reply","error")}}async function Jo(e,t){if(r.currentThreadId)try{await m(`/messages/${r.currentThreadId}/thread/${e}`,"PUT",{content:t}),d("Reply updated","success")}catch(n){console.error("Failed to update thread reply:",n),d(n.message||"Failed to update reply","error")}}function Xo(){let e=document.getElementById("thread-panel");if(e?.dataset.initialized)return e;if(!e){e=document.createElement("div"),e.id="thread-panel",e.className="thread-panel";let t=document.getElementById("app-container");t&&t.appendChild(e)}return e.innerHTML=`
    <div class="thread-header" id="thread-header">
      <div class="thread-title">Thread</div>
      <button class="close-thread" id="close-thread-btn">&times;</button>
    </div>
    <div class="thread-parent" id="thread-parent"></div>
    <div class="thread-divider">Replies</div>
    <div class="thread-messages" id="thread-messages"></div>
    <div class="thread-input-area">
      <textarea class="message-input" id="thread-message-input" placeholder="Reply in thread..."></textarea>
      <button class="send-button" id="thread-send-button">&rarr;</button>
    </div>
  `,e.dataset.initialized="true",document.getElementById("close-thread-btn").addEventListener("click",no),document.getElementById("thread-send-button").addEventListener("click",()=>{let t=document.getElementById("thread-message-input");t.value.trim()&&ao(t.value)}),document.getElementById("thread-message-input").addEventListener("keydown",t=>{t.key==="Enter"&&!t.shiftKey&&(t.preventDefault(),document.getElementById("thread-send-button").click())}),document.getElementById("thread-messages").addEventListener("click",async t=>{let n=t.target.closest(".thread-reply-delete");if(n){let o=n.dataset.replyId;await oo(o);return}let a=t.target.closest(".thread-reply-edit");if(a){let o=a.dataset.replyId,c=t.target.closest(".thread-reply")?.querySelector(".message-text")?.textContent||"";ue({id:o,content:c}),r.currentMessageForEdit=o,r.currentMessageForEditIsThread=!0;return}}),e}function Zo(e){let t=document.getElementById("thread-parent");if(!t||!e)return;let n=M(e.author?.userName||"Unknown"),a=Ke(e.timestamp||e.createdAt),o=Ye(e.content);t.innerHTML=`
    <div class="message thread-parent-message">
      <div class="message-avatar">${n}</div>
      <div class="message-content">
        <div class="message-header">
          <span class="message-author">${e.author?.userName||"Unknown"}</span>
          <span class="message-time">${a}</span>
        </div>
        <div class="message-text">${o}</div>
      </div>
    </div>
  `}function Qo(e){let t=document.getElementById("thread-messages");if(!t)return;if(e.length===0){t.innerHTML=`
      <div class="empty-state">
        <p>No replies yet. Start the conversation!</p>
      </div>
    `;return}let n="";for(let a of e)n+=Rt(a);t.innerHTML=n}function Rt(e){let t=e.author.id===r.currentUser?.id,n=M(e.author.userName),a=Ke(e.timestamp||e.createdAt),o=Ye(e.content),s="";return t&&(s=`
      <div class="message-actions">
        <button class="message-edit thread-reply-edit" data-reply-id="${e.id}">Edit</button>
        <button class="message-delete thread-reply-delete" data-reply-id="${e.id}">Delete</button>
      </div>
    `),`
    <div class="message thread-reply" data-reply-id="${e.id}">
      <div class="message-avatar">${n}</div>
      <div class="message-content">
        <div class="message-header">
          <span class="message-author">${e.author.userName}</span>
          <span class="message-time">${a}</span>
        </div>
        <div class="message-text">${o}</div>
        ${s}
      </div>
    </div>
  `}function er(e){if(!r.threadPanelOpen||r.currentThreadId!==e.threadId)return;let t=document.getElementById("thread-messages");if(!t)return;let n=t.querySelector(".empty-state");if(n&&n.remove(),t.querySelector(`[data-reply-id="${e.id}"]`))return;let a=r.threadMessageCache.get(e.threadId)||[];a.push(e),r.threadMessageCache.set(e.threadId,a);let o=Rt(e);t.insertAdjacentHTML("beforeend",o),t.scrollTop=t.scrollHeight}function tr(e){if(!r.threadPanelOpen||r.currentThreadId!==e.threadId)return;let t=document.querySelector(`[data-reply-id="${e.id}"]`);if(!t)return;let n=Rt(e),a=document.createElement("div");a.innerHTML=n,t.replaceWith(a.firstElementChild)}function nr(e,t){if(!r.threadPanelOpen||r.currentThreadId!==t)return;let n=document.querySelector(`[data-reply-id="${e}"]`);n&&n.remove();let o=(r.threadMessageCache.get(t)||[]).filter(s=>s.id!==e);if(r.threadMessageCache.set(t,o),o.length===0){let s=document.getElementById("thread-messages");s&&(s.innerHTML='<div class="empty-state"><p>No replies yet. Start the conversation!</p></div>')}}function ar(e,t){let n=document.querySelector(`.message[data-id="${e}"]`);if(!n)return;let a=n.querySelector(".thread-badge");if(!t||t.replyCount===0){a&&a.remove();return}if(!a){a=document.createElement("div"),a.className="thread-badge",a.addEventListener("click",()=>to(e));let c=n.querySelector(".message-reactions");c&&c.parentNode.insertBefore(a,c.nextSibling)}let o=t.replyCount===1?"1 reply":`${t.replyCount} replies`,s=t.lastReplyBy?.userName||"Someone";a.innerHTML=`<span class="thread-badge-count">${o}</span> <span class="thread-badge-last">Last reply by ${s}</span>`}var eo,Tn,le=w(()=>{"use strict";E();v();y();X();U();eo=50,Tn=!1});async function so(e){let t=hn(e);if(!(!t.trim()&&r.pendingUploads.length===0)){if(t.length>vt){d(`Message too long. Your message is ${t.length} characters long and we support up to ${vt} characters.`,"error");return}if(r.viewMode==="dm"&&r.currentConversationId){let{sendDMMessage:n,uploadDMImage:a}=await Promise.resolve().then(()=>(Ve(),Qa));try{let o=[];if(r.pendingUploads.length>0)for(let s of r.pendingUploads){let c=await a({name:s.fileName,blob:s.blob,thumbnailBlob:s.thumbnailBlob});c&&o.push(c),URL.revokeObjectURL(s.preview)}await n(t,o)}catch(o){d(o.message||"Failed to send message","error")}return}try{z.value="";let n=`temp-${Date.now()}`,a=p.querySelector(".empty-state");a&&a.remove();let o={content:t};r.pendingUploads.length>0&&(o.images=[]);let s=await m(`/channels/${r.currentChannelId}/messages`,"POST",o);if(!s.message?.id)throw new Error("Failed to create message");let c=s.message.id;r.tempIdMap.set(n,c),r.messageCache.delete(n),r.messageCache.set(c,{...s.message,content:s.message.content}),co(n,c),r.pendingUploads.length>0&&(await or(c),await Dn(c,r.pendingUploads))}catch(n){d(n.message||"Failed to send message","error")}}}async function or(e){try{C();let t=await b(),n={"Content-Type":"application/json"};t&&(n.Authorization=`Bearer ${t}`);let a=[],o=new Set;for(let s of r.pendingUploads){if(o.has(s.fileHash)){console.log(`Skipping duplicate image with hash: ${s.fileHash}`),URL.revokeObjectURL(s.preview);continue}o.add(s.fileHash);let c=await St(s.blob),i=s.thumbnailBlob?await St(s.thumbnailBlob):void 0,u={filename:s.fileName,image:c};i&&(u.thumbnail=i);let l=await m(`/channels/${r.currentChannelId}/messages/image`,"POST",u),{filename:g}=l;a.push(g),URL.revokeObjectURL(s.preview)}if(a.length>0&&(await m(`/messages/${e}`,"PUT",{images:a}),r.messageCache.has(e))){let s=r.messageCache.get(e);s.images=a,r.messageCache.set(e,s)}r.pendingUploads=[],Le(),f(),a.length>0&&d("Images uploaded successfully")}catch(t){f(),d(t.message||"Failed to upload images","error")}}async function Pt(e){if(document.querySelector(`.message[data-id="${e.id}"]`))return;if(!e.id.startsWith("temp-")){let a=document.querySelectorAll(".message");for(let o of a){let s=o.dataset.authorId===e.author.id,c=o.querySelector(".message-text")?.textContent===e.content,i=o.dataset.id.startsWith("temp-");if(s&&c&&i){console.log(`Found matching temp message, updating ID from ${o.dataset.id} to ${e.id}`),co(o.dataset.id,e.id),r.messageCache.delete(o.dataset.id),r.messageCache.set(e.id,e),r.tempIdMap.set(o.dataset.id,e.id);return}}}r.messageCache.set(e.id,e);let t=Et(new Date(e.timestamp||e.createdAt));ir(t);let n=document.createElement("div");n.className="message",n.dataset.id=e.id,n.dataset.authorId=e.author.id,n.dataset.date=t,n.innerHTML=rr(e),cr(e,n),p.prepend(n),await sr(e),e.images&&e.images.length>0&&await Dn(e.id,e.images)}async function Dn(e,t){let n=document.querySelector(`.message[data-id="${e}"]`);if(n){let a=n.querySelector(".message-images-container");if(!a){let o=n.querySelector(".message-content");a=document.createElement("div"),a.className="message-images-container";let s=n.querySelector(".message-reactions");o.insertBefore(a,s)}for(let o of t){let s=`${N}/channels/${r.currentChannelId}/messages/image/${o}`,c=`img-container-${e}-${o}`,i=document.createElement("div");i.id=c,i.className="message-image-container",a.appendChild(i),await _n(s,c,e,o)}}}function rr(e){let t="Unknown User";e.author?.userName?t=e.author.userName:e.author.id===r.currentUser.id&&(t=r.currentUser.userName);let n=M(t),a=e.timestamp||e.createdAt,o=ke(new Date(a)),s="";if(e.content){let i=He(e.content);i=Fn(i),i=On(i),s=`<div class="message-text">${i}</div>`}let c=e.threadMeta?`<div class="thread-badge" data-thread-id="${e.id}">
        <span class="thread-badge-count">${e.threadMeta.replyCount} ${e.threadMeta.replyCount===1?"reply":"replies"}</span>
        <span class="thread-badge-last">Last reply by ${e.threadMeta.lastReplyBy?.userName||"Someone"}</span>
      </div>`:"";return`
  <div class="message-avatar">${n}</div>
  <div class="message-content">
    <div class="message-header">
      <span class="message-author">${t}</span>
      ${e.author?.isBot?'<span class="bot-badge">BOT</span>':""}
      <span class="message-time">${o}</span>
    </div>
    ${s}
    <div class="message-images-container"></div>
    <div class="message-reactions"></div>
    ${c}
    <div class="message-actions">
      ${e.author.id===r.currentUser?.id?`
        <button class="message-edit" data-id="${e.id}">Edit</button>
        <button class="message-delete" data-id="${e.id}">Delete</button>
      `:e.author?.isBot&&r.currentUser?.isAdmin?`<button class="message-delete" data-id="${e.id}">Delete</button>`:""}
      <div class="add-reaction" data-id="${e.id}">+ Add Reaction</div>
      <div class="start-thread" data-id="${e.id}">Reply</div>
    </div>
  </div>
`}async function sr(e){if(e.reactions&&Object.keys(e.reactions).length>0){let t=In(e.reactions);for(let[n,a]of Object.entries(t)){let o=a.includes(r.currentUser.id);await Te(e.id,n,a.length,o)}}}function ir(e){let t=!1,n=document.querySelectorAll(".message-date-divider");for(let a of n)if(a.textContent===e){t=!0;break}if(!t){let a=document.createElement("div");a.className="message-date-divider",a.textContent=e,p.prepend(a)}}function cr(e,t){let n=t.querySelector(".message-edit");n&&n.addEventListener("click",()=>ue(e));let a=t.querySelector(".message-delete");a&&a.addEventListener("click",()=>lr(e.id));let o=t.querySelector(".add-reaction");o&&o.addEventListener("click",()=>Je(e.id));let s=t.querySelector(".start-thread");s&&s.addEventListener("click",async()=>{let{openThread:i}=await Promise.resolve().then(()=>(le(),de));i(e.id)});let c=t.querySelector(".thread-badge");c&&c.addEventListener("click",async()=>{let{openThread:i}=await Promise.resolve().then(()=>(le(),de));i(e.id)})}async function Rn(e,t){try{t||(r.messageCache.clear(),p.innerHTML="");let n=`/channels/${e}/messages?limit=${ro}`;t&&(n+=`&before=${t}`);let{messages:a}=await m(n);if(!a||a.length===0){t||io(),$n();return}let o={};for(let i of a){let u=Et(new Date(i.createdAt));r.messageCache.set(i.id,i),o[u]||(o[u]=[]),o[u].push(i)}let s=Object.keys(o).sort((i,u)=>new Date(u)-new Date(i)),c=document.querySelectorAll(".message-date-divider");for(let i of s){if(!Array.from(c).some(l=>l.textContent===i)){let l=document.createElement("div");l.className="message-date-divider",l.textContent=i,p.appendChild(l)}for(let l of o[i])await Pt(l)}a.length>=ro?dr(e,a[0].id):$n()}catch(n){console.error("Error loading messages:",n),d("Failed to load messages","error")}}function dr(e,t){$n();let n=document.createElement("button");n.className="load-more-btn",n.id="load-more-messages",n.textContent="Load older messages",n.addEventListener("click",async()=>{An||(An=!0,n.textContent="Loading...",await Rn(e,t),An=!1)}),p.appendChild(n)}function $n(){let e=document.getElementById("load-more-messages");e&&e.remove()}function io(){let e=p.querySelectorAll(".empty-state");for(let n of e)n.remove();let t=document.createElement("div");t.className="empty-state",t.innerHTML=`
    <div class="empty-state-icon">\u{1F4AC}</div>
    <h3>No messages yet</h3>
    <p>Start the conversation!</p>
  `,p.appendChild(t)}function co(e,t){let n=document.querySelector(`.message[data-id="${e}"]`);if(n){n.dataset.id=t;let a=n.querySelectorAll(`[data-id="${e}"]`);for(let s of a)s.dataset.id=t;let o=n.querySelectorAll(`[data-message-id="${e}"]`);for(let s of o)s.dataset.messageId=t}}async function lo(e,t){let n=Be(e);if(!n){d("Invalid message ID","error");return}try{if(await m(`/messages/${n}`,"PUT",{content:t}),r.messageCache.has(e)){let a=r.messageCache.get(e);r.messageCache.set(e,{...a,content:t})}await Pn({id:e,content:t}),d("Message updated successfully")}catch(a){d(a.message||"Failed to update message","error")}}async function lr(e){let t=Be(e);if(!t){d("Invalid message ID","error");return}if(confirm("Are you sure you want to delete this message?"))try{await m(`/messages/${t}`,"DELETE"),Nn(e),d("Message deleted successfully")}catch(n){d(n.message||"Failed to delete message","error")}}async function Pn(e){let t=document.querySelector(`.message[data-id="${e.id}"]`);if(t){let n=t.querySelector(".message-text");if(n){let a=He(e.content);a=Fn(a),a=On(a),n.innerHTML=a}e.images&&e.images.length>0&&await Dn(e.id,e.images)}}function Nn(e){let t=document.querySelector(`.message[data-id="${e}"]`);if(t){t.remove();let n=document.querySelectorAll(".message-date-divider");for(let a of n){let o=a.nextElementSibling;(!o||o.classList.contains("message-date-divider"))&&a.remove()}document.querySelector(".message")||io()}}function Fn(e){let t=/https?:\/\/[^\s]+/g;return e.replace(t,n=>`<a href="${n}" target="_blank" class="message-link">${n}</a>`)}function Ye(e){if(!e)return"";let t=He(e);return t=Fn(t),t=On(t),t}function Ke(e){return ke(new Date(e))}function On(e){let t=/#([a-zA-Z0-9_-]+)/g;return e.replace(t,(n,a)=>{let s=Array.from(ne.querySelectorAll(".channel-item")).find(c=>c.querySelector(".channel-name").textContent.toLowerCase()===a.toLowerCase())?.dataset.id||"";return s?`<a href="#" class="channel-link" data-channel-id="${s}" data-channel-name="${a}">${n}</a>`:n})}function Be(e){if(e?.startsWith("temp-")){let t=r.tempIdMap.get(e);if(t)return t}return e}async function uo(e,t){let n=`temp-${Date.now()}`,a={id:n,content:t.content||"",author:r.currentUser,createdAt:new Date().toISOString(),reactions:{},images:[],isOffline:!0};return r.messageCache.set(n,a),await Pt(a),d("Message saved locally. Will sync when online.","info"),{message:a}}async function mo(e,t){try{let n=Be(e);if(!n){d("Invalid message ID","error");return}let a=r.messageCache.get(e);if(!a||!a.images){d("Message data not found","error");return}if(!a.author||a.author.id!==r.currentUser.id){d("You don't have permission to remove this image","error");return}let o=a.images.filter(c=>c!==t);await m(`/messages/${n}`,"PUT",{images:o}),a.images=o,r.messageCache.set(e,a);let s=document.getElementById(`img-container-${e}-${t}`);s&&s.remove(),d("Image removed successfully")}catch(n){d(n.message||"Failed to remove image","error")}}var ro,An,X=w(()=>{"use strict";E();k();B();v();y();F();U();Lt();Ge();ro=50,An=!1});var jn={};S(jn,{createChannel:()=>qn,deleteChannel:()=>Hn,loadChannels:()=>Z,restoreLastChannel:()=>ur,selectChannel:()=>Ue,updateChannelName:()=>zn});async function Z(){try{let{channels:e}=await m("/channels");ne.innerHTML="";for(let t of e)await Ae(t);if(e.length>0&&!r.currentChannelId){let t=null;try{t=await r.storage.getItem("currentChannelId")}catch{}t||(t=localStorage.getItem("lastChannelId"));let n=e.find(a=>a.id===t)||e[0];await Ue(n.id,n.name)}return e}catch{d("Failed to load channels","error")}}async function Ue(e,t){if(e===r.currentChannelId&&r.viewMode==="channel")return;r.currentConversationId=null,r.viewMode="channel",document.querySelectorAll(".dm-item").forEach(a=>{a.classList.remove("active")}),V.style.removeProperty("--channel-prefix"),r.currentChannelId=e,V.textContent=t,await r.storage.setItem("currentChannelId",e),localStorage.setItem("lastChannelId",e),r.unreadCounts.set(e,0),Q();let n=ne.querySelectorAll(".channel-item");for(let a of n)if(a.dataset.id===e){a.classList.add("active");let o={id:e,name:t};a.querySelector(".channel-settings")&&(o.createdBy=r.currentUser.id),await Ae(o)}else a.classList.remove("active");await Rn(e),await me(e)}async function qn(e){try{let{channel:t}=await m("/channels","POST",{name:e});d(`Channel #${e} created successfully!`),await Z(),await Ue(t.id,t.name)}catch(t){throw d(t.message||"Failed to create channel","error"),t}}async function Hn(e){try{await m(`/channels/${e}`,"DELETE"),d("Channel deleted successfully");let t=await Z();await Ue(t[0].id,t[0].name)}catch(t){throw d(t.message||"Failed to delete channel","error"),t}}async function zn(e,t){try{let{channel:n}=await m(`/channels/${e}`,"PUT",{name:t});return d(`Channel renamed to #${t} successfully`),r.currentChannelId===e&&(V.textContent=t),await Z(),n}catch(n){throw d(n.message||"Failed to update channel name","error"),n}}async function ur(){let e=null;try{e=await r.storage.getItem("currentChannelId")}catch{}if(e||(e=localStorage.getItem("lastChannelId")),!e)return;let t=document.querySelector(`.channel-item[data-id="${e}"]`);t&&t.click()}var Xe=w(()=>{"use strict";E();k();v();y();X();Ze()});var fo={};S(fo,{closeStartDmModalFn:()=>Ot,incrementDmUnread:()=>Jn,loadConversations:()=>Nt,openStartDmModal:()=>Yn,renderConversationItem:()=>po,renderConversationsList:()=>Ft,selectConversation:()=>Vn,startConversation:()=>go,updateConversationInCache:()=>Kn});async function Nt(){try{let t=(await m("/conversations")).conversations||[];r.conversationCache.clear();for(let n of t)r.conversationCache.set(n.id,n);Ft(t)}catch(e){console.error("Failed to load conversations:",e)}}function Ft(e){if(Fe){if(Fe.innerHTML="",e.length===0){Fe.innerHTML='<div class="empty-list">No conversations yet</div>';return}for(let t of e){let n=po(t);Fe.appendChild(n)}}}function po(e){let t=document.createElement("div");t.className="dm-item",t.dataset.conversationId=e.id,r.currentConversationId===e.id&&t.classList.add("active");let a=e.otherUser?.userName||"Unknown User",o=a.charAt(0).toUpperCase();return t.innerHTML=`
    <div class="dm-avatar">${o}</div>
    <span class="dm-name">${a}</span>
    ${mr(e.id)}
  `,t.addEventListener("click",()=>Vn(e.id)),t}function mr(e){let t=r.dmUnreadCounts.get(e)||0;return t>0?`<div class="notification-badge">${t>99?"99+":t}</div>`:""}async function Vn(e){r.currentChannelId=null,r.viewMode="dm",document.querySelectorAll(".channel-item").forEach(o=>{o.classList.remove("active")}),document.querySelectorAll(".dm-item").forEach(o=>{o.classList.toggle("active",o.dataset.conversationId===e)}),r.currentConversationId=e,r.dmUnreadCounts.set(e,0),Q();let t=document.querySelector(`.dm-item[data-conversation-id="${e}"]`);if(t){let o=t.querySelector(".notification-badge");o&&o.remove()}let n=r.conversationCache.get(e);if(n&&V){let o=n.otherUser?.userName||"Direct Message";V.textContent=o,V.style.setProperty("--channel-prefix",'"@"')}await Ut(e);let a=document.getElementById("sidebar");a&&a.classList.remove("open")}async function go(e){try{let t=await m("/conversations","POST",{targetUserId:e}),{conversation:n,isNew:a}=t;r.conversationCache.set(n.id,n),await Nt(),await Vn(n.id),Ot(),a&&d("Conversation started","success")}catch(t){console.error("Failed to start conversation:",t),d(t.message||"Failed to start conversation","error")}}async function Yn(){if(!Oe||!se)return;Oe.classList.add("active");let e=document.getElementById("dm-user-search");e&&(e.value="",e.focus());try{let a=((await m("/users")).users||[]).filter(o=>o.id!==r.currentUser?.id);if(Wn=a,Gn(a),e){let o=e.cloneNode(!0);e.parentNode.replaceChild(o,e),o.focus(),o.addEventListener("input",()=>{let s=o.value.trim().toLowerCase();if(!s){Gn(Wn);return}let c=Wn.filter(i=>(i.userName||"").toLowerCase().includes(s)||(i.email||"").toLowerCase().includes(s));Gn(c)})}}catch(t){console.error("Failed to load users:",t),se.innerHTML='<div class="empty-list">Failed to load users</div>'}}function Ot(){Oe&&Oe.classList.remove("active")}function Gn(e){if(se){if(se.innerHTML="",e.length===0){se.innerHTML='<div class="empty-list">No other users available</div>';return}for(let t of e){let n=document.createElement("div");n.className="dm-user-item";let a=t.userName?.charAt(0).toUpperCase()||t.email.charAt(0).toUpperCase();n.innerHTML=`
      <div class="user-avatar">${a}</div>
      <div class="user-info">
        <div class="user-name">${t.userName||t.email.split("@")[0]}</div>
        <div class="user-email">${t.email}</div>
      </div>
    `,n.addEventListener("click",()=>go(t.id)),se.appendChild(n)}}}function Kn(e){r.conversationCache.set(e.id,e);let t=Array.from(r.conversationCache.values());t.sort((n,a)=>(a.lastMessageAt||a.createdAt)-(n.lastMessageAt||n.createdAt)),Ft(t)}function Jn(e){if(r.currentConversationId===e)return;let t=r.dmUnreadCounts.get(e)||0;r.dmUnreadCounts.set(e,t+1);let n=Array.from(r.conversationCache.values());Ft(n)}var Wn,_t=w(()=>{"use strict";E();k();y();Ve();v();Wn=[]});var qt={};S(qt,{createWebhook:()=>gr,deleteWebhook:()=>ho,loadWebhooks:()=>pr});async function pr(){let e=document.getElementById("webhooks-list"),t=document.getElementById("webhook-channel-select");if(!(!e||!t))try{let n=await m("/webhooks","GET");e.innerHTML="";let a=await m("/channels","GET");t.innerHTML="";for(let o of a.channels||[]){let s=document.createElement("option");s.value=o.id,s.textContent=o.name,t.appendChild(s)}if(n.webhooks&&n.webhooks.length>0)for(let o of n.webhooks){let s=(a.channels||[]).find(h=>h.id===o.channelId),c=s?s.name:"Unknown",i=document.createElement("div");i.className="webhook-item",i.dataset.id=o.id;let u=`${location.origin}/webhooks/${o.id}/messages`;i.innerHTML=`
          <div class="webhook-info">
            <div class="webhook-name">${o.name}</div>
            <div class="webhook-channel">ID: ${o.id}</div>
            <div class="webhook-channel">Channel: #${c}</div>
            <div class="webhook-url-row">
              <code class="webhook-url">${u}</code>
              <button class="btn webhook-copy-url" title="Copy URL">Copy URL</button>
            </div>
          </div>
          <div class="webhook-actions">
            <button class="remove-webhook" title="Delete Webhook">&#10005;</button>
          </div>
        `;let l=i.querySelector(".webhook-copy-url");l&&l.addEventListener("click",()=>{navigator.clipboard.writeText(u),d("URL copied to clipboard")});let g=i.querySelector(".remove-webhook");g&&g.addEventListener("click",()=>ho(o.id,o.name)),e.appendChild(i)}else e.innerHTML='<div class="empty-list">No webhooks created yet</div>'}catch{}}async function gr(e,t){let n=document.getElementById("webhooks-list"),a=document.getElementById("webhook-name-input");try{C();let o=await m("/webhooks","POST",{name:e,channelId:t});if(f(),o.webhook){d("Webhook created successfully!");let s=document.querySelector(".webhook-token-display");s&&s.remove();let c=`${location.origin}/webhooks/${o.webhook.id}/messages`,i=document.createElement("div");i.className="webhook-token-display",i.innerHTML=`
        <div class="webhook-token-label">URL:</div>
        <code class="webhook-token-value">${c}</code>
        <button class="btn webhook-token-copy-url">Copy URL</button>
        <div class="webhook-token-label">Token (copy now, shown only once):</div>
        <code class="webhook-token-value">${o.webhook.token}</code>
        <button class="btn webhook-token-copy">Copy Token</button>
      `,n&&n.before(i);let u=i.querySelector(".webhook-token-copy-url");u&&u.addEventListener("click",()=>{navigator.clipboard.writeText(c),d("URL copied to clipboard")});let l=i.querySelector(".webhook-token-copy");l&&l.addEventListener("click",()=>{navigator.clipboard.writeText(o.webhook.token),d("Token copied to clipboard")}),a&&(a.value="")}}catch(o){f(),d(o.message||"Failed to create webhook","error")}}async function ho(e,t){if(confirm(`Are you sure you want to delete webhook "${t}"?`))try{C(),await m(`/webhooks/${e}`,"DELETE"),f(),d(`Webhook "${t}" has been deleted`)}catch(n){f(),d(n.message||"Failed to delete webhook","error")}}var Ht=w(()=>{"use strict";v();y()});async function me(e){r.messageEventSource&&(r.messageEventSource.close(),r.messageEventSource=null),Qe&&(clearTimeout(Qe),Qe=null);let t=await b();if(t)try{r.messageEventSource=new EventSource(`${N}/events?token=${t}`),r.messageEventSource.onopen=function(){$e=0,Xn=0},r.messageEventSource.onmessage=async function(n){try{let a=JSON.parse(n.data);switch(L&&console.log(`SSE event received: ${a.type}`,a.payload),a.type){case"CONNECTED":break;case"NEW_MESSAGE":if(a.payload.channelId===r.currentChannelId)await Pt(a.payload);else{let o=r.unreadCounts.get(a.payload.channelId)||0;r.unreadCounts.set(a.payload.channelId,o+1);let s=document.querySelector(`.channel-item[data-id="${a.payload.channelId}"]`);if(s){let u=s.querySelector(".channel-name").textContent;await Ae({id:a.payload.channelId,name:u})}let c=a.payload.author?.userName||"Someone",i=s?s.querySelector(".channel-name").textContent:"another channel";d(`${c} posted in #${i}`,"info"),Q(),et(`#${i}`,`${c}: ${a.payload.content}`)}break;case"UPDATE_MESSAGE":a.payload.channelId===r.currentChannelId&&(r.messageCache.has(a.payload.id)&&r.messageCache.set(a.payload.id,{...r.messageCache.get(a.payload.id),content:a.payload.content,images:a.payload.images,updatedAt:a.payload.updatedAt}),await Pn(a.payload));break;case"DELETE_MESSAGE":a.payload.channelId===r.currentChannelId&&(r.messageCache.delete(a.payload.id),Nn(a.payload.id));break;case"NEW_CHANNEL":Z();break;case"UPDATE_CHANNEL":if(Z(),a.payload.id===r.currentChannelId){let o=document.getElementById("current-channel-name");o&&(o.textContent=a.payload.name)}break;case"DELETE_CHANNEL":Z();break;case"NEW_REACTION":if(a.payload.messageId){let o=a.payload.messageId,s=a.payload.userId,c=a.payload.reaction;s!==r.currentUser.id&&await J(o,c,!0,!0)}break;case"DELETE_REACTION":if(a.payload.messageId){let o=a.payload.messageId,s=a.payload.userId,c=a.payload.reaction;if(r.messageCache.has(o)){let i=r.messageCache.get(o);i.reactions?.[c]&&(i.reactions[c]=i.reactions[c].filter(u=>u!==s),i.reactions[c].length===0&&delete i.reactions[c],r.messageCache.set(o,i))}s!==r.currentUser.id&&await J(o,c,!1,!0)}break;case"REMOVE_USER":a.payload.id===r.currentUser.id&&await tt();break;case"UPDATE_USER":if(a.payload.id===r.currentUser.id){r.currentUser.userName=a.payload.userName;let{getInitials:o}=await Promise.resolve().then(()=>(U(),Na));document.getElementById("user-avatar").textContent=o(a.payload.userName),document.getElementById("user-name").textContent=a.payload.userName}break;case"NEW_CONVERSATION":await Nt();break;case"NEW_DM_MESSAGE":if(a.payload.channelId.startsWith("dm:")){if(r.viewMode==="dm"&&a.payload.channelId===r.currentConversationId)Sn(a.payload);else{Jn(a.payload.channelId);let s=a.payload.author?.userName||"Someone";d(`${s} sent you a direct message`,"info"),Q(),et("Direct Message",`${s}: ${a.payload.content}`)}let o=r.conversationCache.get(a.payload.channelId);o&&(o.lastMessageAt=a.payload.createdAt,Kn(o))}break;case"UPDATE_DM_MESSAGE":a.payload.channelId.startsWith("dm:")&&Ln(a.payload);break;case"DELETE_DM_MESSAGE":a.payload.conversationId&&bn(a.payload.id,a.payload.conversationId);break;case"NEW_THREAD_REPLY":{let{appendThreadReply:o,updateThreadBadge:s}=await Promise.resolve().then(()=>(le(),de));if(a.payload.channelId===r.currentChannelId&&s(a.payload.parentMessageId,a.payload.threadMeta),o(a.payload.reply),a.payload.reply.author.id!==r.currentUser.id){let c=a.payload.reply.author?.userName||"Someone";d(`${c} replied in a thread`,"info"),et("Thread Reply",`${c}: ${a.payload.reply.content}`)}break}case"UPDATE_THREAD_REPLY":{let{updateThreadReplyInView:o}=await Promise.resolve().then(()=>(le(),de));o(a.payload);break}case"DELETE_THREAD_REPLY":{let{removeThreadReplyFromView:o,updateThreadBadge:s}=await Promise.resolve().then(()=>(le(),de));a.payload.channelId===r.currentChannelId&&s(a.payload.threadId,a.payload.threadMeta),o(a.payload.id,a.payload.threadId);break}case"UPDATE_SERVER_SETTINGS":if(a.payload.name){let o=document.querySelector(".server-name-text");o&&(o.textContent=a.payload.name)}break;case"NEW_WEBHOOK":case"DELETE_WEBHOOK":{if(document.getElementById("server-settings-modal")?.classList.contains("active")){let{loadWebhooks:o}=await Promise.resolve().then(()=>(Ht(),qt));o()}break}}}catch(a){console.error("Error processing SSE event",a)}},r.messageEventSource.onerror=function(n){if(Xn<hr&&Xn++,r.messageEventSource&&r.messageEventSource.readyState===EventSource.CLOSED){r.messageEventSource.close(),r.messageEventSource=null,$e++;let a=Math.min(1e3*2**$e,30*1e3);$e<=fr?(console.log(`SSE reconnect attempt ${$e} in ${a}ms`),Qe=setTimeout(async()=>{await me(e)},a)):(console.log("Maximum SSE reconnect attempts reached, trying again in 60s"),$e=0,Qe=setTimeout(async()=>{await me(e)},60*1e3))}}}catch(n){console.error("Error setting up SSE connection",n)}}function zt(){let e=document.getElementById("offline-bar"),t=document.getElementById("message-input"),n=document.getElementById("send-button");function a(){r.isOffline=!0,e&&e.classList.add("visible"),t&&(t.disabled=!0),n&&(n.disabled=!0),d("You are offline","error")}function o(){r.isOffline=!1,e&&e.classList.remove("visible"),t&&(t.disabled=!1),n&&(n.disabled=!1),d("You are back online","success")}window.addEventListener("offline",a),window.addEventListener("online",o),navigator.onLine||a()}var fr,hr,$e,Qe,Xn,Ze=w(()=>{"use strict";E();B();F();y();X();Ge();Xe();_t();Ve();fr=5,hr=3,$e=0,Qe=null,Xn=0});var yo={};S(yo,{fetchOAuthProviders:()=>vr,getProviderIcon:()=>wr,handleOAuthCallback:()=>Qn,initiateOAuth:()=>Er,isOAuthCallback:()=>Zn});function wr(e){return yr[e]||""}async function vr(){try{let e=await fetch(`${N}/auth/oauth/providers`);return e.ok?(await e.json()).providers||[]:[]}catch{return[]}}function Er(e){window.location.href=`${N}/auth/oauth/${e}`}function Zn(){let e=new URLSearchParams(window.location.search);return e.has("access_token")||e.has("oauth_error")}async function Qn(){let e=new URLSearchParams(window.location.search),t=e.get("oauth_error");if(t)throw window.history.replaceState({},document.title,window.location.pathname),new Error(t);let n=e.get("access_token"),a=e.get("refresh_token"),o=e.get("expires_in");if(!n)throw new Error("No access token received");await ce(),await pe({accessToken:n,refreshToken:a,exp:parseInt(o,10)||900}),zt(),window.history.replaceState({},document.title,window.location.pathname)}var yr,ea=w(()=>{"use strict";B();F();We();Ze();yr={google:`<svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844c-.209 1.125-.843 2.078-1.796 2.717v2.258h2.908c1.702-1.567 2.684-3.874 2.684-6.615z" fill="#4285F4"/>
    <path d="M9 18c2.43 0 4.467-.806 5.956-2.184l-2.908-2.258c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.711H.957v2.332C2.438 15.983 5.482 18 9 18z" fill="#34A853"/>
    <path d="M3.964 10.707c-.18-.54-.282-1.117-.282-1.707s.102-1.167.282-1.707V4.961H.957C.347 6.175 0 7.55 0 9s.348 2.825.957 4.039l3.007-2.332z" fill="#FBBC05"/>
    <path d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0 5.482 0 2.438 2.017.957 4.961L3.964 7.29C4.672 5.163 6.656 3.58 9 3.58z" fill="#EA4335"/>
  </svg>`,github:`<svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
    <path d="M12 0C5.37 0 0 5.37 0 12c0 5.31 3.435 9.795 8.205 11.385.6.105.825-.255.825-.57 0-.285-.015-1.23-.015-2.235-3.015.555-3.795-.735-4.035-1.41-.135-.345-.72-1.41-1.23-1.695-.42-.225-1.02-.78-.015-.795.945-.015 1.62.87 1.845 1.23 1.08 1.815 2.805 1.305 3.495.99.105-.78.42-1.305.765-1.605-2.67-.3-5.46-1.335-5.46-5.925 0-1.305.465-2.385 1.23-3.225-.12-.3-.54-1.53.12-3.18 0 0 1.005-.315 3.3 1.23.96-.27 1.98-.405 3-.405s2.04.135 3 .405c2.295-1.56 3.3-1.23 3.3-1.23.66 1.65.24 2.88.12 3.18.765.84 1.23 1.905 1.23 3.225 0 4.605-2.805 5.625-5.475 5.925.435.375.81 1.095.81 2.22 0 1.605-.015 2.895-.015 3.3 0 .315.225.69.825.57A12.02 12.02 0 0024 12c0-6.63-5.37-12-12-12z"/>
  </svg>`,microsoft:`<svg width="18" height="18" viewBox="0 0 23 23" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h11v11H0z" fill="#F25022"/>
    <path d="M12 0h11v11H12z" fill="#7FBA00"/>
    <path d="M0 12h11v11H0z" fill="#00A4EF"/>
    <path d="M12 12h11v11H12z" fill="#FFB900"/>
  </svg>`,gitlab:`<svg width="18" height="18" viewBox="0 0 24 24" fill="#FC6D26" xmlns="http://www.w3.org/2000/svg">
    <path d="M23.546 10.93L13.067.452c-.604-.603-1.582-.603-2.188 0L.452 10.93c-.6.605-.6 1.584 0 2.188l10.427 10.426c.603.602 1.582.602 2.188 0l10.48-10.478c.6-.603.6-1.582 0-2.187zm-11.544 11.07L2.468 12.467l9.534-9.533 9.534 9.533-9.534 9.534z"/>
  </svg>`}});async function jt(){try{let e=x==="password"&&!qe;e&&Jt&&(Jt.style.display="block");let t=await m("/users","GET");if(gt.innerHTML="",t.users&&t.users.length>0){let n=[...t.users].sort((a,o)=>a.id===r.currentUser.id?-1:o.id===r.currentUser.id?1:0);for(let a of n){let o=document.createElement("div");o.className="user-item",o.dataset.id=a.id;let s=a.id!==r.currentUser.id;o.innerHTML=`
          <div class="user-avatar">${M(a.userName||a.email.split("@")[0])}</div>
          <div class="user-info">
            <div class="user-email">${a.email}</div>
            <div class="user-role ${a.isAdmin?"admin-role":"user-role"}">${a.isAdmin?"Admin":"User"}</div>
            <div class="user-created">Added ${ke(new Date(a.createdAt))}</div>
          </div>
          ${s?`
            <div class="user-actions">
              ${e?'<button class="reset-password-user" title="Reset Password">\u21BB</button>':""}
              <button class="remove-user" title="Remove User">\u2715</button>
            </div>
          `:""}
        `;let c=o.querySelector(".remove-user");c&&c.addEventListener("click",()=>xr(a.id,a.email));let i=o.querySelector(".reset-password-user");i&&i.addEventListener("click",()=>Ir(a.id,a.email)),gt.appendChild(o)}}else gt.innerHTML='<div class="empty-list">No users added yet</div>'}catch(e){console.error("Error loading users:",e),d("Failed to load users","error")}}async function wo(e,t,n){try{C();let a={email:e,role:t};n&&(a.password=n);let o=await m("/users/add","POST",a);f(),o.success&&(d(`User ${e} added successfully!`),jt())}catch(a){f(),d(a.message||"Failed to add user","error")}}async function Ir(e,t){let n=prompt(`Enter new password for ${t} (min 8 characters):`);if(n){if(n.length<8){d("Password must be at least 8 characters","error");return}try{C(),await m(`/users/${e}/reset-password`,"POST",{password:n}),f(),d(`Password reset for ${t}`)}catch(a){f(),d(a.message||"Failed to reset password","error")}}}async function xr(e,t){if(confirm(`Are you sure you want to remove user ${t}?`))try{C(),await m(`/users/${e}`,"DELETE"),f(),d(`User ${t} has been removed`),jt()}catch(n){f(),d(n.message||"Failed to remove user","error")}}var ta=w(()=>{"use strict";E();k();v();y();U();B()});var vo={};S(vo,{closeUserSettingsModal:()=>Gt,hideServerSettingsModal:()=>Wt,loadServerName:()=>Cr,openServerSettingsModal:()=>na,openUserSettingsModal:()=>oa,updateServerName:()=>aa,updateUserName:()=>ra});function na(){let e=dt.textContent.trim().replace(/\s+/g," ");we.value=e,cn.classList.add("active"),we.focus(),jt();let t=document.getElementById("webhooks-section");r.currentUser?.isAdmin?(t&&(t.style.display="block"),Promise.resolve().then(()=>(Ht(),qt)).then(({loadWebhooks:n})=>n())):t&&(t.style.display="none")}function Wt(){cn.classList.remove("active");let e=document.querySelector(".webhook-token-display");e&&e.remove()}async function aa(e){try{C();let t=await m("/server/settings","PUT",{name:e});return lt.textContent=e,await r.storage.setItem("serverName",e),Wt(),d("Server name updated successfully"),f(),t}catch(t){throw f(),d(t.message||"Failed to update server name","error"),t}}async function Cr(){try{let t=await m("/server/settings","GET");if(t?.name){lt.textContent=t.name,await r.storage.setItem("serverName",t.name);return}}catch(t){console.error("Error loading server name from API:",t)}let e=await r.storage.getItem("serverName");e&&(lt.textContent=e)}function oa(){ve.value=r.currentUser?.userName||"",mn.classList.add("active"),ve.focus()}function Gt(){mn.classList.remove("active")}async function ra(e){let t=e?.trim();if(!t)return d("Name cannot be empty","error");try{C(),await m("/users/me","PUT",{userName:t}),r.currentUser.userName=t,pt.textContent=M(t),ft.textContent=t,Gt(),d("Display name updated"),f()}catch(n){f(),d(n.message||"Failed to update display name","error")}}var sa=w(()=>{"use strict";E();k();v();y();ta();U()});var O={};S(O,{closeAllModals:()=>Kt,closeCreateChannelModal:()=>Vt,closeEditChannelModal:()=>at,closeEditModal:()=>Yt,closeReactionPicker:()=>la,getReactionCount:()=>bt,hideLoading:()=>f,isReacted:()=>So,openCreateChannelModal:()=>da,openEditChannelModal:()=>Lo,openEditModal:()=>ue,openReactionPicker:()=>Je,reacted:()=>Tt,renderChannelItem:()=>Ae,renderDevModeEncryptionSignInView:()=>ia,renderDevModePlainSignInView:()=>Io,renderForgotPasswordView:()=>Sr,renderMagicLinkEncryptionSignInView:()=>ca,renderMagicLinkUnauthenticatedView:()=>xo,renderNewMagicLink:()=>br,renderPasswordRegisterView:()=>kr,renderPasswordResetSent:()=>Lr,renderPasswordResetView:()=>ko,renderPasswordSetupView:()=>Mo,renderPasswordSignInView:()=>Co,renderReaction:()=>Te,scrollToBottom:()=>Dt,showAppScreen:()=>nt,showAuthScreen:()=>G,showDesktopNotification:()=>et,showLoading:()=>C,showToast:()=>d,signInWithMagicLink:()=>Eo,updateDocumentTitle:()=>Q,updatePendingUploadsUI:()=>Le,updateReactionCount:()=>be});async function G(){Kt(),Qt.style.display="block",Zt.style.display="none",Mr();let e=ot();if(x==="dev")return ee()||e?ia():Io();if(x==="magic-link"){if(K())return ee()?ca():Eo();if(e){if(ee())return ca();await Se(j)}return xo()}if(x==="password"){let{emailParam:t,tokenParam:n,resetParam:a}=W();return t&&n&&a?ko(t):t&&n?Mo(t):e?(await Se(j),await nt()):Co()}}async function Mr(){if(!gn){ie.style.display="none",_e.style.display="none";return}try{let{fetchOAuthProviders:e,getProviderIcon:t,initiateOAuth:n}=await Promise.resolve().then(()=>(ea(),yo)),a=await e();if(a.length===0){ie.style.display="none",_e.style.display="none";return}ie.innerHTML=a.map(o=>{let s=t(o.id);return`<button type="button" class="btn oauth-btn oauth-btn-${o.id}" data-provider="${o.id}">
          ${s?`<span class="oauth-btn-icon">${s}</span>`:""}
          <span>Sign in with ${o.name}</span>
        </button>`}).join(""),ie.style.display="block",_e.style.display="flex",ie.querySelectorAll(".oauth-btn").forEach(o=>{o.addEventListener("click",()=>{n(o.dataset.provider)})})}catch(e){console.error("Failed to load OAuth providers:",e),ie.style.display="none",_e.style.display="none"}}function Eo(){let{emailParam:e}=W();$.value=e,T.click()}function Io(){P.textContent="Enter your email to sign in.",D.style.display="none",f()}function ia(){P.textContent="Enter your email and encryption key to sign in.",D.style.display="block",f()}function ca(){if(P.textContent="Enter your encryption key to sign in.",K()){ye.getElementsByTagName("label")[0].style.display="none",$.style.display="none";let{emailParam:t}=W();$.value=t}D.style.display="block",f()}function xo(){P.textContent="Enter your email to get a magic link.",D.style.display="none",f()}function Co(){P.textContent="Enter your email and password to sign in.",D.style.display="none",Ie.style.display="block",Ee.style.display="none",xe.style.display="none",wt.style.display=qe?"block":"none",T.textContent="Sign In",f()}function Mo(e){P.textContent="Set your password to complete registration.",ye.style.display="none",$.value=e,D.style.display="none",Ie.style.display="block",Ee.style.display="block",xe.style.display="none",T.textContent="Set Password",f()}function kr(){P.textContent="Create your account.",ye.style.display="block",D.style.display="none",Ie.style.display="block",Ee.style.display="block",xe.style.display="block",ba.textContent="Already have an account? Sign In",T.textContent="Create Account",f()}function Sr(){P.textContent="Enter your email to receive a password reset link.",ye.style.display="block",$.value="",D.style.display="none",Ie.style.display="none",Ee.style.display="none",xe.style.display="none",wt.style.display="none",T.textContent="Send Reset Link",f()}function ko(e){P.textContent="Reset your password.",ye.style.display="none",$.value=e,D.style.display="none",Ie.style.display="block",Ee.style.display="block",xe.style.display="none",wt.style.display="none",T.textContent="Reset Password",f()}function Lr(e){document.querySelector(".auth-form").style.display="none",$a.textContent=e||"If a matching account was found, a password reset link has been sent. Please check your inbox.",Aa.style.display="block"}async function br(e){let{apiRequest:t}=await Promise.resolve().then(()=>(v(),A)),n=await t("/auth/login","POST",{email:e});document.querySelector(".auth-form").style.display="none";let a=document.getElementById("magic-link-sent-form"),o=document.getElementById("magic-link-sent-message");o.textContent=n.message||`Magic link sent to ${e}. Please check your inbox and click the link to continue.`,a.style.display="block"}async function nt(){let{loadServerName:e}=await Promise.resolve().then(()=>(sa(),vo)),{loadChannels:t,restoreLastChannel:n}=await Promise.resolve().then(()=>(Xe(),jn)),{loadConversations:a}=await Promise.resolve().then(()=>(_t(),fo));if(r.currentUser=await bo(),!r.currentUser){f();return}window.history.replaceState({},document.title,window.location.pathname),await e(),await t(),await a(),pt.textContent=M(r.currentUser.userName),ft.textContent=r.currentUser.userName,Qt.style.display="none",Zt.style.display="flex",await n();let o=await r.storage.getItem("darkMode")!=="false";await Mt(o),f()}async function Ae(e){let{selectChannel:t}=await Promise.resolve().then(()=>(Xe(),jn)),n=document.querySelector(`.channel-item[data-id="${e.id}"]`);n||(n=document.createElement("div"),n.className="channel-item",n.dataset.id=e.id,n.addEventListener("click",async()=>await t(e.id,e.name)),ne.appendChild(n));let a=r.unreadCounts.get(e.id)||0;n.innerHTML="";let o=document.createElement("div");if(o.textContent=e.name,o.className="channel-name",n.appendChild(o),a>0){let s=document.createElement("div");s.className="notification-badge",s.textContent=a>99?"99+":a,n.appendChild(s)}if(e.createdBy===r.currentUser.id){let s=document.createElement("div");s.className="channel-settings",s.innerHTML="\u2699\uFE0F",s.addEventListener("click",c=>{c.stopPropagation(),Lo(e)}),n.appendChild(s)}e.id===r.currentChannelId?n.classList.add("active"):n.classList.remove("active")}function Le(){let e=document.getElementById("pending-uploads-container"),t=document.getElementById("pending-uploads");if(r.pendingUploads.length===0){e.style.display="none";return}e.style.display="block",t.innerHTML="",r.pendingUploads.forEach((a,o)=>{let s=document.createElement("div");s.className="pending-upload",s.innerHTML=`
      <img src="${a.preview}" alt="Upload preview">
      <div class="remove-upload" data-index="${o}">&times;</div>
    `,t.appendChild(s)}),document.querySelectorAll(".remove-upload").forEach(a=>{a.addEventListener("click",async o=>{let{removePendingUpload:s}=await Promise.resolve().then(()=>(Lt(),Wa)),c=Number.parseInt(o.target.dataset.index,10);s(c)})})}async function Te(e,t,n,a){let{addReaction:o,removeReaction:s}=await Promise.resolve().then(()=>(Ge(),Ga)),c=It(e);if(!c)return;let i=document.createElement("div");return i.className=`reaction ${a?"user-reacted":""}`,i.dataset.reaction=t,i.dataset.messageId=e,i.innerHTML=`
        <span class="reaction-reaction">${t}</span>
        <span class="reaction-count">${n}</span>
      `,i.addEventListener("click",async()=>{So(i)?await s(e,t):await o(e,t)}),c.appendChild(i),i}function bt(e){if(!e)return 0;let t=e.querySelector(".reaction-count");if(t)return Number.parseInt(t.textContent,10)||0}function be(e,t){if(!e)return;let n=e.querySelector(".reaction-count");n&&(n.textContent=t.toString())}function Tt(e,t){e&&(e.className=`reaction ${t?"user-reacted":""}`)}function So(e){if(e)return Array.from(e.classList).includes("user-reacted")}function d(e,t="success"){Ne.textContent=e,Ne.className=`toast ${t}`,Ne.classList.add("show"),setTimeout(()=>{Ne.classList.remove("show")},3e3)}function Dt(){let e=document.getElementById("messages-area");e&&(e.scrollTop=0)}function C(){rn.style.display="flex"}function f(){rn.style.display="none"}function da(){en.classList.add("active"),he.focus()}function Vt(){en.classList.remove("active"),he.value=""}function Je(e){r.currentMessageForReaction=e,De.classList.add("active")}function la(){De.classList.remove("active"),r.currentMessageForReaction=null}function ue(e){r.currentMessageForEdit=e.id,oe.value=e.content,an.classList.add("active"),oe.focus()}function Yt(){an.classList.remove("active"),oe.value="",r.currentMessageForEdit=null}function Lo(e){r.currentChannelForEdit=e,ae.value=e.name,nn.classList.add("active"),ae.focus()}function at(){nn.classList.remove("active"),ae.value="",r.currentChannelForEdit=null}function Kt(){document.querySelectorAll(".modal-backdrop.active").forEach(n=>{n.classList.remove("active")}),r.currentMessageForReaction=null,r.currentMessageForEdit=null,r.currentChannelForEdit=null;let t=document.querySelector(".webhook-token-display");t&&t.remove()}function Q(){let e=0;for(let t of r.unreadCounts.values())e+=t;for(let t of r.dmUnreadCounts.values())e+=t;document.title=e>0?`(${e}) MikroChat`:"MikroChat"}async function et(e,t){if(!("Notification"in window)||document.hasFocus()||(Notification.permission==="default"&&await Notification.requestPermission(),Notification.permission!=="granted"))return;let n=new Notification(e,{body:t,icon:"/icons/icon-192.png"});n.onclick=()=>{window.focus(),n.close()}}var y=w(()=>{"use strict";E();k();B();xt();Ct();F();We();U();wn()});var A={};S(A,{apiRequest:()=>m,fetchImageWithAuth:()=>_n});async function m(e,t="GET",n=null,a=null){if(!navigator.onLine&&t!=="GET"){if(e.includes("/channels/")&&e.includes("/messages")&&t==="POST")return uo(e,n);throw d("You're offline. This action will be available when you reconnect.","error"),new Error("Offline - cannot perform this action")}if(x!=="dev"&&e!=="/auth/login")try{if(await To()){await Bo();let i=await b();i&&await r.storage.setItem("accessToken",i)}}catch(i){throw console.error("Token refresh failed:",i),await r.storage.removeItem("accessToken"),r.currentUser=null,await G(),d("Session expired. Please log in again.","error"),new Error("Authentication failed")}let o={"Content-Type":"application/json"},s=a;r.isStorageInitialized&&(s=a||await b()),s&&(o.Authorization=`Bearer ${s}`);let c={method:t,headers:o};n&&(c.body=JSON.stringify(n));try{let i=await fetch(`${N}${e}`,c);if(!i.ok){let l=`Error ${i.status}: ${i.statusText}`;try{l=(await i.clone().json().catch(()=>({}))).error||l}catch(g){console.error("Could not parse error response",g)}throw new Error(l)}if(t==="DELETE"||i.headers.get("content-length")==="0")return{success:!0};if(e==="/events")return i;if(i.headers.get("content-type")?.includes("application/json"))try{return await i.clone().json()}catch(l){console.error("JSON parsing error:",l,"for endpoint:",e);let g=await i.text();try{return g?JSON.parse(g):{success:!0}}catch(h){return console.error("Manual JSON parsing also failed:",h),{success:!0,text:g}}}else{let l=await i.text();if(!l)return{success:!0};try{return JSON.parse(l)}catch{return{success:!0,text:l}}}}catch(i){throw navigator.onLine?d(i.message,"error"):d("You're working offline. Some features may be limited.","info"),i}}async function _n(e,t,n,a,o=!0){let s=await b(),c=o?`${e}${e.includes("?")?"&":"?"}size=thumb`:e,i=e;await fetch(c,{method:"GET",headers:{Authorization:`Bearer ${s}`}}).then(u=>{if(!u.ok)throw new Error("Image fetch failed");return u.blob()}).then(u=>{let l=URL.createObjectURL(u),g=document.getElementById(t);if(g){g.innerHTML="";let h=document.createElement("div");h.className="image-wrapper";let I=document.createElement("img");I.src=l,I.alt="User uploaded image",I.className="message-image",I.loading="lazy",I.setAttribute("onclick",`openImagePreview('${i}')`),h.appendChild(I);let _=r.messageCache.get(n);if(_?.author&&_.author.id===r.currentUser.id){let q=document.createElement("div");q.className="remove-image-btn",q.innerHTML="&times;",q.onclick=function(ge){ge.stopPropagation(),confirm("Remove this image?")&&mo(n,a)},h.appendChild(q)}g.appendChild(h)}}).catch(u=>{console.error("Error fetching image:",u);let l=document.getElementById(t);l&&(l.innerHTML='<div class="image-error">Failed to load image</div>')})}var v=w(()=>{"use strict";E();B();y();F();y();X()});async function pe(e){try{return await r.storage.setItem("accessToken",e.accessToken),await r.storage.setItem("refreshToken",e.refreshToken),await r.storage.setItem("exp",Date.now()+e.exp*1e3),!0}catch(t){return console.error("Failed to save tokens:",t),!1}}async function $o(){try{return{accessToken:await b(),refreshToken:await Do()}}catch(e){return console.error("Failed to get tokens:",e),null}}async function b(){return await r.storage.getItem("token")||await r.storage.getItem("accessToken")}async function Do(){return await r.storage.getItem("refreshToken")}async function Tr(){try{return await r.storage.removeItem("accessToken"),await r.storage.removeItem("refreshToken"),!0}catch(e){return console.error("Failed to clear tokens:",e),!1}}async function To(){let e=await $o();return e?Date.now()>e.exp-10*1e3:!0}function Br(e){if(!e)return null;try{let n=e.split(".")[1].replace(/-/g,"+").replace(/_/g,"/"),a=decodeURIComponent(atob(n).split("").map(o=>`%${`00${o.charCodeAt(0).toString(16)}`.slice(-2)}`).join(""));return JSON.parse(a)}catch(t){return console.error("Failed to parse token:",t),null}}async function bo(){let{apiRequest:e}=await Promise.resolve().then(()=>(v(),A)),t=await b();if(!t)return;let{user:n}=await e("/auth/me","GET");if(!n)return;let a=Br(t);if(a)return{id:n.id,userName:n.userName,email:n.sub,isAdmin:n.isAdmin,lastLogin:a.lastLogin,metadata:a.metadata}}async function _a(e){let{apiRequest:t}=await Promise.resolve().then(()=>(v(),A));try{let n=await t("/auth/verify","POST",{email:e.email},e.token);return await pe(n),n}catch(n){return console.error("Error while verifying token:",n),!1}}async function Bo(){let{apiRequest:e}=await Promise.resolve().then(()=>(v(),A)),t=await Do();if(!t)throw new Error("No refresh token available");try{let n=await e("/auth/refresh","POST",{refreshToken:t});if(!n.ok)throw new Error("Failed to refresh token");return await pe(n),n}catch(n){throw await Tr(),n}}async function tt(){let{apiRequest:e}=await Promise.resolve().then(()=>(v(),A)),{accessToken:t,refreshToken:n}=await $o();if(!t||!n){Uo();return}await e("/auth/logout","POST",{refreshToken:n}).then(a=>{if(a.error)throw new Error("Failed to logout");Uo()})}async function Uo(){let{showToast:e}=await Promise.resolve().then(()=>(y(),O));localStorage.clear(),r.storage.clear(),r.storage=null,r.currentUser=null,r.messageEventSource&&(r.messageEventSource.close(),r.messageEventSource=null),r.tempIdMap=new Map,r.messageCache=new Map,r.unreadCounts=new Map,window.location="/",e("You have been signed out")}function ee(){return Ce}function ot(){return yn()}async function Ro(e,t){let{showToast:n,showLoading:a,hideLoading:o,showAppScreen:s,renderNewMagicLink:c}=await Promise.resolve().then(()=>(y(),O));if(!e||!e.trim()){n("Please enter your email","error");return}if(!fn(e)){n("Email appears invalid. Please check the input.","error");return}if(re.style.display==="block"&&ee()&&(!t||!t.trim())){n("Please enter your encryption password","error");return}try{if(a(),!await ce(Ce?t:j)){o(),n("Invalid encryption key","error");return}if(ee()||(re.value=j),x==="dev")return await Ur(e);if(x==="magic-link"){if(K())return await Ar();if(ot()){if(await Fa(t))return n("Successfully logged in!"),await s();n("Invalid password","error")}else await c(e)}if(x==="password"){let l=ht?.value,g=yt?.value,{emailParam:h,tokenParam:I,resetParam:_}=W();if(ht&&ht.offsetParent===null&&!h&&!I)return await Rr(e);if(h&&I&&_){if(!l||l.length<8){n("Password must be at least 8 characters","error"),o();return}if(l!==g){n("Passwords do not match","error"),o();return}return await Ao(h,I,l)}if(h&&I){if(!l||l.length<8){n("Password must be at least 8 characters","error"),o();return}if(l!==g){n("Passwords do not match","error"),o();return}return await Ao(h,I,l)}if(yt&&yt.offsetParent!==null){if(!l||l.length<8){n("Password must be at least 8 characters","error"),o();return}if(l!==g){n("Passwords do not match","error"),o();return}return await Dr(e,l)}if(!l){n("Please enter your password","error"),o();return}return await $r(e,l)}o()}catch(i){o(),n(i.message||"Failed to log in","error")}}async function Ur(e){let{apiRequest:t}=await Promise.resolve().then(()=>(v(),A)),{showToast:n,showAppScreen:a}=await Promise.resolve().then(()=>(y(),O)),o=await t("/auth/dev-login","POST",{email:e});return await r.storage.setItem("token",o.token),r.currentUser=o.user,n("Successfully logged in!"),await a()}async function Ar(){let{showToast:e,showAppScreen:t}=await Promise.resolve().then(()=>(y(),O));return await Oa(),e("Successfully logged in!"),await t()}async function $r(e,t){let{apiRequest:n}=await Promise.resolve().then(()=>(v(),A)),{showToast:a,showAppScreen:o}=await Promise.resolve().then(()=>(y(),O)),s=await n("/auth/password-login","POST",{email:e,password:t});if(s.error)throw new Error(s.error);return await pe(s),a("Successfully logged in!"),await o()}async function Ao(e,t,n){let{apiRequest:a}=await Promise.resolve().then(()=>(v(),A)),{showToast:o,showAppScreen:s}=await Promise.resolve().then(()=>(y(),O)),c=await a("/auth/setup-password","POST",{email:e,token:t,password:n});if(c.error)throw new Error(c.error);return await pe(c),o("Password set successfully!"),await s()}async function Dr(e,t){let{apiRequest:n}=await Promise.resolve().then(()=>(v(),A)),{showToast:a,showAppScreen:o}=await Promise.resolve().then(()=>(y(),O)),s=await n("/auth/register","POST",{email:e,password:t});if(s.error)throw new Error(s.error);return await pe(s),a("Account created successfully!"),await o()}async function Rr(e){let{apiRequest:t}=await Promise.resolve().then(()=>(v(),A)),{hideLoading:n,renderPasswordResetSent:a}=await Promise.resolve().then(()=>(y(),O)),o=await t("/auth/request-password-reset","POST",{email:e});n(),a(o.message)}var F=w(()=>{"use strict";E();k();B();U();We();Ct();xt()});E();k();F();X();Xe();Ge();Lt();wn();B();F();We();Ct();ea();y();Ze();async function Po(){try{if(C(),Zn())try{return await Qn(),d("Successfully logged in!"),await nt()}catch(e){return f(),d(e.message||"OAuth sign-in failed","error"),await G()}return K()&&x!=="magic-link"&&x!=="password"&&(window.location="/"),K()&&x==="password"?await G():ee()?await G():ot()?(await ce(),zt(),await nt()):await G()}catch(e){return console.error("Error while checking if authenticated:",e),d("Failed to initialize the application","error"),f(),await G()}}Ze();ta();sa();y();v();_t();Ve();U();function No(){window.openImagePreview=En,window.addEventListener("online",async()=>{r.currentChannelId&&await me(r.currentChannelId)}),window.addEventListener("DOMContentLoaded",async()=>{await Po()}),document.addEventListener("click",()=>{un.classList.remove("show")}),document.addEventListener("keydown",e=>{e.key==="Escape"&&Kt()}),document.addEventListener("keydown",e=>{e.key==="Escape"&&H.classList.contains("active")&&H.classList.remove("active")}),document.addEventListener("click",e=>{window.innerWidth<=768&&ut.classList.contains("open")&&!e.target.closest(".sidebar")&&!e.target.closest(".menu-toggle")&&ut.classList.remove("open")}),document.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"?r.messageEventSource&&(r.messageEventSource.close(),r.messageEventSource=null):document.visibilityState==="visible"&&!r.messageEventSource&&r.currentChannelId&&me(r.currentChannelId)}),T?.addEventListener("click",()=>{let e=$.value.trim(),t=re?re.value?.trim():null;Ro(e,t)}),Ca?.addEventListener("click",()=>tt()),Ua?.addEventListener("click",async e=>{e.preventDefault();let{renderForgotPasswordView:t}=await Promise.resolve().then(()=>(y(),O));t()}),$?.addEventListener("keydown",e=>{e.key==="Enter"&&(e.preventDefault(),T.click())}),re?.addEventListener("keydown",e=>{e.key==="Enter"&&(e.preventDefault(),T.click())}),sn?.addEventListener("click",()=>{let e=z.value;so(e)}),z?.addEventListener("keydown",e=>{e.key==="Enter"&&!e.shiftKey&&(e.preventDefault(),sn.click())}),ma?.addEventListener("click",()=>da()),tn?.addEventListener("click",async()=>{let e=he.value.trim();e&&(await qn(e),Vt())}),he?.addEventListener("keydown",e=>{e.key==="Enter"&&(e.preventDefault(),tn.click())}),pa?.addEventListener("click",()=>Vt()),va?.addEventListener("click",async()=>{r.currentChannelForEdit&&confirm("Are you sure you want to delete this channel?")&&(await Hn(r.currentChannelForEdit.id),at())}),dn?.addEventListener("click",async()=>{let e=ae.value.trim();e&&r.currentChannelForEdit&&(await zn(r.currentChannelForEdit.id,e),at())}),ae?.addEventListener("keydown",e=>{e.key==="Enter"&&(e.preventDefault(),dn.click())}),ga?.addEventListener("click",()=>at()),on?.addEventListener("click",async()=>{let e=oe.value.trim();if(e&&r.currentMessageForEdit){if(r.currentMessageForEditIsThread){let{updateThreadReply:t}=await Promise.resolve().then(()=>(le(),de));await t(r.currentMessageForEdit,e),r.currentMessageForEditIsThread=!1}else r.currentMessageForEditIsDM?(await $t(r.currentMessageForEdit,e,r.currentMessageForEditImages||[]),r.currentMessageForEditIsDM=!1,r.currentMessageForEditImages=[]):await lo(r.currentMessageForEdit,e);Yt()}}),oe?.addEventListener("keydown",e=>{e.key==="Enter"&&!e.shiftKey&&(e.preventDefault(),on.click())}),fa?.addEventListener("click",()=>Yt()),Ea?.addEventListener("click",async e=>{let t=e.target.closest(".reaction-item");if(t&&r.currentMessageForReaction){let n=t.dataset.reaction;await Bt(r.currentMessageForReaction,n)}}),ha?.addEventListener("click",()=>la()),xa?.addEventListener("change",e=>{e.target.files.length>0&&(kt(e.target.files),e.target.value="")}),ya?.addEventListener("click",()=>{H.classList.remove("active");let e=R.getAttribute("data-object-url");e&&(URL.revokeObjectURL(e),R.removeAttribute("data-object-url"))}),p?.addEventListener("dragover",e=>{e.preventDefault(),p.classList.add("drag-over")}),p?.addEventListener("dragleave",()=>{p.classList.remove("drag-over")}),p?.addEventListener("drop",e=>{e.preventDefault(),p.classList.remove("drag-over"),e.dataTransfer.files.length>0&&kt(e.dataTransfer.files)}),p?.addEventListener("click",async e=>{let t=e.target.closest(".channel-link");if(t){e.preventDefault();let i=t.dataset.channelId,u=t.dataset.channelName;i&&await Ue(i,u);return}let n=e.target.closest('.message-edit[data-is-dm="true"]');if(n){let i=n.dataset.messageId,u=e.target.closest(".message"),l=u?.querySelector(".message-text")?.textContent||"",g=[];u?.querySelectorAll(".message-image").forEach(h=>{h.dataset.image&&g.push(h.dataset.image)}),r.currentMessageForEdit=i,r.currentMessageForEditIsDM=!0,r.currentMessageForEditContent=l,r.currentMessageForEditImages=g,ue({id:i,content:l,images:g});return}let a=e.target.closest('.message-delete[data-is-dm="true"]');if(a){let i=a.dataset.messageId;confirm("Are you sure you want to delete this message?")&&await kn(i);return}let o=e.target.closest(".add-reaction[data-message-id]");if(o){let i=o.dataset.messageId;r.currentMessageForReaction=i,r.currentMessageForReactionIsDM=!0,Je(i);return}let s=e.target.closest(".reaction[data-message-id]");if(s){let i=s.dataset.messageId,u=s.dataset.reaction;r.currentMessageForReactionIsDM=!0,ze(i,u)?await xn(i,u):await Bt(i,u);return}let c=e.target.closest(".remove-image-btn[data-message-id]");if(c){e.stopPropagation();let i=c.dataset.messageId,u=c.dataset.image;if(confirm("Remove this image?")){let l=e.target.closest(".message"),g=[];l?.querySelectorAll(".message-image").forEach(I=>{I.dataset.image&&I.dataset.image!==u&&g.push(I.dataset.image)});let h=l?.querySelector(".message-text")?.textContent||"";await $t(i,h,g)}return}}),mt?.addEventListener("click",async()=>{let e=!document.body.classList.contains("light-mode");await Mt(!e)}),Ma?.addEventListener("click",()=>{ut.classList.toggle("open")}),ka?.addEventListener("click",e=>{e.stopPropagation(),un.classList.toggle("show")}),dt?.addEventListener("click",()=>na()),wa?.addEventListener("click",()=>Wt()),ln?.addEventListener("click",async()=>{let e=we.value.trim();e&&await aa(e)}),we?.addEventListener("keydown",e=>{e.key==="Enter"&&(e.preventDefault(),ln.click())}),Sa?.addEventListener("click",()=>oa()),La?.addEventListener("click",()=>Gt()),pn?.addEventListener("click",async()=>{await ra(ve.value)}),ve?.addEventListener("keydown",e=>{e.key==="Enter"&&(e.preventDefault(),pn.click())}),Xt?.addEventListener("click",async()=>{let e=it.value.trim(),t=ct?.value?.trim()||"",n=document.querySelector('input[name="user-role"]:checked')?.value||"user";e&&(await wo(e,n,t||void 0),it.value="",ct&&(ct.value=""))}),it?.addEventListener("keydown",e=>{e.key==="Enter"&&(e.preventDefault(),Xt.click())}),Ia?.addEventListener("click",async()=>{if(confirm("Are you sure you want to leave this server?"))try{await m("/users/exit","POST"),await tt()}catch(e){console.error("Error exiting server:",e)}}),Ta?.addEventListener("click",()=>Yn()),Ba?.addEventListener("click",()=>Ot()),Da?.addEventListener("click",async()=>{let e=Ra?.value?.trim(),t=Pa?.value;if(e&&t){let{createWebhook:n}=await Promise.resolve().then(()=>(Ht(),qt));await n(e,t)}})}No();})();
