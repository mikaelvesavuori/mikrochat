"use strict";(()=>{(()=>{async function m(e,t="GET",n=null,a=null){if(!navigator.onLine&&t!=="GET"){if(e.includes("/channels/")&&e.includes("/messages")&&t==="POST")return handleOfflineMessageCreation(e,n);throw i("You're offline. This action will be available when you reconnect.","error"),new Error("Offline - cannot perform this action")}if(M==="magic-link"&&e!=="/auth/login")try{if(await bt()){await Nt();let c=await S();c&&await l.setItem("accessToken",c)}}catch(c){throw console.error("Token refresh failed:",c),await l.removeItem("accessToken"),f=null,await N(),i("Session expired. Please log in again.","error"),new Error("Authentication failed")}let r={"Content-Type":"application/json"},o=a;_e&&(o=a||await S()),o&&(r.Authorization=`Bearer ${o}`);let s={method:t,headers:r};n&&(s.body=JSON.stringify(n));try{let c=await fetch(`${Z}${e}`,s);if(!c.ok){let d=`Error ${c.status}: ${c.statusText}`;try{d=(await c.clone().json().catch(()=>({}))).error||d}catch(g){console.error("Could not parse error response",g)}throw new Error(d)}if(t==="DELETE"||c.headers.get("content-length")==="0")return{success:!0};if(e==="/events")return c;if(c.headers.get("content-type")?.includes("application/json"))try{return await c.clone().json()}catch(d){console.error("JSON parsing error:",d,"for endpoint:",e);let g=await c.text();try{return g?JSON.parse(g):{success:!0}}catch(k){return console.error("Manual JSON parsing also failed:",k),{success:!0,text:g}}}else{let d=await c.text();if(!d)return{success:!0};try{return JSON.parse(d)}catch{return{success:!0,text:d}}}}catch(c){throw navigator.onLine?i(c.message,"error"):i("You're working offline. Some features may be limited.","info"),c}}async function Mt(e,t,n,a){let r=await S();await fetch(e,{method:"GET",headers:{Authorization:`Bearer ${r}`}}).then(o=>{if(!o.ok)throw new Error("Image fetch failed");return o.blob()}).then(o=>{let s=URL.createObjectURL(o),c=document.getElementById(t);if(c){c.innerHTML="";let p=document.createElement("div");p.className="image-wrapper";let d=document.createElement("img");d.src=s,d.alt="User uploaded image",d.className="message-image",d.setAttribute("onclick",`openImagePreview('${e}')`),p.appendChild(d);let g=u.get(n);if(g?.author&&g.author.id===f.id){let R=document.createElement("div");R.className="remove-image-btn",R.innerHTML="&times;",R.onclick=function(P){P.stopPropagation(),confirm("Remove this image?")&&Cn(n,a)},p.appendChild(R)}c.appendChild(p)}}).catch(o=>{console.error("Error fetching image:",o);let s=document.getElementById(t);s&&(s.innerHTML='<div class="image-error">Failed to load image</div>')})}async function Re(e){try{return await l.setItem("accessToken",e.accessToken),await l.setItem("refreshToken",e.refreshToken),await l.setItem("exp",Date.now()+e.exp*1e3),!0}catch(t){return console.error("Failed to save tokens:",t),!1}}async function Pe(){try{return{accessToken:await S(),refreshToken:await De()}}catch(e){return console.error("Failed to get tokens:",e),null}}async function S(){return await l.getItem("token")||await l.getItem("accessToken")}async function De(){return await l.getItem("refreshToken")}async function $t(){try{return await l.removeItem("accessToken"),await l.removeItem("refreshToken"),!0}catch(e){return console.error("Failed to clear tokens:",e),!1}}async function bt(){let e=await Pe();return e?Date.now()>e.exp-10*1e3:!0}function Bt(e){if(!e)return null;try{let n=e.split(".")[1].replace(/-/g,"+").replace(/_/g,"/"),a=decodeURIComponent(atob(n).split("").map(r=>`%${`00${r.charCodeAt(0).toString(16)}`.slice(-2)}`).join(""));return JSON.parse(a)}catch(t){return console.error("Failed to parse token:",t),null}}async function At(){let e=await S();if(!e)return;let{user:t}=await m("/auth/me","GET");if(!t)return;let n=Bt(e);if(n)return{id:t.id,userName:t.userName,email:t.sub,isAdmin:t.isAdmin,lastLogin:n.lastLogin,metadata:n.metadata}}async function xt(e){try{let t=await m("/auth/verify","POST",{email:e.email},e.token);return await Re(t),t}catch(t){return console.error("Error while verifying token:",t),!1}}async function Nt(){let e=await De();if(!e)throw new Error("No refresh token available");try{let t=await m("/auth/refresh","POST",{refreshToken:e});if(!t.ok)throw new Error("Failed to refresh token");return await Re(t),t}catch(t){throw await $t(),t}}async function Ue(){let{accessToken:e,refreshToken:t}=await Pe();if(!e||!t){Fe();return}await m("/auth/logout","POST",{refreshToken:t}).then(n=>{if(n.error)throw new Error("Failed to logout");Fe()})}function Fe(){localStorage.clear(),l.clear(),l=null,f=null,y&&(y.close(),y=null),H=new Map,u=new Map,W=new Map,window.location="/",i("You have been signed out")}function b(){return K}function ye(){return gt()}async function Rt(e,t){if(!e||!e.trim()){i("Please enter your email","error");return}if(!Wn(e)){i("Email appears invalid. Please check the input.","error");return}if(A.style.display==="block"&&b()&&(!t||!t.trim())){i("Please enter your encryption password","error");return}try{if(T(),!await Me(K?t:O)){h(),i("Invalid encryption key","error");return}if(b()||(A.value=O),M==="dev")return await Pt(e);if(M==="magic-link"){if(ie())return await Dt();if(ye()){if(await xn(t))return i("Successfully logged in!"),await le();i("Invalid password","error")}else await Dn(e)}h()}catch(n){h(),i(n.message||"Failed to log in","error")}}async function Pt(e){let t=await m("/auth/dev-login","POST",{email:e});return await l.setItem("token",t.token),f=t.user,i("Successfully logged in!"),await le()}async function Dt(){return await yn(),i("Successfully logged in!"),await le()}async function U(){try{let{channels:e}=await m("/channels");Q.innerHTML="";for(let t of e)await $e(t);if(e.length>0&&!v){let t=await l.getItem("currentChannelId"),n=e.find(a=>a.id===t)||e[0];await F(n.id,n.name)}return e}catch{i("Failed to load channels","error")}}async function F(e,t){if(e===v)return;v=e,Ve.textContent=t,await l.setItem("currentChannelId",e),W.set(e,0);let n=Q.querySelectorAll(".channel-item");for(let a of n)if(a.dataset.id===e){a.classList.add("active");let r={id:e,name:t};a.querySelector(".channel-settings")&&(r.createdBy=f.id),await $e(r)}else a.classList.remove("active");await In(e),await _(e)}async function Ut(e){try{let{channel:t}=await m("/channels","POST",{name:e});i(`Channel #${e} created successfully!`),await U(),await F(t.id,t.name)}catch(t){throw i(t.message||"Failed to create channel","error"),t}}async function Ft(e){try{await m(`/channels/${e}`,"DELETE"),i("Channel deleted successfully");let t=await U();await F(t[0].id,t[0].name)}catch(t){throw i(t.message||"Failed to delete channel","error"),t}}async function Ot(e,t){try{let{channel:n}=await m(`/channels/${e}`,"PUT",{name:t});return i(`Channel renamed to #${t} successfully`),v===e&&(Ve.textContent=t),await U(),n}catch(n){throw i(n.message||"Failed to update channel name","error"),n}}async function qt(){let e=await l.getItem("currentChannelId");if(!e)return;let t=document.querySelector(`.channel-item[data-id="${e}"]`);t&&t.click()}let I=!0,M="dev",Z="http://localhost:3000",O="$J2Ek<wp5Wsp+x!FsGb[",K=!1,pe=1e3;I&&(console.table([{flag:"AUTH_MODE",setting:M},{flag:"API_BASE_URL",setting:Z},{flag:"DEFAULT_PASSWORD",setting:O},{flag:"ENABLE_USER_SPECIFIC_ENCRYPTION",setting:K},{flag:"MAX_CONTENT_LENGTH",setting:pe}]),console.log(`Has ${window.localStorage.length} items in localStorage`));let _t=5,zt=3,B=0,q=null,ve=0;async function _(e){y&&(y.close(),y=null),q&&(clearTimeout(q),q=null);let t=await S();if(t)try{y=new EventSource(`${Z}/events?token=${t}`),y.onopen=function(){B=0,ve=0},y.onmessage=async function(n){try{let a=JSON.parse(n.data);switch(I&&console.log(`SSE event received: ${a.type}`,a.payload),a.type){case"CONNECTED":break;case"NEW_MESSAGE":if(a.payload.channelId===v)await rt(a.payload);else{let r=W.get(a.payload.channelId)||0;W.set(a.payload.channelId,r+1);let o=document.querySelector(`.channel-item[data-id="${a.payload.channelId}"]`);if(o){let p=o.querySelector(".channel-name").textContent;await $e({id:a.payload.channelId,name:p})}let s=a.payload.author?.userName||"Someone",c=o?o.querySelector(".channel-name").textContent:"another channel";i(`${s} posted in #${c}`,"info")}break;case"UPDATE_MESSAGE":a.payload.channelId===v&&(u.has(a.payload.id)&&u.set(a.payload.id,{...u.get(a.payload.id),content:a.payload.content,images:a.payload.images,updatedAt:a.payload.updatedAt}),await ct(a.payload));break;case"DELETE_MESSAGE":a.payload.channelId===v&&(u.delete(a.payload.id),lt(a.payload.id));break;case"NEW_CHANNEL":U();break;case"NEW_REACTION":if(a.payload.messageId){let r=a.payload.messageId,o=a.payload.userId,s=a.payload.reaction;o!==f.id&&await x(r,s,!0,!0)}break;case"DELETE_REACTION":if(a.payload.messageId){let r=a.payload.messageId,o=a.payload.userId,s=a.payload.reaction;if(u.has(r)){let c=u.get(r);c.reactions?.[s]&&(c.reactions[s]=c.reactions[s].filter(p=>p!==o),c.reactions[s].length===0&&delete c.reactions[s],u.set(r,c))}o!==f.id&&await x(r,s,!1,!0)}break;case"REMOVE_USER":a.payload.id===f.id&&await Ue();break}}catch(a){console.error("Error processing SSE event",a)}},y.onerror=function(n){if(ve<zt&&ve++,y&&y.readyState===EventSource.CLOSED){y.close(),y=null,B++;let a=Math.min(1e3*2**B,30*1e3);B<=_t?(console.log(`SSE reconnect attempt ${B} in ${a}ms`),q=setTimeout(async()=>{await _(e)},a)):(console.log("Maximum SSE reconnect attempts reached, trying again in 60s"),B=0,q=setTimeout(async()=>{await _(e)},60*1e3))}}}catch(n){console.error("Error setting up SSE connection",n)}}async function Oe(e){for(let t of e){if(!t.type.match("image.*")){i("Only image files are supported","error");continue}try{let n=await Gt(t);if(E.some(p=>p.fileHash===n)){i("This image is already in your pending uploads","info");continue}let r=await Ht(t),o=Date.now(),s=t.name.split(".").pop().toLowerCase(),c=`${o}.${s}`;I&&(r.usedOriginal?i("Used original image (no compression needed)","info"):r.compressionRatio>0?i(`Image compressed by ${r.compressionRatio.toFixed(0)}%`,"info"):r.compressionRatio<=0&&i(`Image processed (size increased by ${Math.abs(r.compressionRatio).toFixed(0)}%)`,"info")),E.push({fileName:c,fileHash:n,blob:r.blob,preview:URL.createObjectURL(r.blob)}),be()}catch(n){console.error("Error processing image:",n),i("Failed to process image","error")}}}function jt(e){URL.revokeObjectURL(E[e].preview),E.splice(e,1),be()}function Ht(e){return new Promise((t,n)=>{I&&console.log(`Original image: ${e.name}, Size: ${qe(e.size)}`);let a=new FileReader;a.onload=function(r){let o=new Image;o.onload=function(){let s=o.width,c=o.height,p=`${s}x${c}`,d=s,g=c,k=1200;d>g&&d>k?(g=Math.round(g*k/d),d=k):g>k&&(d=Math.round(d*k/g),g=k);let R=s!==d||c!==g,P=document.createElement("canvas");P.width=d,P.height=g,P.getContext("2d").drawImage(o,0,0,d,g);let me=.7,fe=e.type,ge=e.name.split(".").pop().toLowerCase();ge==="png"?(fe="image/png",me=.8):ge==="jpg"||ge==="jpeg"?(fe="image/jpeg",me=.7):ge==="webp"&&(fe="image/webp",me=.75),P.toBlob(D=>{if(D)if(D.size>=e.size&&!R){I&&console.log("Processed image is larger than original. Using original file instead.");let he={blob:e,originalSize:e.size,newSize:e.size,compressionRatio:0,originalDimensions:p,newDimensions:p,usedOriginal:!0};t(he)}else{let he=((1-D.size/e.size)*100).toFixed(2);I&&(console.log(`Processed image: ${d}x${g} (from ${p})`),console.log(`New size: ${qe(D.size)}, Reduction: ${he}%`));let Yn={blob:D,originalSize:e.size,newSize:D.size,compressionRatio:Number.parseFloat(he),originalDimensions:p,newDimensions:`${d}x${g}`,usedOriginal:!1};t(Yn)}else n(new Error("Failed to create image blob"))},fe,me)},o.onerror=function(){n(new Error("Failed to load image"))},o.src=r.target.result},a.onerror=function(){n(new Error("Failed to read file"))},a.readAsDataURL(e)})}function qe(e){return e<1024?`${e} bytes`:e<1048576?`${(e/1024).toFixed(2)} KB`:`${(e/1048576).toFixed(2)} MB`}function Wt(e){return new Promise((t,n)=>{let a=new FileReader;a.onloadend=()=>{let r=a.result.split(",")[1];t(r)},a.onerror=n,a.readAsDataURL(e)})}async function Gt(e){return new Promise(t=>{let n=new FileReader;n.onload=a=>{let r=a.target.result,o=Vt(r);t(o)},n.readAsArrayBuffer(e)})}function Vt(e){let t=new DataView(e),n=0,a=Math.max(1,Math.floor(e.byteLength/1e3));for(let r=0;r<e.byteLength;r+=a){let o=r+3<e.byteLength?t.getUint32(r):t.getUint8(r);n=(n<<5)-n+o,n|=0}return n.toString(16)}async function Yt(e){C.src="",$.classList.add("active"),C.style.display="none";let t=document.createElement("div");t.className="loading-spinner",$.querySelector(".image-preview-container").appendChild(t),await S().then(n=>{fetch(e,{method:"GET",headers:{Authorization:`Bearer ${n}`}}).then(a=>{if(!a.ok)throw new Error("Image fetch failed");return a.blob()}).then(a=>{let r=URL.createObjectURL(a);C.src=r,C.style.display="block";let o=$.querySelector(".loading-spinner");o&&o.remove(),C.setAttribute("data-object-url",r)}).catch(a=>{console.error("Error fetching preview image:",a),C.style.display="none",$.querySelector(".image-preview-container").innerHTML='<div class="image-error">Failed to load image</div>'})})}let L=null,f=null,v=null,y=null,z=null,j=null,_e=!1,E=[],H=new Map,u=new Map,W=new Map,l=null,we=document.getElementById("add-email-input"),ze=document.getElementById("add-user-btn"),Jt=document.getElementById("add-channel-btn"),je=document.getElementById("app-container"),He=document.getElementById("auth-container"),X=document.getElementById("channel-name"),Q=document.getElementById("channels-list"),Zt=document.getElementById("close-channel-modal"),Kt=document.getElementById("close-edit-channel-modal"),Xt=document.getElementById("close-edit-modal"),Qt=document.getElementById("close-reaction-modal"),en=document.getElementById("close-image-preview"),tn=document.getElementById("close-server-settings-modal"),We=document.getElementById("create-channel-modal"),Ge=document.getElementById("create-channel-submit"),Ve=document.getElementById("current-channel-name"),nn=document.getElementById("delete-channel-btn"),Ye=document.getElementById("edit-channel-modal"),G=document.getElementById("edit-channel-name"),ee=document.getElementById("edit-message-input"),Je=document.getElementById("edit-message-modal"),an=document.getElementById("edit-message-submit"),on=document.getElementById("auth-form-email"),V=document.getElementById("auth-email"),rn=document.getElementById("reaction-picker"),Ee=document.getElementById("reaction-picker-modal"),te=document.getElementById("auth-form-encryption"),A=document.getElementById("encryption-password"),sn=document.getElementById("exit-server-btn"),$=document.getElementById("image-preview-modal"),cn=document.getElementById("image-upload"),Ze=document.getElementById("loading"),ne=document.getElementById("login-btn"),ln=document.getElementById("logout-btn"),dn=document.getElementById("menu-toggle"),ae=document.getElementById("message-input"),w=document.getElementById("messages-area"),Jn=document.getElementById("password"),C=document.getElementById("preview-image"),un=document.getElementById("send-button"),Ke=document.getElementById("server-name"),oe=document.getElementById("server-name-input"),ke=document.querySelector(".server-name-text"),Xe=document.getElementById("server-settings-modal"),Ie=document.getElementById("sidebar"),re=document.getElementById("auth-form-text"),Se=document.getElementById("theme-switch"),Qe=Se.querySelector(".theme-switch-icon"),et=Se.querySelector(".theme-switch-label"),se=document.getElementById("toast"),tt=document.getElementById("update-channel-submit"),nt=document.getElementById("update-server-name-btn"),mn=document.getElementById("user-avatar"),at=document.getElementById("user-dropdown"),fn=document.getElementById("user-menu"),Le=document.getElementById("users-list"),gn=document.getElementById("user-name");Jt.addEventListener("click",Fn),we.addEventListener("keydown",e=>{e.key==="Enter"&&ze.click()}),ze.addEventListener("click",()=>{let e=we.value.trim(),t=document.querySelector('input[name="user-role"]:checked').value;e?hn(e)?(jn(e,t),we.value=""):i("Please enter a valid email address","error"):i("Please enter an email address","error")});function hn(e){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)}X.addEventListener("keydown",e=>{e.key==="Enter"&&Ge.click()}),Zt.addEventListener("click",Et),Kt.addEventListener("click",Ae),Xt.addEventListener("click",kt),en.addEventListener("click",()=>{$.classList.remove("active");let e=C.getAttribute("data-object-url");e&&(URL.revokeObjectURL(e),C.removeAttribute("data-object-url"))}),Qt.addEventListener("click",qn),tn.addEventListener("click",ft),Ge.addEventListener("click",()=>{let e=X.value.trim();e?(Ut(e),Et()):i("Please enter a channel name","error")}),nn.addEventListener("click",async()=>{L&&confirm(`Are you sure you want to delete #${L.name}? This action cannot be undone.`)&&(await Ft(L.id),Ae())}),document.addEventListener("click",()=>{at.classList.remove("show")}),document.addEventListener("keydown",e=>{e.key==="Escape"&&It()}),document.addEventListener("keydown",e=>{e.key==="Escape"&&$.classList.contains("active")&&$.classList.remove("active")}),document.addEventListener("click",e=>{window.innerWidth<=768&&Ie.classList.contains("open")&&!e.target.closest(".sidebar")&&!e.target.closest(".menu-toggle")&&Ie.classList.remove("open")}),document.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"?y&&(y.close(),y=null):document.visibilityState==="visible"&&!y&&v&&_(v)}),G.addEventListener("keydown",e=>{e.key==="Enter"&&tt.click()}),an.addEventListener("click",async()=>{let e=ee.value.trim();e&&j?(await Sn(j,e),kt()):i("Please enter message content","error")}),V.addEventListener("keydown",e=>{e.key==="Enter"&&ne.click()}),A.addEventListener("keydown",e=>{e.key==="Enter"&&(A.value="",ne.click())}),sn.addEventListener("click",async()=>{if(confirm("Are you sure you want to exit this server? This action cannot be undone."))try{T();let e=await m("/users/exit","POST");if(h(),e.success)return await l.clear(),i("You have exited the server. Goodbye!"),await N()}catch(e){h(),i(e.message||"Failed to exit server","error")}}),cn.addEventListener("change",e=>{e.target.files.length>0&&(Oe(e.target.files),e.target.value="")}),ne.addEventListener("click",()=>{let e=V.value.trim(),t=A?A.value?.trim():null;Rt(e,t)}),ln.addEventListener("click",async()=>{try{return T(),await Ue(),i("Logged out successfully"),await N()}catch(e){h(),i(e.message||"Failed to logout","error")}}),dn.addEventListener("click",()=>{Ie.classList.toggle("open")}),ae.addEventListener("keydown",e=>{if(e.key==="Enter"&&!e.shiftKey){e.preventDefault();let t=ae.value;ot(t)}}),w.addEventListener("dragover",e=>{e.preventDefault(),w.classList.add("drag-over")}),w.addEventListener("dragleave",()=>{w.classList.remove("drag-over")}),w.addEventListener("drop",e=>{e.preventDefault(),w.classList.remove("drag-over"),e.dataTransfer.files.length>0&&Oe(e.dataTransfer.files)}),w.addEventListener("click",async e=>{let t=e.target.closest(".channel-link");if(t){e.preventDefault();let n=t.dataset.channelId,a=t.dataset.channelName;n&&await F(n,a)}}),rn.addEventListener("click",async e=>{let t=e.target.closest(".reaction-item");if(t&&z){let n=t.dataset.reaction;await mt(z,n)}}),un.addEventListener("click",()=>{let e=ae.value;ot(e)}),Ke.addEventListener("click",$n),oe.addEventListener("keydown",e=>{e.key==="Enter"&&nt.click()}),Se.addEventListener("click",async()=>{let e=!document.body.classList.contains("light-mode");await ht(!e)}),tt.addEventListener("click",async()=>{let e=G.value.trim();if(e&&L)try{await Ot(L.id,e),Ae()}catch{}else i("Please enter a channel name","error")}),nt.addEventListener("click",async()=>{let e=oe.value.trim();e?await bn(e):i("Please enter a server name","error")}),fn.addEventListener("click",e=>{e.stopPropagation(),at.classList.toggle("show")}),window.openImagePreview=Yt,window.addEventListener("online",async()=>{v&&await _(v)}),window.addEventListener("DOMContentLoaded",async()=>{await An()});function ie(){let{emailParam:e,tokenParam:t}=ue();return e&&t}async function yn(){try{let{emailParam:e,tokenParam:t}=ue();if(!e||!t)return!1;let n=await xt({email:e,token:t}),{accessToken:a,refreshToken:r}=n;return await l.setItem("accessToken",a),await l.setItem("refreshToken",r),!0}catch(e){return console.log("Magic link verification error:",e),!1}}async function ot(e){let t=Gn(e);if(!(!t.trim()&&E.length===0)){if(t.length>pe){i(`Message too long. Your message is ${t.length} characters long and we support up to ${pe} characters.`,"error");return}try{ae.value="";let n=`temp-${Date.now()}`,a=w.querySelector(".empty-state");a&&a.remove();let r={content:t};E.length>0&&(r.images=[]);let o=await m(`/channels/${v}/messages`,"POST",r);if(!o.message?.id)throw new Error("Failed to create message");let s=o.message.id;H.set(n,s),u.delete(n),u.set(s,{...o.message,content:o.message.content}),it(n,s),E.length>0&&(await pn(s),await Ce(s,E))}catch(n){i(n.message||"Failed to send message","error")}}}async function pn(e){try{T();let t=await S(),n={"Content-Type":"application/json"};t&&(n.Authorization=`Bearer ${t}`);let a=[],r=new Set;for(let o of E){if(r.has(o.fileHash)){console.log(`Skipping duplicate image with hash: ${o.fileHash}`),URL.revokeObjectURL(o.preview);continue}r.add(o.fileHash);let s=await Wt(o.blob),c=await m(`/channels/${v}/messages/image`,"POST",{filename:o.fileName,image:s}),{filename:p}=c;a.push(p),URL.revokeObjectURL(o.preview)}if(a.length>0&&(await m(`/messages/${e}`,"PUT",{images:a}),u.has(e))){let o=u.get(e);o.images=a,u.set(e,o)}E=[],be(),h(),a.length>0&&i("Images uploaded successfully")}catch(t){h(),i(t.message||"Failed to upload images","error")}}async function rt(e){if(document.querySelector(`.message[data-id="${e.id}"]`))return;if(!e.id.startsWith("temp-")){let a=document.querySelectorAll(".message");for(let r of a){let o=r.dataset.authorId===e.author.id,s=r.querySelector(".message-text")?.textContent===e.content,c=r.dataset.id.startsWith("temp-");if(o&&s&&c){console.log(`Found matching temp message, updating ID from ${r.dataset.id} to ${e.id}`),it(r.dataset.id,e.id),u.delete(r.dataset.id),u.set(e.id,e),H.set(r.dataset.id,e.id);return}}}u.set(e.id,e);let t=St(new Date(e.timestamp||e.createdAt));En(t);let n=document.createElement("div");n.className="message",n.dataset.id=e.id,n.dataset.authorId=e.author.id,n.dataset.date=t,n.innerHTML=vn(e),kn(e,n),w.prepend(n),await wn(e),e.images&&e.images.length>0&&await Ce(e.id,e.images)}async function Ce(e,t){let n=document.querySelector(`.message[data-id="${e}"]`);if(n){let a=n.querySelector(".message-images-container");if(!a){let r=n.querySelector(".message-content");a=document.createElement("div"),a.className="message-images-container";let o=n.querySelector(".message-reactions");r.insertBefore(a,o)}for(let r of t){let o=`${Z}/channels/${v}/messages/image/${r}`,s=`img-container-${e}-${r}`,c=document.createElement("div");c.id=s,c.className="message-image-container",a.appendChild(c),await Mt(o,s,e,r)}}}function vn(e){let t="Unknown User";e.author?.userName?t=e.author.userName:e.author.id===f.id&&(t=f.userName);let n=Ne(t),a=e.timestamp||e.createdAt,r=Lt(new Date(a)),o="";if(e.content){let s=Ct(e.content);s=dt(s),s=ut(s),o=`<div class="message-text">${s}</div>`}return`
  <div class="message-avatar">${n}</div>
  <div class="message-content">
    <div class="message-header">
      <span class="message-author">${t}</span>
      <span class="message-time">${r}</span>
    </div>
    ${o}
    <div class="message-images-container"></div>
    <div class="message-reactions"></div>
    <div class="message-actions">
      ${e.author.id===f?.id?`
        <button class="message-edit" data-id="${e.id}">Edit</button>
        <button class="message-delete" data-id="${e.id}">Delete</button>
      `:""}
      <div class="add-reaction" data-id="${e.id}">+ Add Reaction</div>
    </div>
  </div>
`}async function wn(e){if(e.reactions&&Object.keys(e.reactions).length>0){let t=Tn(e.reactions);for(let[n,a]of Object.entries(t)){let r=a.includes(f.id);await Be(e.id,n,a.length,r)}}}function En(e){let t=!1,n=document.querySelectorAll(".message-date-divider");for(let a of n)if(a.textContent===e){t=!0;break}if(!t){let a=document.createElement("div");a.className="message-date-divider",a.textContent=e,w.prepend(a)}}function kn(e,t){let n=t.querySelector(".message-edit");n&&n.addEventListener("click",()=>_n(e));let a=t.querySelector(".message-delete");a&&a.addEventListener("click",()=>Ln(e.id));let r=t.querySelector(".add-reaction");r&&r.addEventListener("click",()=>On(e.id))}async function In(e){try{u.clear(),w.innerHTML="";let{messages:t}=await m(`/channels/${e}/messages`);if(!t||t.length===0){st();return}let n={};for(let o of t){let s=St(new Date(o.createdAt));u.set(o.id,o),n[s]||(n[s]=[]),n[s].push(o)}let a=Object.keys(n).sort((o,s)=>new Date(s)-new Date(o)),r=document.querySelectorAll(".message-date-divider");for(let o of a){if(!Array.from(r).some(c=>c.textContent===o)){let c=document.createElement("div");c.className="message-date-divider",c.textContent=o,w.appendChild(c)}for(let c of n[o])await rt(c)}}catch(t){console.error("Error loading messages:",t),i("Failed to load messages","error")}}function st(){let e=w.querySelectorAll(".empty-state");for(let n of e)n.remove();let t=document.createElement("div");t.className="empty-state",t.innerHTML=`
    <div class="empty-state-icon">\u{1F4AC}</div>
    <h3>No messages yet</h3>
    <p>Start the conversation!</p>
  `,w.appendChild(t)}function it(e,t){let n=document.querySelector(`.message[data-id="${e}"]`);if(n){n.dataset.id=t;let a=n.querySelectorAll(`[data-id="${e}"]`);for(let o of a)o.dataset.id=t;let r=n.querySelectorAll(`[data-message-id="${e}"]`);for(let o of r)o.dataset.messageId=t}}async function Sn(e,t){let n=Y(e);if(!n){i("Invalid message ID","error");return}try{if(await m(`/messages/${n}`,"PUT",{content:t}),u.has(e)){let a=u.get(e);u.set(e,{...a,content:t})}await ct({id:e,content:t}),i("Message updated successfully")}catch(a){i(a.message||"Failed to update message","error")}}async function Ln(e){let t=Y(e);if(!t){i("Invalid message ID","error");return}if(confirm("Are you sure you want to delete this message?"))try{await m(`/messages/${t}`,"DELETE"),lt(e),i("Message deleted successfully")}catch(n){i(n.message||"Failed to delete message","error")}}async function ct(e){let t=document.querySelector(`.message[data-id="${e.id}"]`);if(t){let n=t.querySelector(".message-text");if(n){let a=Ct(e.content);a=dt(a),a=ut(a),n.innerHTML=a}e.images&&e.images.length>0&&await Ce(e.id,e.images)}}function lt(e){let t=document.querySelector(`.message[data-id="${e}"]`);if(t){t.remove();let n=document.querySelectorAll(".message-date-divider");for(let a of n){let r=a.nextElementSibling;(!r||r.classList.contains("message-date-divider"))&&a.remove()}document.querySelector(".message")||st()}}function dt(e){let t=/https?:\/\/[^\s]+/g;return e.replace(t,n=>`<a href="${n}" target="_blank" class="message-link">${n}</a>`)}function ut(e){let t=/#([a-zA-Z0-9_-]+)/g;return e.replace(t,(n,a)=>{let o=Array.from(Q.querySelectorAll(".channel-item")).find(s=>s.querySelector(".channel-name").textContent.toLowerCase()===a.toLowerCase())?.dataset.id||"";return o?`<a href="#" class="channel-link" data-channel-id="${o}" data-channel-name="${a}">${n}</a>`:n})}function Y(e){if(e?.startsWith("temp-")){let t=H.get(e);if(t)return t}return e}async function Cn(e,t){try{let n=Y(e);if(!n){i("Invalid message ID","error");return}let a=u.get(e);if(!a||!a.images){i("Message data not found","error");return}if(!a.author||a.author.id!==f.id){i("You don't have permission to remove this image","error");return}let r=a.images.filter(s=>s!==t);await m(`/messages/${n}`,"PUT",{images:r}),a.images=r,u.set(e,a);let o=document.getElementById(`img-container-${e}-${t}`);o&&o.remove(),i("Image removed successfully")}catch(n){i(n.message||"Failed to remove image","error")}}function Tn(e){let t={};if(!e)return t;for(let[n,a]of Object.entries(e)){if(!a)return;for(let r of a)t[r]||(t[r]=[]),t[r].push(n)}return t}async function mt(e,t){let n=Y(e);if(!n){i("Invalid message ID","error");return}if(!Vn(e,t))try{if(u.has(e)){let a=u.get(e);a.reactions||(a.reactions={}),a.reactions[t]?a.reactions[t].includes(f.id)||a.reactions[t].push(f.id):a.reactions[t]=[f.id],u.set(e,a)}await m(`/messages/${n}/reactions`,"POST",{reaction:t}),await x(e,t,!0,!1),Ee.classList.remove("active")}catch(a){await x(e,t,!1,!1),i(a.message||"Failed to add reaction","error")}}async function Mn(e,t){let n=Y(e);if(!n){i("Invalid message ID","error");return}try{await m(`/messages/${n}/reactions`,"DELETE",{reaction:t}),await x(e,t,!1,!1)}catch(a){await x(e,t,!0,!1),i(a.message||"Failed to remove reaction","error")}}async function x(e,t,n,a=!1){let o=Te(e).querySelector(`.reaction[data-reaction="${t}"]`),s=vt(o);if(a){n?o?de(o,s+1):await Be(e,t,1,!1):o&&(vt(o)-1>=1?de(o,s-1):o.remove());return}n?o?(de(o,s+1),wt(o,n)):await Be(e,t,1,!0):o&&(s>1?(de(o,s-1),wt(o,n)):o.remove())}function Te(e){let t=null;if(t=Tt(e),!t){for(let[a,r]of H.entries())if(r===e&&(t=Tt(a),t))break}if(!t)return;let n=t.querySelector(".message-reactions");if(n)return n}function $n(){let e=Ke.textContent.trim().replace(/\s+/g," ");oe.value=e,Xe.classList.add("active"),oe.focus(),xe()}function ft(){Xe.classList.remove("active")}async function bn(e){try{T();let t=await m("/server/settings","PUT",{name:e});return ke.textContent=e,await l.setItem("serverName",e),ft(),i("Server name updated successfully"),h(),t}catch(t){throw h(),i(t.message||"Failed to update server name","error"),t}}async function Bn(){try{let t=await m("/server/settings","GET");if(t?.name){ke.textContent=t.name,await l.setItem("serverName",t.name);return}}catch(t){console.error("Error loading server name from API:",t)}let e=await l.getItem("serverName");e&&(ke.textContent=e)}async function An(){try{return T(),ie()&&M!=="magic-link"&&(window.location="/"),b()?await N():ye()?(await Me(),await le()):await N()}catch(e){return console.error("Error while checking if authenticated:",e),i("Failed to initialize the application","error"),h(),await N()}}let J="_storage_initialized_";async function Me(e){let t=e||O;I&&console.log("Initializing storage with password",t);try{if(!K)return I&&console.log("Setting up default encryption...",t),await ce(t,!0),!0;if(gt())try{return await ce(t,!1),await l.getItem(J)==="true"}catch(a){return console.error("Failed to decrypt existing data with provided password:",a),!1}else return I&&console.log("Setting up custom encryption...",t),await ce(t,!0),await l.setItem(J,"true"),!0}catch(n){return console.error("Failed to initialize storage:",n),!1}}async function ce(e,t=!0){l=await new MikroSafe(e),_e=!0,t&&await l.setItem(J,"true")}function gt(){let e=Object.keys(localStorage),t=e.includes(J),n=e.includes("token")||e.includes("accessToken");return t&&n}async function xn(e){try{return await Me(e)?await l.getItem(J)==="true":!1}catch(t){return console.error("Error verifying encryption password:",t),!1}}async function ht(e){e?(document.body.classList.remove("light-mode"),Qe.textContent="\u{1F319}",et.textContent="Dark Mode"):(document.body.classList.add("light-mode"),Qe.textContent="\u2600\uFE0F",et.textContent="Light Mode"),await l.setItem("darkMode",e?"true":"false")}async function N(){It(),He.style.display="block",je.style.display="none";let e=ye();if(M==="dev")return b()||e?yt():Rn();if(M==="magic-link"){if(ie())return b()?pt():Nn();if(e){if(b())return pt();await ce(O)}return Pn()}}function Nn(){let{emailParam:e}=ue();V.value=e,ne.click()}function Rn(){re.textContent="Enter your email to sign in.",te.style.display="none",h()}function yt(){re.textContent="Enter your email and encryption key to sign in.",te.style.display="block",h()}function pt(){if(re.textContent="Enter your encryption key to sign in.",ie()){on.getElementsByTagName("label")[0].style.display="none",V.style.display="none";let{emailParam:t}=ue();V.value=t}te.style.display="block",h()}function Pn(){re.textContent="Enter your email to get a magic link.",te.style.display="none",h()}async function Dn(e){let t=await m("/auth/login","POST",{email:e});document.querySelector(".auth-form").style.display="none";let n=document.getElementById("magic-link-sent-form"),a=document.getElementById("magic-link-sent-message");a.textContent=t.message||`Magic link sent to ${e}. Please check your inbox and click the link to continue.`,n.style.display="block"}async function le(){if(f=await At(),!f){h();return}window.history.replaceState({},document.title,window.location.pathname),await Bn(),await U(),mn.textContent=Ne(f.userName),gn.textContent=f.userName,He.style.display="none",je.style.display="flex",await qt();let e=await l.getItem("darkMode")!=="false";await ht(e),h()}async function $e(e){let t=document.querySelector(`.channel-item[data-id="${e.id}"]`);t||(t=document.createElement("div"),t.className="channel-item",t.dataset.id=e.id,t.addEventListener("click",async()=>await F(e.id,e.name)),Q.appendChild(t));let n=W.get(e.id)||0;t.innerHTML="";let a=document.createElement("div");if(a.textContent=e.name,a.className="channel-name",t.appendChild(a),n>0){let r=document.createElement("div");r.className="notification-badge",r.textContent=n>99?"99+":n,t.appendChild(r)}if(e.createdBy===f.id){let r=document.createElement("div");r.className="channel-settings",r.innerHTML="\u2699\uFE0F",r.addEventListener("click",o=>{o.stopPropagation(),zn(e)}),t.appendChild(r)}e.id===v?t.classList.add("active"):t.classList.remove("active")}function be(){let e=document.getElementById("pending-uploads-container"),t=document.getElementById("pending-uploads");if(E.length===0){e.style.display="none";return}e.style.display="block",t.innerHTML="",E.forEach((a,r)=>{let o=document.createElement("div");o.className="pending-upload",o.innerHTML=`
      <img src="${a.preview}" alt="Upload preview">
      <div class="remove-upload" data-index="${r}">&times;</div>
    `,t.appendChild(o)}),document.querySelectorAll(".remove-upload").forEach(a=>{a.addEventListener("click",r=>{let o=Number.parseInt(r.target.dataset.index);jt(o)})})}async function Be(e,t,n,a){let r=Te(e);if(!r)return;let o=document.createElement("div");return o.className=`reaction ${a?"user-reacted":""}`,o.dataset.reaction=t,o.dataset.messageId=e,o.innerHTML=`
        <span class="reaction-reaction">${t}</span>
        <span class="reaction-count">${n}</span>
      `,o.addEventListener("click",async()=>{Un(o)?await Mn(e,t):await mt(e,t)}),r.appendChild(o),o}function vt(e){if(!e)return 0;let t=e.querySelector(".reaction-count");if(t)return Number.parseInt(t.textContent,10)||0}function de(e,t){if(!e)return;let n=e.querySelector(".reaction-count");n&&(n.textContent=t.toString())}function wt(e,t){e&&(e.className=`reaction ${t?"user-reacted":""}`)}function Un(e){if(e)return Array.from(e.classList).includes("user-reacted")}function i(e,t="success"){se.textContent=e,se.className=`toast ${t}`,se.classList.add("show"),setTimeout(()=>{se.classList.remove("show")},3e3)}function T(){Ze.style.display="flex"}function h(){Ze.style.display="none"}function Fn(){We.classList.add("active"),X.focus()}function Et(){We.classList.remove("active"),X.value=""}function On(e){z=e,Ee.classList.add("active")}function qn(){Ee.classList.remove("active"),z=null}function _n(e){j=e.id,ee.value=e.content,Je.classList.add("active"),ee.focus()}function kt(){Je.classList.remove("active"),ee.value="",j=null}function zn(e){L=e,G.value=e.name,Ye.classList.add("active"),G.focus()}function Ae(){Ye.classList.remove("active"),G.value="",L=null}function It(){document.querySelectorAll(".modal-backdrop.active").forEach(t=>t.classList.remove("active")),z=null,j=null,L=null}function ue(){let e=new URLSearchParams(window.location.search),t=e.get("email"),n=e.get("token");return{emailParam:t,tokenParam:n}}async function xe(){try{let e=await m("/users","GET");if(Le.innerHTML="",e.users&&e.users.length>0){let t=[...e.users].sort((n,a)=>n.id===f.id?-1:a.id===f.id?1:0);for(let n of t){let a=document.createElement("div");a.className="user-item",a.dataset.id=n.id,a.innerHTML=`
          <div class="user-avatar">${Ne(n.userName||n.email.split("@")[0])}</div>
          <div class="user-info">
            <div class="user-email">${n.email}</div>
            <div class="user-role ${n.isAdmin?"admin-role":"user-role"}">${n.isAdmin?"Admin":"User"}</div>
            <div class="user-created">Added ${Lt(new Date(n.createdAt))}</div>
          </div>
          ${n.id!==f.id?`
            <div class="user-actions">
              <button class="remove-user" title="Remove User">\u2715</button>
            </div>
          `:""}
        `;let r=a.querySelector(".remove-user");r&&r.addEventListener("click",()=>Hn(n.id,n.email)),Le.appendChild(a)}}else Le.innerHTML='<div class="empty-list">No users added yet</div>'}catch(e){console.error("Error loading users:",e),i("Failed to load users","error")}}async function jn(e,t){try{T();let n=await m("/users/add","POST",{email:e,role:t});h(),n.success&&(i(`User ${e} added successfully!`),xe())}catch(n){h(),i(n.message||"Failed to add user","error")}}async function Hn(e,t){if(confirm(`Are you sure you want to remove user ${t}?`))try{T(),await m(`/users/${e}`,"DELETE"),h(),i(`User ${t} has been removed`),xe()}catch(n){h(),i(n.message||"Failed to remove user","error")}}function Ne(e){return e?e.split(" ").map(t=>t.charAt(0)).join("").toUpperCase():"?"}function St(e){return(e instanceof Date?e:new Date(e)).toLocaleDateString()}function Lt(e){return(e instanceof Date?e:new Date(e)).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}function Wn(e){if(!e||typeof e!="string"||(e=e.trim(),e==="")||e.includes(" ")||e.includes(".."))return!1;let t=e.indexOf("@");if(t===-1)return!1;let n=e.slice(0,t),a=e.slice(t+1);if(n.length===0||a.length===0||!/^[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+$/.test(n))return!1;let o=a.split(".");if(o.length<2)return!1;let s=o[o.length-1];if(s.length<2||!/^[a-zA-Z]+$/.test(s))return!1;for(let c of o)if(c.length===0||!/^[a-zA-Z0-9](?:[a-zA-Z0-9-]*[a-zA-Z0-9])?$/.test(c))return!1;return!0}function Gn(e){return typeof e!="string"?"":e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}function Ct(e){if(!e)return"";let t=e;return t=t.replace(/```([\s\S]*?)```/g,function(n,a){return`<pre><code>${a.trim()}</code></pre>`}),t=t.replace(/(\*\*|__)(.*?)\1/g,"<strong>$2</strong>"),t=t.replace(/(\*|_)(?!\*|_)(.*?)\1/g,"<em>$2</em>"),t=t.replace(/(?:^|\n)((?:(?:- |\* ).*(?:\n|$))+)/gm,function(n,a){let r=a.split(/\n(?=(?:- |\* ))/),o="<ul>";for(let s of r)if(s.trim()){let c=s.replace(/^(?:- |\* )/,"").trim();o+=`<li>${c}</li>`}return o+="</ul>",o}),t=t.replace(/(?:^|\n)((?:(?:\d+\. ).*(?:\n|$))+)/gm,function(n,a){let r=a.split(/\n(?=(?:\d+\. ))/),o="<ol>";for(let s of r)if(s.trim()){let c=s.replace(/^\d+\. /,"").trim();o+=`<li>${c}</li>`}return o+="</ol>",o}),t}function Tt(e){return Array.from(document.querySelectorAll(".message")).find(n=>n.dataset.id===e)}function Vn(e,t){let n=Te(e);return Array.from(n.querySelectorAll(".user-reacted")).map(r=>r.dataset.reaction).some(r=>r===t)}})();})();
