/*
 * MikroChat version 2.0.0
 * Bundle generated on 2026-02-08T11:50:56.446Z
 */
"use strict";(()=>{var Ro=Object.defineProperty;var w=(e,t)=>()=>(e&&(t=e(e=0)),t);var S=(e,t)=>{for(var n in t)Ro(e,n,{get:t[n],enumerable:!0})};var ee,ra=w(()=>{"use strict";ee=class extends Map{constructor(t){super(),this.maxSize=t}get(t){if(!super.has(t))return;let n=super.get(t);return super.delete(t),super.set(t,n),n}set(t,n){if(super.has(t)&&super.delete(t),super.set(t,n),super.size>this.maxSize){let a=super.keys().next().value;super.delete(a)}return this}}});var r,E=w(()=>{"use strict";ra();r={currentChannelForEdit:null,currentUser:null,currentChannelId:null,messageEventSource:null,currentMessageForReaction:null,currentMessageForReactionIsDM:!1,currentMessageForEdit:null,currentMessageForEditIsDM:!1,currentMessageForEditContent:"",currentMessageForEditImages:[],isStorageInitialized:!1,pendingUploads:[],tempIdMap:new Map,messageCache:new ee(2e3),unreadCounts:new Map,storage:null,currentConversationId:null,conversationCache:new ee(200),dmMessageCache:new ee(2e3),dmUnreadCounts:new Map,viewMode:"channel",currentThreadId:null,threadMessageCache:new ee(500),threadPanelOpen:!1,currentMessageForEditIsThread:!1,isOffline:typeof navigator<"u"?!navigator.onLine:!1}});var ot,Gt,sa,Vt,Yt,fe,te,ia,ca,da,la,ua,ma,Kt,Jt,V,pa,Xt,ne,ae,Zt,Qt,he,U,ga,$e,$,oe,fa,H,ha,en,L,ya,wa,z,p,Rr,A,tn,rt,ye,st,nn,it,D,ct,Ae,De,Re,an,on,dt,rn,va,lt,ut,Ea,sn,we,cn,Ia,mt,ve,pt,Ee,Ie,xa,Ne,Ca,Pe,ka,re,gt,Ma,Sa,ba,se,Fe,La,Ta,Ba,Nr,M=w(()=>{"use strict";ot=document.getElementById("add-email-input"),Gt=document.getElementById("add-user-btn"),sa=document.getElementById("add-channel-btn"),Vt=document.getElementById("app-container"),Yt=document.getElementById("auth-container"),fe=document.getElementById("channel-name"),te=document.getElementById("channels-list"),ia=document.getElementById("close-channel-modal"),ca=document.getElementById("close-edit-channel-modal"),da=document.getElementById("close-edit-modal"),la=document.getElementById("close-reaction-modal"),ua=document.getElementById("close-image-preview"),ma=document.getElementById("close-server-settings-modal"),Kt=document.getElementById("create-channel-modal"),Jt=document.getElementById("create-channel-submit"),V=document.getElementById("current-channel-name"),pa=document.getElementById("delete-channel-btn"),Xt=document.getElementById("edit-channel-modal"),ne=document.getElementById("edit-channel-name"),ae=document.getElementById("edit-message-input"),Zt=document.getElementById("edit-message-modal"),Qt=document.getElementById("edit-message-submit"),he=document.getElementById("auth-form-email"),U=document.getElementById("auth-email"),ga=document.getElementById("reaction-picker"),$e=document.getElementById("reaction-picker-modal"),$=document.getElementById("auth-form-encryption"),oe=document.getElementById("encryption-password"),fa=document.getElementById("exit-server-btn"),H=document.getElementById("image-preview-modal"),ha=document.getElementById("image-upload"),en=document.getElementById("loading"),L=document.getElementById("login-btn"),ya=document.getElementById("logout-btn"),wa=document.getElementById("menu-toggle"),z=document.getElementById("message-input"),p=document.getElementById("messages-area"),Rr=document.getElementById("password"),A=document.getElementById("preview-image"),tn=document.getElementById("send-button"),rt=document.getElementById("server-name"),ye=document.getElementById("server-name-input"),st=document.querySelector(".server-name-text"),nn=document.getElementById("server-settings-modal"),it=document.getElementById("sidebar"),D=document.getElementById("auth-form-text"),ct=document.getElementById("theme-switch"),Ae=ct?.querySelector(".theme-switch-icon"),De=ct?.querySelector(".theme-switch-label"),Re=document.getElementById("toast"),an=document.getElementById("update-channel-submit"),on=document.getElementById("update-server-name-btn"),dt=document.getElementById("user-avatar"),rn=document.getElementById("user-dropdown"),va=document.getElementById("user-menu"),lt=document.getElementById("users-list"),ut=document.getElementById("user-name"),Ea=document.getElementById("user-settings-btn"),sn=document.getElementById("user-settings-modal"),we=document.getElementById("user-settings-name"),cn=document.getElementById("user-settings-save-btn"),Ia=document.getElementById("close-user-settings-btn"),mt=document.getElementById("auth-password"),ve=document.getElementById("auth-form-password-confirm"),pt=document.getElementById("auth-password-confirm"),Ee=document.getElementById("auth-form-password"),Ie=document.getElementById("auth-toggle"),xa=document.getElementById("auth-toggle-link"),Ne=document.getElementById("dm-list"),Ca=document.getElementById("start-dm-btn"),Pe=document.getElementById("start-dm-modal"),ka=document.getElementById("close-start-dm-modal"),re=document.getElementById("dm-user-list"),gt=document.getElementById("auth-forgot-password"),Ma=document.getElementById("auth-forgot-password-link"),Sa=document.getElementById("password-reset-sent-form"),ba=document.getElementById("password-reset-sent-message"),se=document.getElementById("oauth-providers"),Fe=document.getElementById("auth-divider"),La=document.getElementById("add-webhook-btn"),Ta=document.getElementById("webhook-name-input"),Ba=document.getElementById("webhook-channel-select"),Nr=document.getElementById("webhooks-list")});var x,R,j,N=w(()=>{"use strict";x="password",R="http://localhost:3000",j="$J2Ek<wp5Wsp+x!FsGb[";console.table([{flag:"AUTH_MODE",setting:x},{flag:"API_BASE_URL",setting:R},{flag:"DEFAULT_PASSWORD",setting:j},{flag:"ENABLE_USER_SPECIFIC_ENCRYPTION",setting:!1},{flag:"ENABLE_OAUTH",setting:!1},{flag:"MAX_CONTENT_LENGTH",setting:1e3}]),console.log(`Has ${window.localStorage.length} items in localStorage`)});var Ua={};S(Ua,{findMessageWithId:()=>xe,formatDate:()=>ft,formatTime:()=>Ce,getInitials:()=>C,getReactionsContainer:()=>ht,hasUserReactedWithEmoji:()=>_e,isValidEmail:()=>dn,parseMarkdown:()=>Oe,sanitizeInput:()=>ln});function C(e){return e?e.split(" ").map(t=>t.charAt(0)).join("").toUpperCase():"?"}function ft(e){return(e instanceof Date?e:new Date(e)).toLocaleDateString()}function Ce(e){return(e instanceof Date?e:new Date(e)).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}function dn(e){if(!e||typeof e!="string"||(e=e.trim(),e==="")||e.includes(" ")||e.includes(".."))return!1;let t=e.indexOf("@");if(t===-1)return!1;let n=e.slice(0,t),a=e.slice(t+1);if(n.length===0||a.length===0||!/^[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+$/.test(n))return!1;let s=a.split(".");if(s.length<2)return!1;let c=s[s.length-1];if(c.length<2||!/^[a-zA-Z]+$/.test(c))return!1;for(let i of s)if(i.length===0||!/^[a-zA-Z0-9](?:[a-zA-Z0-9-]*[a-zA-Z0-9])?$/.test(i))return!1;return!0}function ln(e){return typeof e!="string"?"":e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}function Oe(e){if(!e)return"";let t=e;return t=t.replace(/```([\s\S]*?)```/g,function(n,a){return`<pre><code>${a.trim()}</code></pre>`}),t=t.replace(/(\*\*|__)(.*?)\1/g,"<strong>$2</strong>"),t=t.replace(/(\*|_)(?!\*|_)(.*?)\1/g,"<em>$2</em>"),t=t.replace(/(?:^|\n)((?:(?:- |\* ).*(?:\n|$))+)/gm,function(n,a){let o=a.split(/\n(?=(?:- |\* ))/),s="<ul>";for(let c of o)if(c.trim()){let i=c.replace(/^(?:- |\* )/,"").trim();s+=`<li>${i}</li>`}return s+="</ul>",s}),t=t.replace(/(?:^|\n)((?:(?:\d+\. ).*(?:\n|$))+)/gm,function(n,a){let o=a.split(/\n(?=(?:\d+\. ))/),s="<ol>";for(let c of o)if(c.trim()){let i=c.replace(/^\d+\. /,"").trim();s+=`<li>${i}</li>`}return s+="</ol>",s}),t}function xe(e){return Array.from(document.querySelectorAll(".message")).find(n=>n.dataset.id===e)}function _e(e,t){let n=ht(e);return n?Array.from(n.querySelectorAll(".user-reacted")).map(o=>o.dataset.reaction).some(o=>o===t):!1}function ht(e){let t=null;if(t=xe(e),!t){for(let[a,o]of r.tempIdMap.entries())if(o===e&&(t=xe(a),t))break}if(!t)return null;let n=t.querySelector(".message-reactions");return n||null}var T=w(()=>{"use strict";E()});async function ie(e){let t=e||j;console.log("Initializing storage with password",t);try{if(!!1)return console.log("Setting up default encryption...",t),await ke(t,!0),!0;if(un())try{return await ke(t,!1),await r.storage.getItem(qe)==="true"}catch(a){return console.error("Failed to decrypt existing data with provided password:",a),!1}else return console.log("Setting up custom encryption...",t),await ke(t,!0),await r.storage.setItem(qe,"true"),!0}catch(n){return console.error("Failed to initialize storage:",n),!1}}async function ke(e,t=!0){let n=await new MikroSafe(e);r.storage=n,r.isStorageInitialized=!0,t&&await r.storage.setItem(qe,"true")}function un(){let e=Object.keys(localStorage),t=e.includes(qe),n=e.includes("token")||e.includes("accessToken");return t&&n}async function $a(e){try{return await ie(e)?await r.storage.getItem(qe)==="true":!1}catch(t){return console.error("Error verifying encryption password:",t),!1}}var qe,He=w(()=>{"use strict";E();N();qe="_storage_initialized_"});function W(){let e=new URLSearchParams(window.location.search),t=e.get("email"),n=e.get("token"),a=e.get("reset")==="true"||window.location.pathname==="/reset";return{emailParam:t,tokenParam:n,resetParam:a}}var wt=w(()=>{"use strict"});function Y(){let{emailParam:e,tokenParam:t}=W();return e&&t}async function Aa(){try{let{emailParam:e,tokenParam:t}=W();if(!e||!t)return!1;let n=await Da({email:e,token:t}),{accessToken:a,refreshToken:o}=n;return await r.storage.setItem("accessToken",a),await r.storage.setItem("refreshToken",o),!0}catch(e){return console.log("Magic link verification error:",e),!1}}var vt=w(()=>{"use strict";E();wt();F()});async function Et(e){e?(document.body.classList.remove("light-mode"),Ae&&(Ae.textContent="\u{1F319}"),De&&(De.textContent="Dark Mode")):(document.body.classList.add("light-mode"),Ae&&(Ae.textContent="\u2600\uFE0F"),De&&(De.textContent="Light Mode")),await r.storage.setItem("darkMode",e?"true":"false")}var mn=w(()=>{"use strict";E();M()});var Oa={};S(Oa,{convertBlobToBase64:()=>xt,formatFileSize:()=>pn,generateFileHash:()=>Pa,generateThumbnail:()=>Na,handleAddImages:()=>It,hashSimple:()=>Fa,openImagePreview:()=>gn,removePendingUpload:()=>No,resizeAndCompressImage:()=>Ra});async function It(e){for(let t of e){if(!t.type.match("image.*")){d("Only image files are supported","error");continue}try{let n=await Pa(t);if(r.pendingUploads.some(l=>l.fileHash===n)){d("This image is already in your pending uploads","info");continue}let o=await Ra(t),s=await Na(o.blob),c=Date.now(),i=t.name.split(".").pop().toLowerCase(),u=`${c}.${i}`;o.usedOriginal?d("Used original image (no compression needed)","info"):o.compressionRatio>0?d(`Image compressed by ${o.compressionRatio.toFixed(0)}%`,"info"):o.compressionRatio<=0&&d(`Image processed (size increased by ${Math.abs(o.compressionRatio).toFixed(0)}%)`,"info"),r.pendingUploads.push({fileName:u,fileHash:n,blob:o.blob,thumbnailBlob:s,preview:URL.createObjectURL(o.blob)}),Me()}catch(n){console.error("Error processing image:",n),d("Failed to process image","error")}}}function No(e){URL.revokeObjectURL(r.pendingUploads[e].preview),r.pendingUploads.splice(e,1),Me()}function Ra(e){return new Promise((t,n)=>{console.log(`Original image: ${e.name}, Size: ${pn(e.size)}`);let a=new FileReader;a.onload=function(o){let s=new Image;s.onload=function(){let c=s.width,i=s.height,u=`${c}x${i}`,l=c,g=i,h=1200;l>g&&l>h?(g=Math.round(g*h/l),l=h):g>h&&(l=Math.round(l*h/g),g=h);let I=c!==l||i!==g,_=document.createElement("canvas");_.width=l,_.height=g,_.getContext("2d").drawImage(s,0,0,l,g);let q=.7,pe=e.type,nt=e.name.split(".").pop().toLowerCase();nt==="png"?(pe="image/png",q=.8):nt==="jpg"||nt==="jpeg"?(pe="image/jpeg",q=.7):nt==="webp"&&(pe="image/webp",q=.75),_.toBlob(ge=>{if(ge)if(ge.size>=e.size&&!I){console.log("Processed image is larger than original. Using original file instead.");let at={blob:e,originalSize:e.size,newSize:e.size,compressionRatio:0,originalDimensions:u,newDimensions:u,usedOriginal:!0};t(at)}else{let at=((1-ge.size/e.size)*100).toFixed(2);console.log(`Processed image: ${l}x${g} (from ${u})`),console.log(`New size: ${pn(ge.size)}, Reduction: ${at}%`);let Do={blob:ge,originalSize:e.size,newSize:ge.size,compressionRatio:Number.parseFloat(at),originalDimensions:u,newDimensions:`${l}x${g}`,usedOriginal:!1};t(Do)}else n(new Error("Failed to create image blob"))},pe,q)},s.onerror=function(){n(new Error("Failed to load image"))},s.src=o.target.result},a.onerror=function(){n(new Error("Failed to read file"))},a.readAsDataURL(e)})}function Na(e){return new Promise((t,n)=>{let a=URL.createObjectURL(e),o=new Image;o.onload=function(){URL.revokeObjectURL(a);let s=o.width,c=o.height,i=400;s>c&&s>i?(c=Math.round(c*i/s),s=i):c>i&&(s=Math.round(s*i/c),c=i);let u=document.createElement("canvas");u.width=s,u.height=c,u.getContext("2d").drawImage(o,0,0,s,c),u.toBlob(g=>{g?t(g):n(new Error("Failed to create thumbnail"))},"image/jpeg",.6)},o.onerror=()=>{URL.revokeObjectURL(a),n(new Error("Failed to load image for thumbnail"))},o.src=a})}function pn(e){return e<1024?`${e} bytes`:e<1048576?`${(e/1024).toFixed(2)} KB`:`${(e/1048576).toFixed(2)} MB`}function xt(e){return new Promise((t,n)=>{let a=new FileReader;a.onloadend=()=>{let o=a.result.split(",")[1];t(o)},a.onerror=n,a.readAsDataURL(e)})}async function Pa(e){return new Promise(t=>{let n=new FileReader;n.onload=a=>{let o=a.target.result,s=Fa(o);t(s)},n.readAsArrayBuffer(e)})}function Fa(e){let t=new DataView(e),n=0,a=Math.max(1,Math.floor(e.byteLength/1e3));for(let o=0;o<e.byteLength;o+=a){let s=o+3<e.byteLength?t.getUint32(o):t.getUint8(o);n=(n<<5)-n+s,n|=0}return n.toString(16)}async function gn(e){A.src="",H.classList.add("active"),A.style.display="none";let t=document.createElement("div");t.className="loading-spinner",H.querySelector(".image-preview-container").appendChild(t),await b().then(n=>{fetch(e,{method:"GET",headers:{Authorization:`Bearer ${n}`}}).then(a=>{if(!a.ok)throw new Error("Image fetch failed");return a.blob()}).then(a=>{let o=URL.createObjectURL(a);A.src=o,A.style.display="block";let s=H.querySelector(".loading-spinner");s&&s.remove(),A.setAttribute("data-object-url",o)}).catch(a=>{console.error("Error fetching preview image:",a),A.style.display="none",H.querySelector(".image-preview-container").innerHTML='<div class="image-error">Failed to load image</div>'})})}var Ct=w(()=>{"use strict";E();M();N();y();F()});var _a={};S(_a,{addReaction:()=>St,processReactions:()=>fn,removeReaction:()=>hn,updateReactionInUI:()=>K});function fn(e){let t={};if(!e)return t;for(let[n,a]of Object.entries(e)){if(!a)return;for(let o of a)t[o]||(t[o]=[]),t[o].push(n)}return t}async function St(e,t){let n=Le(e);if(!n){d("Invalid message ID","error");return}if(!_e(e,t))try{if(r.messageCache.has(e)){let a=r.messageCache.get(e);a.reactions||(a.reactions={}),a.reactions[t]?a.reactions[t].includes(r.currentUser.id)||a.reactions[t].push(r.currentUser.id):a.reactions[t]=[r.currentUser.id],r.messageCache.set(e,a)}await m(`/messages/${n}/reactions`,"POST",{reaction:t}),await K(e,t,!0,!1),$e.classList.remove("active")}catch(a){await K(e,t,!1,!1),d(a.message||"Failed to add reaction","error")}}async function hn(e,t){let n=Le(e);if(!n){d("Invalid message ID","error");return}try{await m(`/messages/${n}/reactions`,"DELETE",{reaction:t}),await K(e,t,!1,!1)}catch(a){await K(e,t,!0,!1),d(a.message||"Failed to remove reaction","error")}}async function K(e,t,n,a=!1){let o=Po(e);if(!o)return;let s=o.querySelector(`.reaction[data-reaction="${t}"]`),c=kt(s);if(a){n?s?Se(s,c+1):await be(e,t,1,!1):s&&(kt(s)-1>=1?Se(s,c-1):s.remove());return}n?s?(Se(s,c+1),Mt(s,n)):await be(e,t,1,!0):s&&(c>1?(Se(s,c-1),Mt(s,n)):s.remove())}function Po(e){let t=null;if(t=xe(e),!t){for(let[a,o]of r.tempIdMap.entries())if(o===e&&(t=xe(a),t))break}if(!t)return;let n=t.querySelector(".message-reactions");if(n)return n}var ze=w(()=>{"use strict";E();M();v();y();T();J()});var Va={};S(Va,{appendDMMessage:()=>En,deleteDMMessage:()=>vn,loadDMMessagesForConversation:()=>bt,removeDMMessageFromView:()=>xn,renderDMMessage:()=>Ga,renderDMMessages:()=>za,sendDMMessage:()=>qo,updateDMMessage:()=>Tt,updateDMMessageInView:()=>In,uploadDMImage:()=>Ho});async function bt(e,t){if(p)try{let n=`/conversations/${e}/messages?limit=${qa}`;t&&(n+=`&before=${t}`);let o=(await m(n)).messages||[];if(!t)r.dmMessageCache.set(e,o),za(o);else{let s=r.dmMessageCache.get(e)||[];r.dmMessageCache.set(e,[...o,...s]),Fo(o)}o.length>=qa?Oo(e,o[0].id):wn()}catch(n){console.error("Failed to load DM messages:",n),t||(p.innerHTML='<div class="empty-state"><div class="empty-state-icon">!</div><h3>Failed to load messages</h3></div>')}}function Fo(e){if(!p||e.length===0)return;wn();let t=ja(e),n=Object.keys(t).sort((a,o)=>{let s=t[a][0].createdAt,c=t[o][0].createdAt;return s-c});for(let a of n){let o=t[a];if(!Array.from(p.querySelectorAll(".message-date-divider")).find(c=>c.textContent===a)){let c=document.createElement("div");c.className="message-date-divider",c.textContent=a,p.appendChild(c)}for(let c of o){let i=Lt(c);p.appendChild(i)}}}function Oo(e,t){wn();let n=document.createElement("button");n.className="load-more-btn",n.id="load-more-dm-messages",n.textContent="Load older messages",n.addEventListener("click",async()=>{yn||(yn=!0,n.textContent="Loading...",await bt(e,t),yn=!1)}),p.appendChild(n)}function wn(){let e=document.getElementById("load-more-dm-messages");e&&e.remove()}function Lt(e){let t=document.createElement("div");return t.innerHTML=Ga(e),t.firstElementChild}function za(e){if(!p)return;if(e.length===0){p.innerHTML=`
      <div class="empty-state">
        <div class="empty-state-icon">@</div>
        <h3>Start the conversation</h3>
        <p>Send a message to start chatting</p>
      </div>
    `;return}p.innerHTML="";let t=ja(e),n=Object.keys(t).sort((a,o)=>{let s=t[a][0].createdAt;return t[o][0].createdAt-s});for(let a of n){let o=document.createElement("div");o.className="message-date-divider",o.textContent=a,p.appendChild(o);let s=t[a];for(let c of s){let i=Lt(c);p.prepend(i)}}Bt()}function ja(e){let t={};for(let n of e){let a=new Date(n.createdAt),o=Wa(a);t[o]||(t[o]=[]),t[o].push(n)}return t}function Wa(e){let t=new Date,n=new Date(t);return n.setDate(n.getDate()-1),e.toDateString()===t.toDateString()?"Today":e.toDateString()===n.toDateString()?"Yesterday":e.toLocaleDateString("en-US",{weekday:"long",month:"long",day:"numeric"})}function Ga(e){let t=e.author.id===r.currentUser?.id,n=C(e.author.userName),a=Ge(e.createdAt),o=We(e.content),s="";if(e.images&&e.images.length>0){s='<div class="message-images-container">';for(let u of e.images)s+=`
        <div class="message-image-container">
          <div class="image-wrapper">
            ${t?`<span class="remove-image-btn" data-message-id="${e.id}" data-image="${u}">&times;</span>`:""}
            <img src="/conversations/${r.currentConversationId}/messages/image/${u}?size=thumb" alt="Image" class="message-image" loading="lazy" data-image="${u}">
          </div>
        </div>
      `;s+="</div>"}let c=_o(e),i="";return t&&(i=`
      <div class="message-actions">
        <button class="message-edit" data-message-id="${e.id}" data-is-dm="true">Edit</button>
        <button class="message-delete" data-message-id="${e.id}" data-is-dm="true">Delete</button>
      </div>
    `),`
    <div class="message" data-id="${e.id}" data-is-dm="true">
      <div class="message-avatar">${n}</div>
      <div class="message-content">
        <div class="message-header">
          <span class="message-author">${e.author.userName}</span>
          <span class="message-time">${a}</span>
        </div>
        <div class="message-text">${o}</div>
        ${s}
        ${c}
        ${i}
      </div>
    </div>
  `}function _o(e){if(!e.reactions||Object.keys(e.reactions).length===0)return`
      <div class="message-reactions">
        <div class="add-reaction" data-message-id="${e.id}">+</div>
      </div>
    `;let t={},n={};for(let[o,s]of Object.entries(e.reactions))for(let c of s)t[c]||(t[c]=0,n[c]=[]),t[c]++,n[c].push(o);let a='<div class="message-reactions">';for(let[o,s]of Object.entries(t)){let c=n[o].includes(r.currentUser?.id);a+=`
      <div class="reaction ${c?"user-reacted":""}"
           data-message-id="${e.id}"
           data-reaction="${o}">
        <span class="reaction-emoji">${o}</span>
        <span class="reaction-count">${s}</span>
      </div>
    `}return a+=`<div class="add-reaction" data-message-id="${e.id}">+</div>`,a+="</div>",a}async function qo(e,t=[]){if(r.currentConversationId)try{let n=await m(`/conversations/${r.currentConversationId}/messages`,"POST",{content:e,images:t});z&&(z.value="",z.style.height="auto"),r.pendingUploads=[];let a=document.getElementById("pending-uploads-container"),o=document.getElementById("pending-uploads");return a&&(a.style.display="none"),o&&(o.innerHTML=""),n.message}catch(n){throw console.error("Failed to send DM:",n),d(n.message||"Failed to send message","error"),n}}async function Ho(e){if(!r.currentConversationId)return null;try{let t=await Ha(e.blob),n={filename:e.name,image:t};return e.thumbnailBlob&&(n.thumbnail=await Ha(e.thumbnailBlob)),(await m(`/conversations/${r.currentConversationId}/messages/image`,"POST",n)).filename}catch(t){return console.error("Failed to upload DM image:",t),d("Failed to upload image","error"),null}}function Ha(e){return new Promise((t,n)=>{let a=new FileReader;a.onload=()=>{let o=a.result.split(",")[1];t(o)},a.onerror=n,a.readAsDataURL(e)})}async function vn(e){if(r.currentConversationId)try{await m(`/conversations/${r.currentConversationId}/messages/${e}`,"DELETE"),d("Message deleted","success")}catch(t){console.error("Failed to delete DM:",t),d(t.message||"Failed to delete message","error")}}async function Tt(e,t,n){if(r.currentConversationId)try{let a=await m(`/conversations/${r.currentConversationId}/messages/${e}`,"PUT",{content:t,images:n});return d("Message updated","success"),a.message}catch(a){throw console.error("Failed to update DM:",a),d(a.message||"Failed to update message","error"),a}}function En(e){if(!p||r.viewMode!=="dm"||r.currentConversationId!==e.channelId||p.querySelector(`.message[data-id="${e.id}"]`))return;let n=r.dmMessageCache.get(e.channelId)||[];n.push(e),r.dmMessageCache.set(e.channelId,n),p.querySelector(".empty-state")&&(p.innerHTML="");let o=Wa(new Date),s=p.querySelector(".message-date-divider");if(!s||s.textContent!==o){let i=document.createElement("div");i.className="message-date-divider",i.textContent=o,p.insertBefore(i,p.firstChild)}let c=Lt(e);p.insertBefore(c,p.firstChild),Bt()}function In(e){if(!p||r.viewMode!=="dm"||r.currentConversationId!==e.channelId)return;let t=p.querySelector(`.message[data-id="${e.id}"]`);if(!t)return;let n=r.dmMessageCache.get(e.channelId)||[],a=n.findIndex(o=>o.id===e.id);a!==-1&&(n[a]=e,r.dmMessageCache.set(e.channelId,n)),t.replaceWith(Lt(e))}function xn(e,t){if(!p||r.viewMode!=="dm"||r.currentConversationId!==t)return;let n=p.querySelector(`.message[data-id="${e}"]`);n&&n.remove();let o=(r.dmMessageCache.get(t)||[]).filter(s=>s.id!==e);r.dmMessageCache.set(t,o),o.length===0&&(p.innerHTML=`
      <div class="empty-state">
        <div class="empty-state-icon">@</div>
        <h3>Start the conversation</h3>
        <p>Send a message to start chatting</p>
      </div>
    `)}var qa,yn,je=w(()=>{"use strict";E();M();y();v();J();T();qa=50,yn=!1});var ce={};S(ce,{appendThreadReply:()=>Ko,closeThread:()=>Ja,deleteThreadReply:()=>Za,loadThreadReplies:()=>kn,openThread:()=>Ka,removeThreadReplyFromView:()=>Xo,sendThreadReply:()=>Xa,updateThreadBadge:()=>Zo,updateThreadReply:()=>Wo,updateThreadReplyInView:()=>Jo});async function Ka(e){r.currentThreadId=e,r.threadPanelOpen=!0,Go().classList.add("active");let n=r.messageCache.get(e);Vo(n),await kn(e)}function Ja(){r.currentThreadId=null,r.threadPanelOpen=!1;let e=document.getElementById("thread-panel");e&&e.classList.remove("active")}async function kn(e,t){let n=document.getElementById("thread-messages");if(n)try{let a=`/messages/${e}/thread?limit=${Ya}`;t&&(a+=`&before=${t}`);let s=(await m(a)).replies||[];if(!t)r.threadMessageCache.set(e,s),Yo(s);else{let c=r.threadMessageCache.get(e)||[];r.threadMessageCache.set(e,[...s,...c]),zo(s)}s.length>=Ya?jo(e,s[0].id):Mn()}catch(a){console.error("Failed to load thread replies:",a),t||(n.innerHTML='<div class="empty-state"><h3>Failed to load replies</h3></div>')}}function zo(e){let t=document.getElementById("thread-messages");if(!t||e.length===0)return;Mn();let n="";for(let a of e)n+=Ut(a);t.insertAdjacentHTML("afterbegin",n)}function jo(e,t){Mn();let n=document.getElementById("thread-messages");if(!n)return;let a=document.createElement("button");a.className="load-more-btn",a.id="load-more-thread-replies",a.textContent="Load older replies",a.addEventListener("click",async()=>{Cn||(Cn=!0,a.textContent="Loading...",await kn(e,t),Cn=!1)}),n.insertBefore(a,n.firstChild)}function Mn(){let e=document.getElementById("load-more-thread-replies");e&&e.remove()}async function Xa(e){if(!(!r.currentThreadId||!e.trim()))try{await m(`/messages/${r.currentThreadId}/thread`,"POST",{content:e});let t=document.getElementById("thread-message-input");t&&(t.value="")}catch(t){console.error("Failed to send thread reply:",t),d(t.message||"Failed to send reply","error")}}async function Za(e){if(r.currentThreadId&&confirm("Are you sure you want to delete this reply?"))try{await m(`/messages/${r.currentThreadId}/thread/${e}`,"DELETE"),d("Reply deleted","success")}catch(t){console.error("Failed to delete thread reply:",t),d(t.message||"Failed to delete reply","error")}}async function Wo(e,t){if(r.currentThreadId)try{await m(`/messages/${r.currentThreadId}/thread/${e}`,"PUT",{content:t}),d("Reply updated","success")}catch(n){console.error("Failed to update thread reply:",n),d(n.message||"Failed to update reply","error")}}function Go(){let e=document.getElementById("thread-panel");if(e?.dataset.initialized)return e;if(!e){e=document.createElement("div"),e.id="thread-panel",e.className="thread-panel";let t=document.getElementById("app-container");t&&t.appendChild(e)}return e.innerHTML=`
    <div class="thread-header" id="thread-header">
      <div class="thread-title">Thread</div>
      <button class="close-thread" id="close-thread-btn">&times;</button>
    </div>
    <div class="thread-parent" id="thread-parent"></div>
    <div class="thread-divider">Replies</div>
    <div class="thread-messages" id="thread-messages"></div>
    <div class="thread-input-area">
      <textarea class="message-input" id="thread-message-input" placeholder="Reply in thread..."></textarea>
      <button class="send-button" id="thread-send-button">&rarr;</button>
    </div>
  `,e.dataset.initialized="true",document.getElementById("close-thread-btn").addEventListener("click",Ja),document.getElementById("thread-send-button").addEventListener("click",()=>{let t=document.getElementById("thread-message-input");t.value.trim()&&Xa(t.value)}),document.getElementById("thread-message-input").addEventListener("keydown",t=>{t.key==="Enter"&&!t.shiftKey&&(t.preventDefault(),document.getElementById("thread-send-button").click())}),document.getElementById("thread-messages").addEventListener("click",async t=>{let n=t.target.closest(".thread-reply-delete");if(n){let o=n.dataset.replyId;await Za(o);return}let a=t.target.closest(".thread-reply-edit");if(a){let o=a.dataset.replyId,c=t.target.closest(".thread-reply")?.querySelector(".message-text")?.textContent||"";le({id:o,content:c}),r.currentMessageForEdit=o,r.currentMessageForEditIsThread=!0;return}}),e}function Vo(e){let t=document.getElementById("thread-parent");if(!t||!e)return;let n=C(e.author?.userName||"Unknown"),a=Ge(e.timestamp||e.createdAt),o=We(e.content);t.innerHTML=`
    <div class="message thread-parent-message">
      <div class="message-avatar">${n}</div>
      <div class="message-content">
        <div class="message-header">
          <span class="message-author">${e.author?.userName||"Unknown"}</span>
          <span class="message-time">${a}</span>
        </div>
        <div class="message-text">${o}</div>
      </div>
    </div>
  `}function Yo(e){let t=document.getElementById("thread-messages");if(!t)return;if(e.length===0){t.innerHTML=`
      <div class="empty-state">
        <p>No replies yet. Start the conversation!</p>
      </div>
    `;return}let n="";for(let a of e)n+=Ut(a);t.innerHTML=n}function Ut(e){let t=e.author.id===r.currentUser?.id,n=C(e.author.userName),a=Ge(e.timestamp||e.createdAt),o=We(e.content),s="";return t&&(s=`
      <div class="message-actions">
        <button class="message-edit thread-reply-edit" data-reply-id="${e.id}">Edit</button>
        <button class="message-delete thread-reply-delete" data-reply-id="${e.id}">Delete</button>
      </div>
    `),`
    <div class="message thread-reply" data-reply-id="${e.id}">
      <div class="message-avatar">${n}</div>
      <div class="message-content">
        <div class="message-header">
          <span class="message-author">${e.author.userName}</span>
          <span class="message-time">${a}</span>
        </div>
        <div class="message-text">${o}</div>
        ${s}
      </div>
    </div>
  `}function Ko(e){if(!r.threadPanelOpen||r.currentThreadId!==e.threadId)return;let t=document.getElementById("thread-messages");if(!t)return;let n=t.querySelector(".empty-state");if(n&&n.remove(),t.querySelector(`[data-reply-id="${e.id}"]`))return;let a=r.threadMessageCache.get(e.threadId)||[];a.push(e),r.threadMessageCache.set(e.threadId,a);let o=Ut(e);t.insertAdjacentHTML("beforeend",o),t.scrollTop=t.scrollHeight}function Jo(e){if(!r.threadPanelOpen||r.currentThreadId!==e.threadId)return;let t=document.querySelector(`[data-reply-id="${e.id}"]`);if(!t)return;let n=Ut(e),a=document.createElement("div");a.innerHTML=n,t.replaceWith(a.firstElementChild)}function Xo(e,t){if(!r.threadPanelOpen||r.currentThreadId!==t)return;let n=document.querySelector(`[data-reply-id="${e}"]`);n&&n.remove();let o=(r.threadMessageCache.get(t)||[]).filter(s=>s.id!==e);if(r.threadMessageCache.set(t,o),o.length===0){let s=document.getElementById("thread-messages");s&&(s.innerHTML='<div class="empty-state"><p>No replies yet. Start the conversation!</p></div>')}}function Zo(e,t){let n=document.querySelector(`.message[data-id="${e}"]`);if(!n)return;let a=n.querySelector(".thread-badge");if(!t||t.replyCount===0){a&&a.remove();return}if(!a){a=document.createElement("div"),a.className="thread-badge",a.addEventListener("click",()=>Ka(e));let c=n.querySelector(".message-reactions");c&&c.parentNode.insertBefore(a,c.nextSibling)}let o=t.replyCount===1?"1 reply":`${t.replyCount} replies`,s=t.lastReplyBy?.userName||"Someone";a.innerHTML=`<span class="thread-badge-count">${o}</span> <span class="thread-badge-last">Last reply by ${s}</span>`}var Ya,Cn,de=w(()=>{"use strict";E();v();y();J();T();Ya=50,Cn=!1});async function to(e){let t=ln(e);if(!(!t.trim()&&r.pendingUploads.length===0)){if(t.length>1e3){d(`Message too long. Your message is ${t.length} characters long and we support up to ${1e3} characters.`,"error");return}if(r.viewMode==="dm"&&r.currentConversationId){let{sendDMMessage:n,uploadDMImage:a}=await Promise.resolve().then(()=>(je(),Va));try{let o=[];if(r.pendingUploads.length>0)for(let s of r.pendingUploads){let c=await a({name:s.fileName,blob:s.blob,thumbnailBlob:s.thumbnailBlob});c&&o.push(c),URL.revokeObjectURL(s.preview)}await n(t,o)}catch(o){d(o.message||"Failed to send message","error")}return}try{z.value="";let n=`temp-${Date.now()}`,a=p.querySelector(".empty-state");a&&a.remove();let o={content:t};r.pendingUploads.length>0&&(o.images=[]);let s=await m(`/channels/${r.currentChannelId}/messages`,"POST",o);if(!s.message?.id)throw new Error("Failed to create message");let c=s.message.id;r.tempIdMap.set(n,c),r.messageCache.delete(n),r.messageCache.set(c,{...s.message,content:s.message.content}),ao(n,c),r.pendingUploads.length>0&&(await Qo(c),await Ln(c,r.pendingUploads))}catch(n){d(n.message||"Failed to send message","error")}}}async function Qo(e){try{k();let t=await b(),n={"Content-Type":"application/json"};t&&(n.Authorization=`Bearer ${t}`);let a=[],o=new Set;for(let s of r.pendingUploads){if(o.has(s.fileHash)){console.log(`Skipping duplicate image with hash: ${s.fileHash}`),URL.revokeObjectURL(s.preview);continue}o.add(s.fileHash);let c=await xt(s.blob),i=s.thumbnailBlob?await xt(s.thumbnailBlob):void 0,u={filename:s.fileName,image:c};i&&(u.thumbnail=i);let l=await m(`/channels/${r.currentChannelId}/messages/image`,"POST",u),{filename:g}=l;a.push(g),URL.revokeObjectURL(s.preview)}if(a.length>0&&(await m(`/messages/${e}`,"PUT",{images:a}),r.messageCache.has(e))){let s=r.messageCache.get(e);s.images=a,r.messageCache.set(e,s)}r.pendingUploads=[],Me(),f(),a.length>0&&d("Images uploaded successfully")}catch(t){f(),d(t.message||"Failed to upload images","error")}}async function $t(e){if(document.querySelector(`.message[data-id="${e.id}"]`))return;if(!e.id.startsWith("temp-")){let a=document.querySelectorAll(".message");for(let o of a){let s=o.dataset.authorId===e.author.id,c=o.querySelector(".message-text")?.textContent===e.content,i=o.dataset.id.startsWith("temp-");if(s&&c&&i){console.log(`Found matching temp message, updating ID from ${o.dataset.id} to ${e.id}`),ao(o.dataset.id,e.id),r.messageCache.delete(o.dataset.id),r.messageCache.set(e.id,e),r.tempIdMap.set(o.dataset.id,e.id);return}}}r.messageCache.set(e.id,e);let t=ft(new Date(e.timestamp||e.createdAt));nr(t);let n=document.createElement("div");n.className="message",n.dataset.id=e.id,n.dataset.authorId=e.author.id,n.dataset.date=t,n.innerHTML=er(e),ar(e,n),p.prepend(n),await tr(e),e.images&&e.images.length>0&&await Ln(e.id,e.images)}async function Ln(e,t){let n=document.querySelector(`.message[data-id="${e}"]`);if(n){let a=n.querySelector(".message-images-container");if(!a){let o=n.querySelector(".message-content");a=document.createElement("div"),a.className="message-images-container";let s=n.querySelector(".message-reactions");o.insertBefore(a,s)}for(let o of t){let s=`${R}/channels/${r.currentChannelId}/messages/image/${o}`,c=`img-container-${e}-${o}`,i=document.createElement("div");i.id=c,i.className="message-image-container",a.appendChild(i),await Dn(s,c,e,o)}}}function er(e){let t="Unknown User";e.author?.userName?t=e.author.userName:e.author.id===r.currentUser.id&&(t=r.currentUser.userName);let n=C(t),a=e.timestamp||e.createdAt,o=Ce(new Date(a)),s="";if(e.content){let i=Oe(e.content);i=$n(i),i=An(i),s=`<div class="message-text">${i}</div>`}let c=e.threadMeta?`<div class="thread-badge" data-thread-id="${e.id}">
        <span class="thread-badge-count">${e.threadMeta.replyCount} ${e.threadMeta.replyCount===1?"reply":"replies"}</span>
        <span class="thread-badge-last">Last reply by ${e.threadMeta.lastReplyBy?.userName||"Someone"}</span>
      </div>`:"";return`
  <div class="message-avatar">${n}</div>
  <div class="message-content">
    <div class="message-header">
      <span class="message-author">${t}</span>
      ${e.author?.isBot?'<span class="bot-badge">BOT</span>':""}
      <span class="message-time">${o}</span>
    </div>
    ${s}
    <div class="message-images-container"></div>
    <div class="message-reactions"></div>
    ${c}
    <div class="message-actions">
      ${e.author.id===r.currentUser?.id?`
        <button class="message-edit" data-id="${e.id}">Edit</button>
        <button class="message-delete" data-id="${e.id}">Delete</button>
      `:e.author?.isBot&&r.currentUser?.isAdmin?`<button class="message-delete" data-id="${e.id}">Delete</button>`:""}
      <div class="add-reaction" data-id="${e.id}">+ Add Reaction</div>
      <div class="start-thread" data-id="${e.id}">Reply</div>
    </div>
  </div>
`}async function tr(e){if(e.reactions&&Object.keys(e.reactions).length>0){let t=fn(e.reactions);for(let[n,a]of Object.entries(t)){let o=a.includes(r.currentUser.id);await be(e.id,n,a.length,o)}}}function nr(e){let t=!1,n=document.querySelectorAll(".message-date-divider");for(let a of n)if(a.textContent===e){t=!0;break}if(!t){let a=document.createElement("div");a.className="message-date-divider",a.textContent=e,p.prepend(a)}}function ar(e,t){let n=t.querySelector(".message-edit");n&&n.addEventListener("click",()=>le(e));let a=t.querySelector(".message-delete");a&&a.addEventListener("click",()=>rr(e.id));let o=t.querySelector(".add-reaction");o&&o.addEventListener("click",()=>Ve(e.id));let s=t.querySelector(".start-thread");s&&s.addEventListener("click",async()=>{let{openThread:i}=await Promise.resolve().then(()=>(de(),ce));i(e.id)});let c=t.querySelector(".thread-badge");c&&c.addEventListener("click",async()=>{let{openThread:i}=await Promise.resolve().then(()=>(de(),ce));i(e.id)})}async function Tn(e,t){try{t||(r.messageCache.clear(),p.innerHTML="");let n=`/channels/${e}/messages?limit=${eo}`;t&&(n+=`&before=${t}`);let{messages:a}=await m(n);if(!a||a.length===0){t||no(),bn();return}let o={};for(let i of a){let u=ft(new Date(i.createdAt));r.messageCache.set(i.id,i),o[u]||(o[u]=[]),o[u].push(i)}let s=Object.keys(o).sort((i,u)=>new Date(u)-new Date(i)),c=document.querySelectorAll(".message-date-divider");for(let i of s){if(!Array.from(c).some(l=>l.textContent===i)){let l=document.createElement("div");l.className="message-date-divider",l.textContent=i,p.appendChild(l)}for(let l of o[i])await $t(l)}a.length>=eo?or(e,a[0].id):bn()}catch(n){console.error("Error loading messages:",n),d("Failed to load messages","error")}}function or(e,t){bn();let n=document.createElement("button");n.className="load-more-btn",n.id="load-more-messages",n.textContent="Load older messages",n.addEventListener("click",async()=>{Sn||(Sn=!0,n.textContent="Loading...",await Tn(e,t),Sn=!1)}),p.appendChild(n)}function bn(){let e=document.getElementById("load-more-messages");e&&e.remove()}function no(){let e=p.querySelectorAll(".empty-state");for(let n of e)n.remove();let t=document.createElement("div");t.className="empty-state",t.innerHTML=`
    <div class="empty-state-icon">\u{1F4AC}</div>
    <h3>No messages yet</h3>
    <p>Start the conversation!</p>
  `,p.appendChild(t)}function ao(e,t){let n=document.querySelector(`.message[data-id="${e}"]`);if(n){n.dataset.id=t;let a=n.querySelectorAll(`[data-id="${e}"]`);for(let s of a)s.dataset.id=t;let o=n.querySelectorAll(`[data-message-id="${e}"]`);for(let s of o)s.dataset.messageId=t}}async function oo(e,t){let n=Le(e);if(!n){d("Invalid message ID","error");return}try{if(await m(`/messages/${n}`,"PUT",{content:t}),r.messageCache.has(e)){let a=r.messageCache.get(e);r.messageCache.set(e,{...a,content:t})}await Bn({id:e,content:t}),d("Message updated successfully")}catch(a){d(a.message||"Failed to update message","error")}}async function rr(e){let t=Le(e);if(!t){d("Invalid message ID","error");return}if(confirm("Are you sure you want to delete this message?"))try{await m(`/messages/${t}`,"DELETE"),Un(e),d("Message deleted successfully")}catch(n){d(n.message||"Failed to delete message","error")}}async function Bn(e){let t=document.querySelector(`.message[data-id="${e.id}"]`);if(t){let n=t.querySelector(".message-text");if(n){let a=Oe(e.content);a=$n(a),a=An(a),n.innerHTML=a}e.images&&e.images.length>0&&await Ln(e.id,e.images)}}function Un(e){let t=document.querySelector(`.message[data-id="${e}"]`);if(t){t.remove();let n=document.querySelectorAll(".message-date-divider");for(let a of n){let o=a.nextElementSibling;(!o||o.classList.contains("message-date-divider"))&&a.remove()}document.querySelector(".message")||no()}}function $n(e){let t=/https?:\/\/[^\s]+/g;return e.replace(t,n=>`<a href="${n}" target="_blank" class="message-link">${n}</a>`)}function We(e){if(!e)return"";let t=Oe(e);return t=$n(t),t=An(t),t}function Ge(e){return Ce(new Date(e))}function An(e){let t=/#([a-zA-Z0-9_-]+)/g;return e.replace(t,(n,a)=>{let s=Array.from(te.querySelectorAll(".channel-item")).find(c=>c.querySelector(".channel-name").textContent.toLowerCase()===a.toLowerCase())?.dataset.id||"";return s?`<a href="#" class="channel-link" data-channel-id="${s}" data-channel-name="${a}">${n}</a>`:n})}function Le(e){if(e?.startsWith("temp-")){let t=r.tempIdMap.get(e);if(t)return t}return e}async function ro(e,t){let n=`temp-${Date.now()}`,a={id:n,content:t.content||"",author:r.currentUser,createdAt:new Date().toISOString(),reactions:{},images:[],isOffline:!0};return r.messageCache.set(n,a),await $t(a),d("Message saved locally. Will sync when online.","info"),{message:a}}async function so(e,t){try{let n=Le(e);if(!n){d("Invalid message ID","error");return}let a=r.messageCache.get(e);if(!a||!a.images){d("Message data not found","error");return}if(!a.author||a.author.id!==r.currentUser.id){d("You don't have permission to remove this image","error");return}let o=a.images.filter(c=>c!==t);await m(`/messages/${n}`,"PUT",{images:o}),a.images=o,r.messageCache.set(e,a);let s=document.getElementById(`img-container-${e}-${t}`);s&&s.remove(),d("Image removed successfully")}catch(n){d(n.message||"Failed to remove image","error")}}var eo,Sn,J=w(()=>{"use strict";E();M();N();v();y();F();T();Ct();ze();eo=50,Sn=!1});var Fn={};S(Fn,{createChannel:()=>Rn,deleteChannel:()=>Nn,loadChannels:()=>X,restoreLastChannel:()=>sr,selectChannel:()=>Te,updateChannelName:()=>Pn});async function X(){try{let{channels:e}=await m("/channels");te.innerHTML="";for(let t of e)await Be(t);if(e.length>0&&!r.currentChannelId){let t=null;try{t=await r.storage.getItem("currentChannelId")}catch{}t||(t=localStorage.getItem("lastChannelId"));let n=e.find(a=>a.id===t)||e[0];await Te(n.id,n.name)}return e}catch{d("Failed to load channels","error")}}async function Te(e,t){if(e===r.currentChannelId&&r.viewMode==="channel")return;r.currentConversationId=null,r.viewMode="channel",document.querySelectorAll(".dm-item").forEach(a=>{a.classList.remove("active")}),V.style.removeProperty("--channel-prefix"),r.currentChannelId=e,V.textContent=t,await r.storage.setItem("currentChannelId",e),localStorage.setItem("lastChannelId",e),r.unreadCounts.set(e,0),Z();let n=te.querySelectorAll(".channel-item");for(let a of n)if(a.dataset.id===e){a.classList.add("active");let o={id:e,name:t};a.querySelector(".channel-settings")&&(o.createdBy=r.currentUser.id),await Be(o)}else a.classList.remove("active");await Tn(e),await ue(e)}async function Rn(e){try{let{channel:t}=await m("/channels","POST",{name:e});d(`Channel #${e} created successfully!`),await X(),await Te(t.id,t.name)}catch(t){throw d(t.message||"Failed to create channel","error"),t}}async function Nn(e){try{await m(`/channels/${e}`,"DELETE"),d("Channel deleted successfully");let t=await X();await Te(t[0].id,t[0].name)}catch(t){throw d(t.message||"Failed to delete channel","error"),t}}async function Pn(e,t){try{let{channel:n}=await m(`/channels/${e}`,"PUT",{name:t});return d(`Channel renamed to #${t} successfully`),r.currentChannelId===e&&(V.textContent=t),await X(),n}catch(n){throw d(n.message||"Failed to update channel name","error"),n}}async function sr(){let e=null;try{e=await r.storage.getItem("currentChannelId")}catch{}if(e||(e=localStorage.getItem("lastChannelId")),!e)return;let t=document.querySelector(`.channel-item[data-id="${e}"]`);t&&t.click()}var Ye=w(()=>{"use strict";E();M();v();y();J();Ke()});var lo={};S(lo,{closeStartDmModalFn:()=>Rt,incrementDmUnread:()=>jn,loadConversations:()=>At,openStartDmModal:()=>Hn,renderConversationItem:()=>io,renderConversationsList:()=>Dt,selectConversation:()=>qn,startConversation:()=>co,updateConversationInCache:()=>zn});async function At(){try{let t=(await m("/conversations")).conversations||[];r.conversationCache.clear();for(let n of t)r.conversationCache.set(n.id,n);Dt(t)}catch(e){console.error("Failed to load conversations:",e)}}function Dt(e){if(Ne){if(Ne.innerHTML="",e.length===0){Ne.innerHTML='<div class="empty-list">No conversations yet</div>';return}for(let t of e){let n=io(t);Ne.appendChild(n)}}}function io(e){let t=document.createElement("div");t.className="dm-item",t.dataset.conversationId=e.id,r.currentConversationId===e.id&&t.classList.add("active");let a=e.otherUser?.userName||"Unknown User",o=a.charAt(0).toUpperCase();return t.innerHTML=`
    <div class="dm-avatar">${o}</div>
    <span class="dm-name">${a}</span>
    ${ir(e.id)}
  `,t.addEventListener("click",()=>qn(e.id)),t}function ir(e){let t=r.dmUnreadCounts.get(e)||0;return t>0?`<div class="notification-badge">${t>99?"99+":t}</div>`:""}async function qn(e){r.currentChannelId=null,r.viewMode="dm",document.querySelectorAll(".channel-item").forEach(o=>{o.classList.remove("active")}),document.querySelectorAll(".dm-item").forEach(o=>{o.classList.toggle("active",o.dataset.conversationId===e)}),r.currentConversationId=e,r.dmUnreadCounts.set(e,0),Z();let t=document.querySelector(`.dm-item[data-conversation-id="${e}"]`);if(t){let o=t.querySelector(".notification-badge");o&&o.remove()}let n=r.conversationCache.get(e);if(n&&V){let o=n.otherUser?.userName||"Direct Message";V.textContent=o,V.style.setProperty("--channel-prefix",'"@"')}await bt(e);let a=document.getElementById("sidebar");a&&a.classList.remove("open")}async function co(e){try{let t=await m("/conversations","POST",{targetUserId:e}),{conversation:n,isNew:a}=t;r.conversationCache.set(n.id,n),await At(),await qn(n.id),Rt(),a&&d("Conversation started","success")}catch(t){console.error("Failed to start conversation:",t),d(t.message||"Failed to start conversation","error")}}async function Hn(){if(!Pe||!re)return;Pe.classList.add("active");let e=document.getElementById("dm-user-search");e&&(e.value="",e.focus());try{let a=((await m("/users")).users||[]).filter(o=>o.id!==r.currentUser?.id);if(On=a,_n(a),e){let o=e.cloneNode(!0);e.parentNode.replaceChild(o,e),o.focus(),o.addEventListener("input",()=>{let s=o.value.trim().toLowerCase();if(!s){_n(On);return}let c=On.filter(i=>(i.userName||"").toLowerCase().includes(s)||(i.email||"").toLowerCase().includes(s));_n(c)})}}catch(t){console.error("Failed to load users:",t),re.innerHTML='<div class="empty-list">Failed to load users</div>'}}function Rt(){Pe&&Pe.classList.remove("active")}function _n(e){if(re){if(re.innerHTML="",e.length===0){re.innerHTML='<div class="empty-list">No other users available</div>';return}for(let t of e){let n=document.createElement("div");n.className="dm-user-item";let a=t.userName?.charAt(0).toUpperCase()||t.email.charAt(0).toUpperCase();n.innerHTML=`
      <div class="user-avatar">${a}</div>
      <div class="user-info">
        <div class="user-name">${t.userName||t.email.split("@")[0]}</div>
        <div class="user-email">${t.email}</div>
      </div>
    `,n.addEventListener("click",()=>co(t.id)),re.appendChild(n)}}}function zn(e){r.conversationCache.set(e.id,e);let t=Array.from(r.conversationCache.values());t.sort((n,a)=>(a.lastMessageAt||a.createdAt)-(n.lastMessageAt||n.createdAt)),Dt(t)}function jn(e){if(r.currentConversationId===e)return;let t=r.dmUnreadCounts.get(e)||0;r.dmUnreadCounts.set(e,t+1);let n=Array.from(r.conversationCache.values());Dt(n)}var On,Nt=w(()=>{"use strict";E();M();y();je();v();On=[]});var Pt={};S(Pt,{createWebhook:()=>dr,deleteWebhook:()=>uo,loadWebhooks:()=>cr});async function cr(){let e=document.getElementById("webhooks-list"),t=document.getElementById("webhook-channel-select");if(!(!e||!t))try{let n=await m("/webhooks","GET");e.innerHTML="";let a=await m("/channels","GET");t.innerHTML="";for(let o of a.channels||[]){let s=document.createElement("option");s.value=o.id,s.textContent=o.name,t.appendChild(s)}if(n.webhooks&&n.webhooks.length>0)for(let o of n.webhooks){let s=(a.channels||[]).find(h=>h.id===o.channelId),c=s?s.name:"Unknown",i=document.createElement("div");i.className="webhook-item",i.dataset.id=o.id;let u=`${location.origin}/webhooks/${o.id}/messages`;i.innerHTML=`
          <div class="webhook-info">
            <div class="webhook-name">${o.name}</div>
            <div class="webhook-channel">ID: ${o.id}</div>
            <div class="webhook-channel">Channel: #${c}</div>
            <div class="webhook-url-row">
              <code class="webhook-url">${u}</code>
              <button class="btn webhook-copy-url" title="Copy URL">Copy URL</button>
            </div>
          </div>
          <div class="webhook-actions">
            <button class="remove-webhook" title="Delete Webhook">&#10005;</button>
          </div>
        `;let l=i.querySelector(".webhook-copy-url");l&&l.addEventListener("click",()=>{navigator.clipboard.writeText(u),d("URL copied to clipboard")});let g=i.querySelector(".remove-webhook");g&&g.addEventListener("click",()=>uo(o.id,o.name)),e.appendChild(i)}else e.innerHTML='<div class="empty-list">No webhooks created yet</div>'}catch{}}async function dr(e,t){let n=document.getElementById("webhooks-list"),a=document.getElementById("webhook-name-input");try{k();let o=await m("/webhooks","POST",{name:e,channelId:t});if(f(),o.webhook){d("Webhook created successfully!");let s=document.querySelector(".webhook-token-display");s&&s.remove();let c=`${location.origin}/webhooks/${o.webhook.id}/messages`,i=document.createElement("div");i.className="webhook-token-display",i.innerHTML=`
        <div class="webhook-token-label">URL:</div>
        <code class="webhook-token-value">${c}</code>
        <button class="btn webhook-token-copy-url">Copy URL</button>
        <div class="webhook-token-label">Token (copy now, shown only once):</div>
        <code class="webhook-token-value">${o.webhook.token}</code>
        <button class="btn webhook-token-copy">Copy Token</button>
      `,n&&n.before(i);let u=i.querySelector(".webhook-token-copy-url");u&&u.addEventListener("click",()=>{navigator.clipboard.writeText(c),d("URL copied to clipboard")});let l=i.querySelector(".webhook-token-copy");l&&l.addEventListener("click",()=>{navigator.clipboard.writeText(o.webhook.token),d("Token copied to clipboard")}),a&&(a.value="")}}catch(o){f(),d(o.message||"Failed to create webhook","error")}}async function uo(e,t){if(confirm(`Are you sure you want to delete webhook "${t}"?`))try{k(),await m(`/webhooks/${e}`,"DELETE"),f(),d(`Webhook "${t}" has been deleted`)}catch(n){f(),d(n.message||"Failed to delete webhook","error")}}var Ft=w(()=>{"use strict";v();y()});async function ue(e){r.messageEventSource&&(r.messageEventSource.close(),r.messageEventSource=null),Je&&(clearTimeout(Je),Je=null);let t=await b();if(t)try{r.messageEventSource=new EventSource(`${R}/events?token=${t}`),r.messageEventSource.onopen=function(){Ue=0,Wn=0},r.messageEventSource.onmessage=async function(n){try{let a=JSON.parse(n.data);switch(console.log(`SSE event received: ${a.type}`,a.payload),a.type){case"CONNECTED":break;case"NEW_MESSAGE":if(a.payload.channelId===r.currentChannelId)await $t(a.payload);else{let o=r.unreadCounts.get(a.payload.channelId)||0;r.unreadCounts.set(a.payload.channelId,o+1);let s=document.querySelector(`.channel-item[data-id="${a.payload.channelId}"]`);if(s){let u=s.querySelector(".channel-name").textContent;await Be({id:a.payload.channelId,name:u})}let c=a.payload.author?.userName||"Someone",i=s?s.querySelector(".channel-name").textContent:"another channel";d(`${c} posted in #${i}`,"info"),Z(),Xe(`#${i}`,`${c}: ${a.payload.content}`)}break;case"UPDATE_MESSAGE":a.payload.channelId===r.currentChannelId&&(r.messageCache.has(a.payload.id)&&r.messageCache.set(a.payload.id,{...r.messageCache.get(a.payload.id),content:a.payload.content,images:a.payload.images,updatedAt:a.payload.updatedAt}),await Bn(a.payload));break;case"DELETE_MESSAGE":a.payload.channelId===r.currentChannelId&&(r.messageCache.delete(a.payload.id),Un(a.payload.id));break;case"NEW_CHANNEL":X();break;case"UPDATE_CHANNEL":if(X(),a.payload.id===r.currentChannelId){let o=document.getElementById("current-channel-name");o&&(o.textContent=a.payload.name)}break;case"DELETE_CHANNEL":X();break;case"NEW_REACTION":if(a.payload.messageId){let o=a.payload.messageId,s=a.payload.userId,c=a.payload.reaction;s!==r.currentUser.id&&await K(o,c,!0,!0)}break;case"DELETE_REACTION":if(a.payload.messageId){let o=a.payload.messageId,s=a.payload.userId,c=a.payload.reaction;if(r.messageCache.has(o)){let i=r.messageCache.get(o);i.reactions?.[c]&&(i.reactions[c]=i.reactions[c].filter(u=>u!==s),i.reactions[c].length===0&&delete i.reactions[c],r.messageCache.set(o,i))}s!==r.currentUser.id&&await K(o,c,!1,!0)}break;case"REMOVE_USER":a.payload.id===r.currentUser.id&&await Ze();break;case"UPDATE_USER":if(a.payload.id===r.currentUser.id){r.currentUser.userName=a.payload.userName;let{getInitials:o}=await Promise.resolve().then(()=>(T(),Ua));document.getElementById("user-avatar").textContent=o(a.payload.userName),document.getElementById("user-name").textContent=a.payload.userName}break;case"NEW_CONVERSATION":await At();break;case"NEW_DM_MESSAGE":if(a.payload.channelId.startsWith("dm:")){if(r.viewMode==="dm"&&a.payload.channelId===r.currentConversationId)En(a.payload);else{jn(a.payload.channelId);let s=a.payload.author?.userName||"Someone";d(`${s} sent you a direct message`,"info"),Z(),Xe("Direct Message",`${s}: ${a.payload.content}`)}let o=r.conversationCache.get(a.payload.channelId);o&&(o.lastMessageAt=a.payload.createdAt,zn(o))}break;case"UPDATE_DM_MESSAGE":a.payload.channelId.startsWith("dm:")&&In(a.payload);break;case"DELETE_DM_MESSAGE":a.payload.conversationId&&xn(a.payload.id,a.payload.conversationId);break;case"NEW_THREAD_REPLY":{let{appendThreadReply:o,updateThreadBadge:s}=await Promise.resolve().then(()=>(de(),ce));if(a.payload.channelId===r.currentChannelId&&s(a.payload.parentMessageId,a.payload.threadMeta),o(a.payload.reply),a.payload.reply.author.id!==r.currentUser.id){let c=a.payload.reply.author?.userName||"Someone";d(`${c} replied in a thread`,"info"),Xe("Thread Reply",`${c}: ${a.payload.reply.content}`)}break}case"UPDATE_THREAD_REPLY":{let{updateThreadReplyInView:o}=await Promise.resolve().then(()=>(de(),ce));o(a.payload);break}case"DELETE_THREAD_REPLY":{let{removeThreadReplyFromView:o,updateThreadBadge:s}=await Promise.resolve().then(()=>(de(),ce));a.payload.channelId===r.currentChannelId&&s(a.payload.threadId,a.payload.threadMeta),o(a.payload.id,a.payload.threadId);break}case"UPDATE_SERVER_SETTINGS":if(a.payload.name){let o=document.querySelector(".server-name-text");o&&(o.textContent=a.payload.name)}break;case"NEW_WEBHOOK":case"DELETE_WEBHOOK":{if(document.getElementById("server-settings-modal")?.classList.contains("active")){let{loadWebhooks:o}=await Promise.resolve().then(()=>(Ft(),Pt));o()}break}}}catch(a){console.error("Error processing SSE event",a)}},r.messageEventSource.onerror=function(n){if(Wn<ur&&Wn++,r.messageEventSource&&r.messageEventSource.readyState===EventSource.CLOSED){r.messageEventSource.close(),r.messageEventSource=null,Ue++;let a=Math.min(1e3*2**Ue,30*1e3);Ue<=lr?(console.log(`SSE reconnect attempt ${Ue} in ${a}ms`),Je=setTimeout(async()=>{await ue(e)},a)):(console.log("Maximum SSE reconnect attempts reached, trying again in 60s"),Ue=0,Je=setTimeout(async()=>{await ue(e)},60*1e3))}}}catch(n){console.error("Error setting up SSE connection",n)}}function Ot(){let e=document.getElementById("offline-bar"),t=document.getElementById("message-input"),n=document.getElementById("send-button");function a(){r.isOffline=!0,e&&e.classList.add("visible"),t&&(t.disabled=!0),n&&(n.disabled=!0),d("You are offline","error")}function o(){r.isOffline=!1,e&&e.classList.remove("visible"),t&&(t.disabled=!1),n&&(n.disabled=!1),d("You are back online","success")}window.addEventListener("offline",a),window.addEventListener("online",o),navigator.onLine||a()}var lr,ur,Ue,Je,Wn,Ke=w(()=>{"use strict";E();N();F();y();J();ze();Ye();Nt();je();lr=5,ur=3,Ue=0,Je=null,Wn=0});var mo={};S(mo,{fetchOAuthProviders:()=>gr,getProviderIcon:()=>pr,handleOAuthCallback:()=>Vn,initiateOAuth:()=>fr,isOAuthCallback:()=>Gn});function pr(e){return mr[e]||""}async function gr(){try{let e=await fetch(`${R}/auth/oauth/providers`);return e.ok?(await e.json()).providers||[]:[]}catch{return[]}}function fr(e){window.location.href=`${R}/auth/oauth/${e}`}function Gn(){let e=new URLSearchParams(window.location.search);return e.has("access_token")||e.has("oauth_error")}async function Vn(){let e=new URLSearchParams(window.location.search),t=e.get("oauth_error");if(t)throw window.history.replaceState({},document.title,window.location.pathname),new Error(t);let n=e.get("access_token"),a=e.get("refresh_token"),o=e.get("expires_in");if(!n)throw new Error("No access token received");await ie(),await me({accessToken:n,refreshToken:a,exp:parseInt(o,10)||900}),Ot(),window.history.replaceState({},document.title,window.location.pathname)}var mr,Yn=w(()=>{"use strict";N();F();He();Ke();mr={google:`<svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844c-.209 1.125-.843 2.078-1.796 2.717v2.258h2.908c1.702-1.567 2.684-3.874 2.684-6.615z" fill="#4285F4"/>
    <path d="M9 18c2.43 0 4.467-.806 5.956-2.184l-2.908-2.258c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.711H.957v2.332C2.438 15.983 5.482 18 9 18z" fill="#34A853"/>
    <path d="M3.964 10.707c-.18-.54-.282-1.117-.282-1.707s.102-1.167.282-1.707V4.961H.957C.347 6.175 0 7.55 0 9s.348 2.825.957 4.039l3.007-2.332z" fill="#FBBC05"/>
    <path d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0 5.482 0 2.438 2.017.957 4.961L3.964 7.29C4.672 5.163 6.656 3.58 9 3.58z" fill="#EA4335"/>
  </svg>`,github:`<svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
    <path d="M12 0C5.37 0 0 5.37 0 12c0 5.31 3.435 9.795 8.205 11.385.6.105.825-.255.825-.57 0-.285-.015-1.23-.015-2.235-3.015.555-3.795-.735-4.035-1.41-.135-.345-.72-1.41-1.23-1.695-.42-.225-1.02-.78-.015-.795.945-.015 1.62.87 1.845 1.23 1.08 1.815 2.805 1.305 3.495.99.105-.78.42-1.305.765-1.605-2.67-.3-5.46-1.335-5.46-5.925 0-1.305.465-2.385 1.23-3.225-.12-.3-.54-1.53.12-3.18 0 0 1.005-.315 3.3 1.23.96-.27 1.98-.405 3-.405s2.04.135 3 .405c2.295-1.56 3.3-1.23 3.3-1.23.66 1.65.24 2.88.12 3.18.765.84 1.23 1.905 1.23 3.225 0 4.605-2.805 5.625-5.475 5.925.435.375.81 1.095.81 2.22 0 1.605-.015 2.895-.015 3.3 0 .315.225.69.825.57A12.02 12.02 0 0024 12c0-6.63-5.37-12-12-12z"/>
  </svg>`,microsoft:`<svg width="18" height="18" viewBox="0 0 23 23" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h11v11H0z" fill="#F25022"/>
    <path d="M12 0h11v11H12z" fill="#7FBA00"/>
    <path d="M0 12h11v11H0z" fill="#00A4EF"/>
    <path d="M12 12h11v11H12z" fill="#FFB900"/>
  </svg>`,gitlab:`<svg width="18" height="18" viewBox="0 0 24 24" fill="#FC6D26" xmlns="http://www.w3.org/2000/svg">
    <path d="M23.546 10.93L13.067.452c-.604-.603-1.582-.603-2.188 0L.452 10.93c-.6.605-.6 1.584 0 2.188l10.427 10.426c.603.602 1.582.602 2.188 0l10.48-10.478c.6-.603.6-1.582 0-2.187zm-11.544 11.07L2.468 12.467l9.534-9.533 9.534 9.533-9.534 9.534z"/>
  </svg>`}});async function _t(){try{let e=await m("/users","GET");if(lt.innerHTML="",e.users&&e.users.length>0){let t=[...e.users].sort((n,a)=>n.id===r.currentUser.id?-1:a.id===r.currentUser.id?1:0);for(let n of t){let a=document.createElement("div");a.className="user-item",a.dataset.id=n.id,a.innerHTML=`
          <div class="user-avatar">${C(n.userName||n.email.split("@")[0])}</div>
          <div class="user-info">
            <div class="user-email">${n.email}</div>
            <div class="user-role ${n.isAdmin?"admin-role":"user-role"}">${n.isAdmin?"Admin":"User"}</div>
            <div class="user-created">Added ${Ce(new Date(n.createdAt))}</div>
          </div>
          ${n.id!==r.currentUser.id?`
            <div class="user-actions">
              <button class="remove-user" title="Remove User">\u2715</button>
            </div>
          `:""}
        `;let o=a.querySelector(".remove-user");o&&o.addEventListener("click",()=>hr(n.id,n.email)),lt.appendChild(a)}}else lt.innerHTML='<div class="empty-list">No users added yet</div>'}catch(e){console.error("Error loading users:",e),d("Failed to load users","error")}}async function po(e,t){try{k();let n=await m("/users/add","POST",{email:e,role:t});f(),n.success&&(d(`User ${e} added successfully!`),_t())}catch(n){f(),d(n.message||"Failed to add user","error")}}async function hr(e,t){if(confirm(`Are you sure you want to remove user ${t}?`))try{k(),await m(`/users/${e}`,"DELETE"),f(),d(`User ${t} has been removed`),_t()}catch(n){f(),d(n.message||"Failed to remove user","error")}}var Kn=w(()=>{"use strict";E();M();v();y();T()});var go={};S(go,{closeUserSettingsModal:()=>Ht,hideServerSettingsModal:()=>qt,loadServerName:()=>yr,openServerSettingsModal:()=>Jn,openUserSettingsModal:()=>Zn,updateServerName:()=>Xn,updateUserName:()=>Qn});function Jn(){let e=rt.textContent.trim().replace(/\s+/g," ");ye.value=e,nn.classList.add("active"),ye.focus(),_t();let t=document.getElementById("webhooks-section");r.currentUser?.isAdmin?(t&&(t.style.display="block"),Promise.resolve().then(()=>(Ft(),Pt)).then(({loadWebhooks:n})=>n())):t&&(t.style.display="none")}function qt(){nn.classList.remove("active");let e=document.querySelector(".webhook-token-display");e&&e.remove()}async function Xn(e){try{k();let t=await m("/server/settings","PUT",{name:e});return st.textContent=e,await r.storage.setItem("serverName",e),qt(),d("Server name updated successfully"),f(),t}catch(t){throw f(),d(t.message||"Failed to update server name","error"),t}}async function yr(){try{let t=await m("/server/settings","GET");if(t?.name){st.textContent=t.name,await r.storage.setItem("serverName",t.name);return}}catch(t){console.error("Error loading server name from API:",t)}let e=await r.storage.getItem("serverName");e&&(st.textContent=e)}function Zn(){we.value=r.currentUser?.userName||"",sn.classList.add("active"),we.focus()}function Ht(){sn.classList.remove("active")}async function Qn(e){let t=e?.trim();if(!t)return d("Name cannot be empty","error");try{k(),await m("/users/me","PUT",{userName:t}),r.currentUser.userName=t,dt.textContent=C(t),ut.textContent=t,Ht(),d("Display name updated"),f()}catch(n){f(),d(n.message||"Failed to update display name","error")}}var ea=w(()=>{"use strict";E();M();v();y();Kn();T()});var O={};S(O,{closeAllModals:()=>Wt,closeCreateChannelModal:()=>zt,closeEditChannelModal:()=>et,closeEditModal:()=>jt,closeReactionPicker:()=>oa,getReactionCount:()=>kt,hideLoading:()=>f,isReacted:()=>Io,openCreateChannelModal:()=>aa,openEditChannelModal:()=>xo,openEditModal:()=>le,openReactionPicker:()=>Ve,reacted:()=>Mt,renderChannelItem:()=>Be,renderDevModeEncryptionSignInView:()=>ta,renderDevModePlainSignInView:()=>ho,renderForgotPasswordView:()=>Ir,renderMagicLinkEncryptionSignInView:()=>na,renderMagicLinkUnauthenticatedView:()=>yo,renderNewMagicLink:()=>Cr,renderPasswordRegisterView:()=>Er,renderPasswordResetSent:()=>xr,renderPasswordResetView:()=>Eo,renderPasswordSetupView:()=>vo,renderPasswordSignInView:()=>wo,renderReaction:()=>be,scrollToBottom:()=>Bt,showAppScreen:()=>Qe,showAuthScreen:()=>G,showDesktopNotification:()=>Xe,showLoading:()=>k,showToast:()=>d,signInWithMagicLink:()=>fo,updateDocumentTitle:()=>Z,updatePendingUploadsUI:()=>Me,updateReactionCount:()=>Se});async function G(){Wt(),Yt.style.display="block",Vt.style.display="none",vr();let e=tt();if(x==="dev")return Q()||e?ta():ho();if(x==="magic-link"){if(Y())return Q()?na():fo();if(e){if(Q())return na();await ke(j)}return yo()}if(x==="password"){let{emailParam:t,tokenParam:n,resetParam:a}=W();return t&&n&&a?Eo(t):t&&n?vo(t):e?(await ke(j),await Qe()):wo()}}async function vr(){if(!!1){se.style.display="none",Fe.style.display="none";return}try{let{fetchOAuthProviders:e,getProviderIcon:t,initiateOAuth:n}=await Promise.resolve().then(()=>(Yn(),mo)),a=await e();if(a.length===0){se.style.display="none",Fe.style.display="none";return}se.innerHTML=a.map(o=>{let s=t(o.id);return`<button type="button" class="btn oauth-btn oauth-btn-${o.id}" data-provider="${o.id}">
          ${s?`<span class="oauth-btn-icon">${s}</span>`:""}
          <span>Sign in with ${o.name}</span>
        </button>`}).join(""),se.style.display="block",Fe.style.display="flex",se.querySelectorAll(".oauth-btn").forEach(o=>{o.addEventListener("click",()=>{n(o.dataset.provider)})})}catch(e){console.error("Failed to load OAuth providers:",e),se.style.display="none",Fe.style.display="none"}}function fo(){let{emailParam:e}=W();U.value=e,L.click()}function ho(){D.textContent="Enter your email to sign in.",$.style.display="none",f()}function ta(){D.textContent="Enter your email and encryption key to sign in.",$.style.display="block",f()}function na(){if(D.textContent="Enter your encryption key to sign in.",Y()){he.getElementsByTagName("label")[0].style.display="none",U.style.display="none";let{emailParam:t}=W();U.value=t}$.style.display="block",f()}function yo(){D.textContent="Enter your email to get a magic link.",$.style.display="none",f()}function wo(){D.textContent="Enter your email and password to sign in.",$.style.display="none",Ee.style.display="block",ve.style.display="none",Ie.style.display="none",gt.style.display="block",L.textContent="Sign In",f()}function vo(e){D.textContent="Set your password to complete registration.",he.style.display="none",U.value=e,$.style.display="none",Ee.style.display="block",ve.style.display="block",Ie.style.display="none",L.textContent="Set Password",f()}function Er(){D.textContent="Create your account.",he.style.display="block",$.style.display="none",Ee.style.display="block",ve.style.display="block",Ie.style.display="block",xa.textContent="Already have an account? Sign In",L.textContent="Create Account",f()}function Ir(){D.textContent="Enter your email to receive a password reset link.",he.style.display="block",U.value="",$.style.display="none",Ee.style.display="none",ve.style.display="none",Ie.style.display="none",gt.style.display="none",L.textContent="Send Reset Link",f()}function Eo(e){D.textContent="Reset your password.",he.style.display="none",U.value=e,$.style.display="none",Ee.style.display="block",ve.style.display="block",Ie.style.display="none",gt.style.display="none",L.textContent="Reset Password",f()}function xr(e){document.querySelector(".auth-form").style.display="none",ba.textContent=e||"If a matching account was found, a password reset link has been sent. Please check your inbox.",Sa.style.display="block"}async function Cr(e){let{apiRequest:t}=await Promise.resolve().then(()=>(v(),B)),n=await t("/auth/login","POST",{email:e});document.querySelector(".auth-form").style.display="none";let a=document.getElementById("magic-link-sent-form"),o=document.getElementById("magic-link-sent-message");o.textContent=n.message||`Magic link sent to ${e}. Please check your inbox and click the link to continue.`,a.style.display="block"}async function Qe(){let{loadServerName:e}=await Promise.resolve().then(()=>(ea(),go)),{loadChannels:t,restoreLastChannel:n}=await Promise.resolve().then(()=>(Ye(),Fn)),{loadConversations:a}=await Promise.resolve().then(()=>(Nt(),lo));if(r.currentUser=await Co(),!r.currentUser){f();return}window.history.replaceState({},document.title,window.location.pathname),await e(),await t(),await a(),dt.textContent=C(r.currentUser.userName),ut.textContent=r.currentUser.userName,Yt.style.display="none",Vt.style.display="flex",await n();let o=await r.storage.getItem("darkMode")!=="false";await Et(o),f()}async function Be(e){let{selectChannel:t}=await Promise.resolve().then(()=>(Ye(),Fn)),n=document.querySelector(`.channel-item[data-id="${e.id}"]`);n||(n=document.createElement("div"),n.className="channel-item",n.dataset.id=e.id,n.addEventListener("click",async()=>await t(e.id,e.name)),te.appendChild(n));let a=r.unreadCounts.get(e.id)||0;n.innerHTML="";let o=document.createElement("div");if(o.textContent=e.name,o.className="channel-name",n.appendChild(o),a>0){let s=document.createElement("div");s.className="notification-badge",s.textContent=a>99?"99+":a,n.appendChild(s)}if(e.createdBy===r.currentUser.id){let s=document.createElement("div");s.className="channel-settings",s.innerHTML="\u2699\uFE0F",s.addEventListener("click",c=>{c.stopPropagation(),xo(e)}),n.appendChild(s)}e.id===r.currentChannelId?n.classList.add("active"):n.classList.remove("active")}function Me(){let e=document.getElementById("pending-uploads-container"),t=document.getElementById("pending-uploads");if(r.pendingUploads.length===0){e.style.display="none";return}e.style.display="block",t.innerHTML="",r.pendingUploads.forEach((a,o)=>{let s=document.createElement("div");s.className="pending-upload",s.innerHTML=`
      <img src="${a.preview}" alt="Upload preview">
      <div class="remove-upload" data-index="${o}">&times;</div>
    `,t.appendChild(s)}),document.querySelectorAll(".remove-upload").forEach(a=>{a.addEventListener("click",async o=>{let{removePendingUpload:s}=await Promise.resolve().then(()=>(Ct(),Oa)),c=Number.parseInt(o.target.dataset.index,10);s(c)})})}async function be(e,t,n,a){let{addReaction:o,removeReaction:s}=await Promise.resolve().then(()=>(ze(),_a)),c=ht(e);if(!c)return;let i=document.createElement("div");return i.className=`reaction ${a?"user-reacted":""}`,i.dataset.reaction=t,i.dataset.messageId=e,i.innerHTML=`
        <span class="reaction-reaction">${t}</span>
        <span class="reaction-count">${n}</span>
      `,i.addEventListener("click",async()=>{Io(i)?await s(e,t):await o(e,t)}),c.appendChild(i),i}function kt(e){if(!e)return 0;let t=e.querySelector(".reaction-count");if(t)return Number.parseInt(t.textContent,10)||0}function Se(e,t){if(!e)return;let n=e.querySelector(".reaction-count");n&&(n.textContent=t.toString())}function Mt(e,t){e&&(e.className=`reaction ${t?"user-reacted":""}`)}function Io(e){if(e)return Array.from(e.classList).includes("user-reacted")}function d(e,t="success"){Re.textContent=e,Re.className=`toast ${t}`,Re.classList.add("show"),setTimeout(()=>{Re.classList.remove("show")},3e3)}function Bt(){let e=document.getElementById("messages-area");e&&(e.scrollTop=0)}function k(){en.style.display="flex"}function f(){en.style.display="none"}function aa(){Kt.classList.add("active"),fe.focus()}function zt(){Kt.classList.remove("active"),fe.value=""}function Ve(e){r.currentMessageForReaction=e,$e.classList.add("active")}function oa(){$e.classList.remove("active"),r.currentMessageForReaction=null}function le(e){r.currentMessageForEdit=e.id,ae.value=e.content,Zt.classList.add("active"),ae.focus()}function jt(){Zt.classList.remove("active"),ae.value="",r.currentMessageForEdit=null}function xo(e){r.currentChannelForEdit=e,ne.value=e.name,Xt.classList.add("active"),ne.focus()}function et(){Xt.classList.remove("active"),ne.value="",r.currentChannelForEdit=null}function Wt(){document.querySelectorAll(".modal-backdrop.active").forEach(n=>{n.classList.remove("active")}),r.currentMessageForReaction=null,r.currentMessageForEdit=null,r.currentChannelForEdit=null;let t=document.querySelector(".webhook-token-display");t&&t.remove()}function Z(){let e=0;for(let t of r.unreadCounts.values())e+=t;for(let t of r.dmUnreadCounts.values())e+=t;document.title=e>0?`(${e}) MikroChat`:"MikroChat"}async function Xe(e,t){if(!("Notification"in window)||document.hasFocus()||(Notification.permission==="default"&&await Notification.requestPermission(),Notification.permission!=="granted"))return;let n=new Notification(e,{body:t,icon:"/icons/icon-192.png"});n.onclick=()=>{window.focus(),n.close()}}var y=w(()=>{"use strict";E();M();N();wt();vt();F();He();T();mn()});var B={};S(B,{apiRequest:()=>m,fetchImageWithAuth:()=>Dn});async function m(e,t="GET",n=null,a=null){if(!navigator.onLine&&t!=="GET"){if(e.includes("/channels/")&&e.includes("/messages")&&t==="POST")return ro(e,n);throw d("You're offline. This action will be available when you reconnect.","error"),new Error("Offline - cannot perform this action")}if(x!=="dev"&&e!=="/auth/login")try{if(await ko()){await Mo();let i=await b();i&&await r.storage.setItem("accessToken",i)}}catch(i){throw console.error("Token refresh failed:",i),await r.storage.removeItem("accessToken"),r.currentUser=null,await G(),d("Session expired. Please log in again.","error"),new Error("Authentication failed")}let o={"Content-Type":"application/json"},s=a;r.isStorageInitialized&&(s=a||await b()),s&&(o.Authorization=`Bearer ${s}`);let c={method:t,headers:o};n&&(c.body=JSON.stringify(n));try{let i=await fetch(`${R}${e}`,c);if(!i.ok){let l=`Error ${i.status}: ${i.statusText}`;try{l=(await i.clone().json().catch(()=>({}))).error||l}catch(g){console.error("Could not parse error response",g)}throw new Error(l)}if(t==="DELETE"||i.headers.get("content-length")==="0")return{success:!0};if(e==="/events")return i;if(i.headers.get("content-type")?.includes("application/json"))try{return await i.clone().json()}catch(l){console.error("JSON parsing error:",l,"for endpoint:",e);let g=await i.text();try{return g?JSON.parse(g):{success:!0}}catch(h){return console.error("Manual JSON parsing also failed:",h),{success:!0,text:g}}}else{let l=await i.text();if(!l)return{success:!0};try{return JSON.parse(l)}catch{return{success:!0,text:l}}}}catch(i){throw navigator.onLine?d(i.message,"error"):d("You're working offline. Some features may be limited.","info"),i}}async function Dn(e,t,n,a,o=!0){let s=await b(),c=o?`${e}${e.includes("?")?"&":"?"}size=thumb`:e,i=e;await fetch(c,{method:"GET",headers:{Authorization:`Bearer ${s}`}}).then(u=>{if(!u.ok)throw new Error("Image fetch failed");return u.blob()}).then(u=>{let l=URL.createObjectURL(u),g=document.getElementById(t);if(g){g.innerHTML="";let h=document.createElement("div");h.className="image-wrapper";let I=document.createElement("img");I.src=l,I.alt="User uploaded image",I.className="message-image",I.loading="lazy",I.setAttribute("onclick",`openImagePreview('${i}')`),h.appendChild(I);let _=r.messageCache.get(n);if(_?.author&&_.author.id===r.currentUser.id){let q=document.createElement("div");q.className="remove-image-btn",q.innerHTML="&times;",q.onclick=function(pe){pe.stopPropagation(),confirm("Remove this image?")&&so(n,a)},h.appendChild(q)}g.appendChild(h)}}).catch(u=>{console.error("Error fetching image:",u);let l=document.getElementById(t);l&&(l.innerHTML='<div class="image-error">Failed to load image</div>')})}var v=w(()=>{"use strict";E();N();y();F();y();J()});async function me(e){try{return await r.storage.setItem("accessToken",e.accessToken),await r.storage.setItem("refreshToken",e.refreshToken),await r.storage.setItem("exp",Date.now()+e.exp*1e3),!0}catch(t){return console.error("Failed to save tokens:",t),!1}}async function Lo(){try{return{accessToken:await b(),refreshToken:await To()}}catch(e){return console.error("Failed to get tokens:",e),null}}async function b(){return await r.storage.getItem("token")||await r.storage.getItem("accessToken")}async function To(){return await r.storage.getItem("refreshToken")}async function kr(){try{return await r.storage.removeItem("accessToken"),await r.storage.removeItem("refreshToken"),!0}catch(e){return console.error("Failed to clear tokens:",e),!1}}async function ko(){let e=await Lo();return e?Date.now()>e.exp-10*1e3:!0}function Mr(e){if(!e)return null;try{let n=e.split(".")[1].replace(/-/g,"+").replace(/_/g,"/"),a=decodeURIComponent(atob(n).split("").map(o=>`%${`00${o.charCodeAt(0).toString(16)}`.slice(-2)}`).join(""));return JSON.parse(a)}catch(t){return console.error("Failed to parse token:",t),null}}async function Co(){let{apiRequest:e}=await Promise.resolve().then(()=>(v(),B)),t=await b();if(!t)return;let{user:n}=await e("/auth/me","GET");if(!n)return;let a=Mr(t);if(a)return{id:n.id,userName:n.userName,email:n.sub,isAdmin:n.isAdmin,lastLogin:a.lastLogin,metadata:a.metadata}}async function Da(e){let{apiRequest:t}=await Promise.resolve().then(()=>(v(),B));try{let n=await t("/auth/verify","POST",{email:e.email},e.token);return await me(n),n}catch(n){return console.error("Error while verifying token:",n),!1}}async function Mo(){let{apiRequest:e}=await Promise.resolve().then(()=>(v(),B)),t=await To();if(!t)throw new Error("No refresh token available");try{let n=await e("/auth/refresh","POST",{refreshToken:t});if(!n.ok)throw new Error("Failed to refresh token");return await me(n),n}catch(n){throw await kr(),n}}async function Ze(){let{apiRequest:e}=await Promise.resolve().then(()=>(v(),B)),{accessToken:t,refreshToken:n}=await Lo();if(!t||!n){So();return}await e("/auth/logout","POST",{refreshToken:n}).then(a=>{if(a.error)throw new Error("Failed to logout");So()})}async function So(){let{showToast:e}=await Promise.resolve().then(()=>(y(),O));localStorage.clear(),r.storage.clear(),r.storage=null,r.currentUser=null,r.messageEventSource&&(r.messageEventSource.close(),r.messageEventSource=null),r.tempIdMap=new Map,r.messageCache=new Map,r.unreadCounts=new Map,window.location="/",e("You have been signed out")}function Q(){return!1}function tt(){return un()}async function Bo(e,t){let{showToast:n,showLoading:a,hideLoading:o,showAppScreen:s,renderNewMagicLink:c}=await Promise.resolve().then(()=>(y(),O));if(!e||!e.trim()){n("Please enter your email","error");return}if(!dn(e)){n("Email appears invalid. Please check the input.","error");return}if(oe.style.display==="block"&&Q()&&(!t||!t.trim())){n("Please enter your encryption password","error");return}try{if(a(),!await ie(j)){o(),n("Invalid encryption key","error");return}if(Q()||(oe.value=j),x==="dev")return await Sr(e);if(x==="magic-link"){if(Y())return await br();if(tt()){if(await $a(t))return n("Successfully logged in!"),await s();n("Invalid password","error")}else await c(e)}if(x==="password"){let l=mt?.value,g=pt?.value,{emailParam:h,tokenParam:I,resetParam:_}=W();if(mt&&mt.offsetParent===null&&!h&&!I)return await Br(e);if(h&&I&&_){if(!l||l.length<8){n("Password must be at least 8 characters","error"),o();return}if(l!==g){n("Passwords do not match","error"),o();return}return await bo(h,I,l)}if(h&&I){if(!l||l.length<8){n("Password must be at least 8 characters","error"),o();return}if(l!==g){n("Passwords do not match","error"),o();return}return await bo(h,I,l)}if(pt&&pt.offsetParent!==null){if(!l||l.length<8){n("Password must be at least 8 characters","error"),o();return}if(l!==g){n("Passwords do not match","error"),o();return}return await Tr(e,l)}if(!l){n("Please enter your password","error"),o();return}return await Lr(e,l)}o()}catch(i){o(),n(i.message||"Failed to log in","error")}}async function Sr(e){let{apiRequest:t}=await Promise.resolve().then(()=>(v(),B)),{showToast:n,showAppScreen:a}=await Promise.resolve().then(()=>(y(),O)),o=await t("/auth/dev-login","POST",{email:e});return await r.storage.setItem("token",o.token),r.currentUser=o.user,n("Successfully logged in!"),await a()}async function br(){let{showToast:e,showAppScreen:t}=await Promise.resolve().then(()=>(y(),O));return await Aa(),e("Successfully logged in!"),await t()}async function Lr(e,t){let{apiRequest:n}=await Promise.resolve().then(()=>(v(),B)),{showToast:a,showAppScreen:o}=await Promise.resolve().then(()=>(y(),O)),s=await n("/auth/password-login","POST",{email:e,password:t});if(s.error)throw new Error(s.error);return await me(s),a("Successfully logged in!"),await o()}async function bo(e,t,n){let{apiRequest:a}=await Promise.resolve().then(()=>(v(),B)),{showToast:o,showAppScreen:s}=await Promise.resolve().then(()=>(y(),O)),c=await a("/auth/setup-password","POST",{email:e,token:t,password:n});if(c.error)throw new Error(c.error);return await me(c),o("Password set successfully!"),await s()}async function Tr(e,t){let{apiRequest:n}=await Promise.resolve().then(()=>(v(),B)),{showToast:a,showAppScreen:o}=await Promise.resolve().then(()=>(y(),O)),s=await n("/auth/register","POST",{email:e,password:t});if(s.error)throw new Error(s.error);return await me(s),a("Account created successfully!"),await o()}async function Br(e){let{apiRequest:t}=await Promise.resolve().then(()=>(v(),B)),{hideLoading:n,renderPasswordResetSent:a}=await Promise.resolve().then(()=>(y(),O)),o=await t("/auth/request-password-reset","POST",{email:e});n(),a(o.message)}var F=w(()=>{"use strict";E();M();N();T();He();vt();wt()});E();M();F();J();Ye();ze();Ct();mn();N();F();He();vt();Yn();y();Ke();async function Uo(){try{if(k(),Gn())try{return await Vn(),d("Successfully logged in!"),await Qe()}catch(e){return f(),d(e.message||"OAuth sign-in failed","error"),await G()}return Y()&&x!=="magic-link"&&x!=="password"&&(window.location="/"),Y()&&x==="password"?await G():Q()?await G():tt()?(await ie(),Ot(),await Qe()):await G()}catch(e){return console.error("Error while checking if authenticated:",e),d("Failed to initialize the application","error"),f(),await G()}}Ke();Kn();ea();y();v();Nt();je();T();function $o(){window.openImagePreview=gn,window.addEventListener("online",async()=>{r.currentChannelId&&await ue(r.currentChannelId)}),window.addEventListener("DOMContentLoaded",async()=>{await Uo()}),document.addEventListener("click",()=>{rn.classList.remove("show")}),document.addEventListener("keydown",e=>{e.key==="Escape"&&Wt()}),document.addEventListener("keydown",e=>{e.key==="Escape"&&H.classList.contains("active")&&H.classList.remove("active")}),document.addEventListener("click",e=>{window.innerWidth<=768&&it.classList.contains("open")&&!e.target.closest(".sidebar")&&!e.target.closest(".menu-toggle")&&it.classList.remove("open")}),document.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"?r.messageEventSource&&(r.messageEventSource.close(),r.messageEventSource=null):document.visibilityState==="visible"&&!r.messageEventSource&&r.currentChannelId&&ue(r.currentChannelId)}),L?.addEventListener("click",()=>{let e=U.value.trim(),t=oe?oe.value?.trim():null;Bo(e,t)}),ya?.addEventListener("click",()=>Ze()),Ma?.addEventListener("click",async e=>{e.preventDefault();let{renderForgotPasswordView:t}=await Promise.resolve().then(()=>(y(),O));t()}),U?.addEventListener("keydown",e=>{e.key==="Enter"&&(e.preventDefault(),L.click())}),oe?.addEventListener("keydown",e=>{e.key==="Enter"&&(e.preventDefault(),L.click())}),tn?.addEventListener("click",()=>{let e=z.value;to(e)}),z?.addEventListener("keydown",e=>{e.key==="Enter"&&!e.shiftKey&&(e.preventDefault(),tn.click())}),sa?.addEventListener("click",()=>aa()),Jt?.addEventListener("click",async()=>{let e=fe.value.trim();e&&(await Rn(e),zt())}),fe?.addEventListener("keydown",e=>{e.key==="Enter"&&(e.preventDefault(),Jt.click())}),ia?.addEventListener("click",()=>zt()),pa?.addEventListener("click",async()=>{r.currentChannelForEdit&&confirm("Are you sure you want to delete this channel?")&&(await Nn(r.currentChannelForEdit.id),et())}),an?.addEventListener("click",async()=>{let e=ne.value.trim();e&&r.currentChannelForEdit&&(await Pn(r.currentChannelForEdit.id,e),et())}),ne?.addEventListener("keydown",e=>{e.key==="Enter"&&(e.preventDefault(),an.click())}),ca?.addEventListener("click",()=>et()),Qt?.addEventListener("click",async()=>{let e=ae.value.trim();if(e&&r.currentMessageForEdit){if(r.currentMessageForEditIsThread){let{updateThreadReply:t}=await Promise.resolve().then(()=>(de(),ce));await t(r.currentMessageForEdit,e),r.currentMessageForEditIsThread=!1}else r.currentMessageForEditIsDM?(await Tt(r.currentMessageForEdit,e,r.currentMessageForEditImages||[]),r.currentMessageForEditIsDM=!1,r.currentMessageForEditImages=[]):await oo(r.currentMessageForEdit,e);jt()}}),ae?.addEventListener("keydown",e=>{e.key==="Enter"&&!e.shiftKey&&(e.preventDefault(),Qt.click())}),da?.addEventListener("click",()=>jt()),ga?.addEventListener("click",async e=>{let t=e.target.closest(".reaction-item");if(t&&r.currentMessageForReaction){let n=t.dataset.reaction;await St(r.currentMessageForReaction,n)}}),la?.addEventListener("click",()=>oa()),ha?.addEventListener("change",e=>{e.target.files.length>0&&(It(e.target.files),e.target.value="")}),ua?.addEventListener("click",()=>{H.classList.remove("active");let e=A.getAttribute("data-object-url");e&&(URL.revokeObjectURL(e),A.removeAttribute("data-object-url"))}),p?.addEventListener("dragover",e=>{e.preventDefault(),p.classList.add("drag-over")}),p?.addEventListener("dragleave",()=>{p.classList.remove("drag-over")}),p?.addEventListener("drop",e=>{e.preventDefault(),p.classList.remove("drag-over"),e.dataTransfer.files.length>0&&It(e.dataTransfer.files)}),p?.addEventListener("click",async e=>{let t=e.target.closest(".channel-link");if(t){e.preventDefault();let i=t.dataset.channelId,u=t.dataset.channelName;i&&await Te(i,u);return}let n=e.target.closest('.message-edit[data-is-dm="true"]');if(n){let i=n.dataset.messageId,u=e.target.closest(".message"),l=u?.querySelector(".message-text")?.textContent||"",g=[];u?.querySelectorAll(".message-image").forEach(h=>{h.dataset.image&&g.push(h.dataset.image)}),r.currentMessageForEdit=i,r.currentMessageForEditIsDM=!0,r.currentMessageForEditContent=l,r.currentMessageForEditImages=g,le({id:i,content:l,images:g});return}let a=e.target.closest('.message-delete[data-is-dm="true"]');if(a){let i=a.dataset.messageId;confirm("Are you sure you want to delete this message?")&&await vn(i);return}let o=e.target.closest(".add-reaction[data-message-id]");if(o){let i=o.dataset.messageId;r.currentMessageForReaction=i,r.currentMessageForReactionIsDM=!0,Ve(i);return}let s=e.target.closest(".reaction[data-message-id]");if(s){let i=s.dataset.messageId,u=s.dataset.reaction;r.currentMessageForReactionIsDM=!0,_e(i,u)?await hn(i,u):await St(i,u);return}let c=e.target.closest(".remove-image-btn[data-message-id]");if(c){e.stopPropagation();let i=c.dataset.messageId,u=c.dataset.image;if(confirm("Remove this image?")){let l=e.target.closest(".message"),g=[];l?.querySelectorAll(".message-image").forEach(I=>{I.dataset.image&&I.dataset.image!==u&&g.push(I.dataset.image)});let h=l?.querySelector(".message-text")?.textContent||"";await Tt(i,h,g)}return}}),ct?.addEventListener("click",async()=>{let e=!document.body.classList.contains("light-mode");await Et(!e)}),wa?.addEventListener("click",()=>{it.classList.toggle("open")}),va?.addEventListener("click",e=>{e.stopPropagation(),rn.classList.toggle("show")}),rt?.addEventListener("click",()=>Jn()),ma?.addEventListener("click",()=>qt()),on?.addEventListener("click",async()=>{let e=ye.value.trim();e&&await Xn(e)}),ye?.addEventListener("keydown",e=>{e.key==="Enter"&&(e.preventDefault(),on.click())}),Ea?.addEventListener("click",()=>Zn()),Ia?.addEventListener("click",()=>Ht()),cn?.addEventListener("click",async()=>{await Qn(we.value)}),we?.addEventListener("keydown",e=>{e.key==="Enter"&&(e.preventDefault(),cn.click())}),Gt?.addEventListener("click",async()=>{let e=ot.value.trim();e&&(await po(e,"user"),ot.value="")}),ot?.addEventListener("keydown",e=>{e.key==="Enter"&&(e.preventDefault(),Gt.click())}),fa?.addEventListener("click",async()=>{if(confirm("Are you sure you want to leave this server?"))try{await m("/users/exit","POST"),await Ze()}catch(e){console.error("Error exiting server:",e)}}),Ca?.addEventListener("click",()=>Hn()),ka?.addEventListener("click",()=>Rt()),La?.addEventListener("click",async()=>{let e=Ta?.value?.trim(),t=Ba?.value;if(e&&t){let{createWebhook:n}=await Promise.resolve().then(()=>(Ft(),Pt));await n(e,t)}})}$o();})();
